<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>dex执行机制 | Ms135's Blog</title><meta name="author" content="Ms135"><meta name="copyright" content="Ms135"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="最近在研究 DexVMP，了解到其内部虚拟机的设计思路，一定程度上借鉴了ART的解释器因此这里从 Android 9.0 源码入手，探讨dex在ART中的执行机制，以加深对 DexVMP的理解 因为整体调用链很长，且涉及多处递归调用，这里放一下整体流程图————（箭头表示调用关系） C++ Framework IArtMethod::Invoke根据当前方法是否有现成 AOT或JIT后的已编译代码">
<meta property="og:type" content="article">
<meta property="og:title" content="dex执行机制">
<meta property="og:url" content="https://matchstick135.github.io/2025/03/17/2025-3-17%20dex%E6%89%A7%E8%A1%8C%E6%9C%BA%E5%88%B6/index.html">
<meta property="og:site_name" content="Ms135&#39;s Blog">
<meta property="og:description" content="最近在研究 DexVMP，了解到其内部虚拟机的设计思路，一定程度上借鉴了ART的解释器因此这里从 Android 9.0 源码入手，探讨dex在ART中的执行机制，以加深对 DexVMP的理解 因为整体调用链很长，且涉及多处递归调用，这里放一下整体流程图————（箭头表示调用关系） C++ Framework IArtMethod::Invoke根据当前方法是否有现成 AOT或JIT后的已编译代码">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://matchstick135.github.io/img/2025-3-17.jpg">
<meta property="article:published_time" content="2025-03-16T16:00:00.000Z">
<meta property="article:modified_time" content="2025-03-24T06:32:06.016Z">
<meta property="article:author" content="Ms135">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://matchstick135.github.io/img/2025-3-17.jpg"><link rel="shortcut icon" href="/img/%E5%A4%B4%E5%83%8F.jpg"><link rel="canonical" href="https://matchstick135.github.io/2025/03/17/2025-3-17%20dex%E6%89%A7%E8%A1%8C%E6%9C%BA%E5%88%B6/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":5,"unescape":false,"languages":{"hits_empty":"未找到符合您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":false,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":true},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: false,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'dex执行机制',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  isShuoshuo: false
}</script><meta name="generator" content="Hexo 7.3.0"></head><body><div id="web_bg" style="background-image: url(/img/背景.jpg);"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/img/%E5%A4%B4%E5%83%8F.jpg" onerror="onerror=null;src='null'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">42</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">0</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">7</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(/img/2025-3-17.jpg);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">Ms135's Blog</span></a><a class="nav-page-title" href="/"><span class="site-name">dex执行机制</span></a></span><div id="menus"><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></span></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">dex执行机制</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="fa-fw post-meta-icon far fa-calendar-alt"></i><span class="post-meta-label">发表于</span><time datetime="2025-03-16T16:00:00.000Z" title="发表于 2025-03-17 00:00:00">2025-03-17</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E7%A1%AC%E6%A0%B8%E7%9F%A5%E8%AF%86/">硬核知识</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">总字数:</span><span class="word-count">3.9k</span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><p>最近在研究 DexVMP，了解到其内部虚拟机的设计思路，一定程度上借鉴了ART的解释器<br>因此这里从 Android 9.0 源码入手，探讨dex在ART中的执行机制，以加深对 DexVMP的理解</p>
<p>因为整体调用链很长，且涉及多处递归调用，这里放一下整体流程图————<br>（箭头表示调用关系）<br><img src="/img/2025-3-17/1.jpg"></p>
<h1 id="C-Framework-I"><a href="#C-Framework-I" class="headerlink" title="C++ Framework I"></a>C++ Framework I</h1><h2 id="ArtMethod-Invoke"><a href="#ArtMethod-Invoke" class="headerlink" title="ArtMethod::Invoke"></a>ArtMethod::Invoke</h2><p>根据当前方法是否有现成 AOT或JIT后的已编译代码，分别调用 art_quick_invoke_stub 或 EnterInterpreterFromInvoke<br>调用前者之前，会通过 GetEntryPointFromQuickCompiledCode 返回当前方法 已编译代码的入口点</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// http://androidxref.com/9.0.0_r3/xref/art/runtime/art_method.cc#318</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ArtMethod::Invoke</span><span class="params">(Thread* self, <span class="type">uint32_t</span>* args, <span class="type">uint32_t</span> args_size, JValue* result,</span></span></span><br><span class="line"><span class="params"><span class="function">                       <span class="type">const</span> <span class="type">char</span>* shorty)</span> </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">UNLIKELY</span>(!runtime-&gt;<span class="built_in">IsStarted</span>() || Dbg::<span class="built_in">IsForcedInterpreterNeededForCalling</span>(self, <span class="keyword">this</span>))) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">IsStatic</span>()) &#123;</span><br><span class="line">      art::interpreter::<span class="built_in">EnterInterpreterFromInvoke</span>(</span><br><span class="line">          self, <span class="keyword">this</span>, <span class="literal">nullptr</span>, args, result, <span class="comment">/*stay_in_interpreter*/</span> <span class="literal">true</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      mirror::Object* receiver =</span><br><span class="line">          <span class="keyword">reinterpret_cast</span>&lt;StackReference&lt;mirror::Object&gt;*&gt;(&amp;args[<span class="number">0</span>])-&gt;<span class="built_in">AsMirrorPtr</span>();</span><br><span class="line">      art::interpreter::<span class="built_in">EnterInterpreterFromInvoke</span>(</span><br><span class="line">          self, <span class="keyword">this</span>, receiver, args + <span class="number">1</span>, result, <span class="comment">/*stay_in_interpreter*/</span> <span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">DCHECK_EQ</span>(runtime-&gt;<span class="built_in">GetClassLinker</span>()-&gt;<span class="built_in">GetImagePointerSize</span>(), kRuntimePointerSize);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">constexpr</span> <span class="type">bool</span> kLogInvocationStartAndReturn = <span class="literal">false</span>;</span><br><span class="line">    <span class="type">bool</span> have_quick_code = <span class="built_in">GetEntryPointFromQuickCompiledCode</span>() != <span class="literal">nullptr</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">LIKELY</span>(have_quick_code)) &#123;</span><br><span class="line">      <span class="keyword">if</span> (kLogInvocationStartAndReturn) &#123;</span><br><span class="line">        <span class="built_in">LOG</span>(INFO) &lt;&lt; <span class="built_in">StringPrintf</span>(</span><br><span class="line">            <span class="string">&quot;Invoking &#x27;%s&#x27; quick code=%p static=%d&quot;</span>, <span class="built_in">PrettyMethod</span>().<span class="built_in">c_str</span>(),</span><br><span class="line">            <span class="built_in">GetEntryPointFromQuickCompiledCode</span>(), <span class="built_in">static_cast</span>&lt;<span class="type">int</span>&gt;(<span class="built_in">IsStatic</span>() ? <span class="number">1</span> : <span class="number">0</span>));</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      ...</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (!<span class="built_in">IsStatic</span>()) &#123;</span><br><span class="line">        (*art_quick_invoke_stub)(<span class="keyword">this</span>, args, args_size, self, result, shorty);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        (*art_quick_invoke_static_stub)(<span class="keyword">this</span>, args, args_size, self, result, shorty);</span><br><span class="line">      &#125;</span><br><span class="line">      ...</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      ...</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="art-quick-invoke-stub"><a href="#art-quick-invoke-stub" class="headerlink" title="art_quick_invoke_stub"></a>art_quick_invoke_stub</h3><p>快速执行入口点，基于汇编实现</p>
<p>根据方法的签名将参数加入对应arm64寄存器，然后调用目标方法</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// http://androidxref.com/9.0.0_r3/xref/art/runtime/arch/arm64/quick_entrypoints_arm64.S#805</span></span><br><span class="line"></span><br><span class="line">ENTRY art_quick_invoke_stub</span><br><span class="line">    <span class="comment">// Spill registers as per AACPS64 calling convention.</span></span><br><span class="line">    INVOKE_STUB_CREATE_FRAME</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Fill registers x/w1 to x/w7 and s/d0 to s/d7 with parameters.</span></span><br><span class="line">    <span class="comment">// Parse the passed shorty to determine which register to load.</span></span><br><span class="line">    <span class="comment">// Load addresses for routines that load WXSD registers.</span></span><br><span class="line">    adr  x11, .LstoreW2</span><br><span class="line">    adr  x12, .LstoreX2</span><br><span class="line">    adr  x13, .LstoreS0</span><br><span class="line">    adr  x14, .LstoreD0</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Initialize routine offsets to 0 for integers and floats.</span></span><br><span class="line">    <span class="comment">// x8 for integers, x15 for floating point.</span></span><br><span class="line">    mov x8, #<span class="number">0</span></span><br><span class="line">    mov x15, #<span class="number">0</span></span><br><span class="line"></span><br><span class="line">    add x10, x5, #<span class="number">1</span>         <span class="comment">// Load shorty address, plus one to skip return value.</span></span><br><span class="line">    ldr w1, [x9],#<span class="number">4</span>         <span class="comment">// Load &quot;this&quot; parameter, and increment arg pointer.</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Loop to fill registers.</span></span><br><span class="line">.LfillRegisters:</span><br><span class="line">    ldrb w17, [x10], #<span class="number">1</span>       <span class="comment">// Load next character in signature, and increment.</span></span><br><span class="line">    cbz w17, .LcallFunction   <span class="comment">// Exit at end of signature. Shorty 0 terminated.</span></span><br><span class="line"></span><br><span class="line">    cmp  w17, #<span class="string">&#x27;F&#x27;</span> <span class="comment">// is this a float?</span></span><br><span class="line">    bne .LisDouble</span><br><span class="line"></span><br><span class="line">    cmp x15, # <span class="number">8</span>*<span class="number">12</span>         <span class="comment">// Skip this load if all registers full.</span></span><br><span class="line">    beq .Ladvance4</span><br><span class="line"></span><br><span class="line">    add x17, x13, x15       <span class="comment">// Calculate subroutine to jump to.</span></span><br><span class="line">    br  x17</span><br><span class="line"></span><br><span class="line">.LisDouble:</span><br><span class="line">    cmp w17, #<span class="string">&#x27;D&#x27;</span>           <span class="comment">// is this a double?</span></span><br><span class="line">    bne .LisLong</span><br><span class="line"></span><br><span class="line">    cmp x15, # <span class="number">8</span>*<span class="number">12</span>         <span class="comment">// Skip this load if all registers full.</span></span><br><span class="line">    beq .Ladvance8</span><br><span class="line"></span><br><span class="line">    add x17, x14, x15       <span class="comment">// Calculate subroutine to jump to.</span></span><br><span class="line">    br x17</span><br><span class="line"></span><br><span class="line">.LisLong:</span><br><span class="line">    cmp w17, #<span class="string">&#x27;J&#x27;</span>           <span class="comment">// is this a long?</span></span><br><span class="line">    bne .LisOther</span><br><span class="line"></span><br><span class="line">    cmp x8, # <span class="number">6</span>*<span class="number">12</span>          <span class="comment">// Skip this load if all registers full.</span></span><br><span class="line">    beq .Ladvance8</span><br><span class="line"></span><br><span class="line">    add x17, x12, x8        <span class="comment">// Calculate subroutine to jump to.</span></span><br><span class="line">    br x17</span><br><span class="line"></span><br><span class="line">.LisOther:                  <span class="comment">// Everything else takes one vReg.</span></span><br><span class="line">    cmp x8, # <span class="number">6</span>*<span class="number">12</span>          <span class="comment">// Skip this load if all registers full.</span></span><br><span class="line">    beq .Ladvance4</span><br><span class="line"></span><br><span class="line">    add x17, x11, x8        <span class="comment">// Calculate subroutine to jump to.</span></span><br><span class="line">    br x17</span><br><span class="line"></span><br><span class="line">.Ladvance4:</span><br><span class="line">    add x9, x9, #<span class="number">4</span></span><br><span class="line">    b .LfillRegisters</span><br><span class="line"></span><br><span class="line">.Ladvance8:</span><br><span class="line">    add x9, x9, #<span class="number">8</span></span><br><span class="line">    b .LfillRegisters</span><br><span class="line"></span><br><span class="line"><span class="comment">// Macro for loading a parameter into a register.</span></span><br><span class="line"><span class="comment">//  counter - the register with offset into these tables</span></span><br><span class="line"><span class="comment">//  size - the size of the register - 4 or 8 bytes.</span></span><br><span class="line"><span class="comment">//  register - the name of the register to be loaded.</span></span><br><span class="line">.macro LOADREG counter size <span class="keyword">register</span> <span class="keyword">return</span></span><br><span class="line">    ldr \<span class="keyword">register</span> , [x9], #\size</span><br><span class="line">    add \counter, \counter, <span class="number">12</span></span><br><span class="line">    b \<span class="keyword">return</span></span><br><span class="line">.endm</span><br><span class="line"></span><br><span class="line"><span class="comment">// Store ints.</span></span><br><span class="line">.LstoreW2:</span><br><span class="line">    LOADREG x8 <span class="number">4</span> w2 .LfillRegisters</span><br><span class="line">    LOADREG x8 <span class="number">4</span> w3 .LfillRegisters</span><br><span class="line">    LOADREG x8 <span class="number">4</span> w4 .LfillRegisters</span><br><span class="line">    LOADREG x8 <span class="number">4</span> w5 .LfillRegisters</span><br><span class="line">    LOADREG x8 <span class="number">4</span> w6 .LfillRegisters</span><br><span class="line">    LOADREG x8 <span class="number">4</span> w7 .LfillRegisters</span><br><span class="line"></span><br><span class="line"><span class="comment">// Store longs.</span></span><br><span class="line">.LstoreX2:</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line"><span class="comment">// Store singles.</span></span><br><span class="line">.LstoreS0:</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line"><span class="comment">// Store doubles.</span></span><br><span class="line">.LstoreD0:</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">.LcallFunction:</span><br><span class="line"></span><br><span class="line">    INVOKE_STUB_CALL_AND_RETURN</span><br><span class="line"></span><br><span class="line">END art_quick_invoke_stub</span><br></pre></td></tr></table></figure>

<h3 id="EnterInterpreterFromInvoke"><a href="#EnterInterpreterFromInvoke" class="headerlink" title="EnterInterpreterFromInvoke"></a>EnterInterpreterFromInvoke</h3><p>解释执行入口点</p>
<p>先获取方法的字节码和寄存器信息；<br>再初始化该方法的 Shadow Frame，其中包含该方法信息和 后续解释过程用于存储参数、局部变量的虚拟寄存器；<br>最后根据要调用的方法是 java 或 native，分别调用 Execute 或 InterpreterJni</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// http://androidxref.com/9.0.0_r3/xref/art/runtime/interpreter/interpreter.cc#370</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">EnterInterpreterFromInvoke</span><span class="params">(Thread* self,</span></span></span><br><span class="line"><span class="params"><span class="function">                                ArtMethod* method,</span></span></span><br><span class="line"><span class="params"><span class="function">                                ObjPtr&lt;mirror::Object&gt; receiver,</span></span></span><br><span class="line"><span class="params"><span class="function">                                <span class="type">uint32_t</span>* args,</span></span></span><br><span class="line"><span class="params"><span class="function">                                JValue* result,</span></span></span><br><span class="line"><span class="params"><span class="function">                                <span class="type">bool</span> stay_in_interpreter)</span> </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="function">CodeItemDataAccessor <span class="title">accessor</span><span class="params">(method-&gt;DexInstructionData())</span></span>;</span><br><span class="line">  <span class="type">uint16_t</span> num_regs;</span><br><span class="line">  <span class="type">uint16_t</span> num_ins;</span><br><span class="line">  <span class="keyword">if</span> (accessor.<span class="built_in">HasCodeItem</span>()) &#123;</span><br><span class="line">    num_regs =  accessor.<span class="built_in">RegistersSize</span>();</span><br><span class="line">    num_ins = accessor.<span class="built_in">InsSize</span>();</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!method-&gt;<span class="built_in">IsInvokable</span>()) &#123;</span><br><span class="line">    self-&gt;<span class="built_in">EndAssertNoThreadSuspension</span>(old_cause);</span><br><span class="line">    method-&gt;<span class="built_in">ThrowInvocationTimeError</span>();</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">DCHECK</span>(method-&gt;<span class="built_in">IsNative</span>());</span><br><span class="line">    num_regs = num_ins = ArtMethod::<span class="built_in">NumArgRegisters</span>(method-&gt;<span class="built_in">GetShorty</span>());</span><br><span class="line">    <span class="keyword">if</span> (!method-&gt;<span class="built_in">IsStatic</span>()) &#123;</span><br><span class="line">      num_regs++;</span><br><span class="line">      num_ins++;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// Set up shadow frame with matching number of reference slots to vregs.</span></span><br><span class="line">  ShadowFrame* last_shadow_frame = self-&gt;<span class="built_in">GetManagedStack</span>()-&gt;<span class="built_in">GetTopShadowFrame</span>();</span><br><span class="line">  ShadowFrameAllocaUniquePtr shadow_frame_unique_ptr =</span><br><span class="line">      <span class="built_in">CREATE_SHADOW_FRAME</span>(num_regs, last_shadow_frame, method, <span class="comment">/* dex pc */</span> <span class="number">0</span>);</span><br><span class="line">  ShadowFrame* shadow_frame = shadow_frame_unique_ptr.<span class="built_in">get</span>();</span><br><span class="line">  self-&gt;<span class="built_in">PushShadowFrame</span>(shadow_frame);</span><br><span class="line"></span><br><span class="line">  <span class="type">size_t</span> cur_reg = num_regs - num_ins;</span><br><span class="line">  <span class="keyword">if</span> (!method-&gt;<span class="built_in">IsStatic</span>()) &#123;</span><br><span class="line">    <span class="built_in">CHECK</span>(receiver != <span class="literal">nullptr</span>);</span><br><span class="line">    shadow_frame-&gt;<span class="built_in">SetVRegReference</span>(cur_reg, receiver.<span class="built_in">Ptr</span>());</span><br><span class="line">    ++cur_reg;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="type">uint32_t</span> shorty_len = <span class="number">0</span>;</span><br><span class="line">  <span class="type">const</span> <span class="type">char</span>* shorty = method-&gt;<span class="built_in">GetShorty</span>(&amp;shorty_len);</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">size_t</span> shorty_pos = <span class="number">0</span>, arg_pos = <span class="number">0</span>; cur_reg &lt; num_regs; ++shorty_pos, ++arg_pos, cur_reg++) &#123;</span><br><span class="line">    <span class="built_in">DCHECK_LT</span>(shorty_pos + <span class="number">1</span>, shorty_len);</span><br><span class="line">    <span class="keyword">switch</span> (shorty[shorty_pos + <span class="number">1</span>]) &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;L&#x27;</span>: &#123;</span><br><span class="line">        ObjPtr&lt;mirror::Object&gt; o =</span><br><span class="line">            <span class="keyword">reinterpret_cast</span>&lt;StackReference&lt;mirror::Object&gt;*&gt;(&amp;args[arg_pos])-&gt;<span class="built_in">AsMirrorPtr</span>();</span><br><span class="line">        shadow_frame-&gt;<span class="built_in">SetVRegReference</span>(cur_reg, o.<span class="built_in">Ptr</span>());</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;J&#x27;</span>: <span class="keyword">case</span> <span class="string">&#x27;D&#x27;</span>: &#123;</span><br><span class="line">        <span class="type">uint64_t</span> wide_value = (<span class="built_in">static_cast</span>&lt;<span class="type">uint64_t</span>&gt;(args[arg_pos + <span class="number">1</span>]) &lt;&lt; <span class="number">32</span>) | args[arg_pos];</span><br><span class="line">        shadow_frame-&gt;<span class="built_in">SetVRegLong</span>(cur_reg, wide_value);</span><br><span class="line">        cur_reg++;</span><br><span class="line">        arg_pos++;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">        shadow_frame-&gt;<span class="built_in">SetVReg</span>(cur_reg, args[arg_pos]);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">LIKELY</span>(!method-&gt;<span class="built_in">IsNative</span>())) &#123;</span><br><span class="line">    JValue r = <span class="built_in">Execute</span>(self, accessor, *shadow_frame, <span class="built_in">JValue</span>(), stay_in_interpreter);</span><br><span class="line">    <span class="keyword">if</span> (result != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">      *result = r;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    args = shadow_frame-&gt;<span class="built_in">GetVRegArgs</span>(method-&gt;<span class="built_in">IsStatic</span>() ? <span class="number">0</span> : <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span> (!Runtime::<span class="built_in">Current</span>()-&gt;<span class="built_in">IsStarted</span>()) &#123;</span><br><span class="line">      UnstartedRuntime::<span class="built_in">Jni</span>(self, method, receiver.<span class="built_in">Ptr</span>(), args, result);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="built_in">InterpreterJni</span>(self, method, shorty, receiver, args, result);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  self-&gt;<span class="built_in">PopShadowFrame</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Execute"><a href="#Execute" class="headerlink" title="Execute"></a>Execute</h4><p>在后续 ArtInterpreterToInterpreterBridge 中被递归调用</p>
<p>根据是否有现成的 已编译代码，分别调用 ArtInterpreterToCompiledCodeBridge 或  ExecuteMterpImpl, ExecuteSwitchImpl<br>其中优先使用 ExecuteMterpImpl，如果遇到无法处理的情况，则回退到 ExecuteSwitchImpl</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// http://androidxref.com/9.0.0_r3/xref/art/runtime/interpreter/interpreter.cc#241</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="keyword">inline</span> JValue <span class="title">Execute</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    Thread* self,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> CodeItemDataAccessor&amp; accessor,</span></span></span><br><span class="line"><span class="params"><span class="function">    ShadowFrame&amp; shadow_frame,</span></span></span><br><span class="line"><span class="params"><span class="function">    JValue result_register,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">bool</span> stay_in_interpreter = <span class="literal">false</span>)</span> <span class="title">REQUIRES_SHARED</span><span class="params">(Locks::mutator_lock_)</span> </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">LIKELY</span>(shadow_frame.<span class="built_in">GetDexPC</span>() == <span class="number">0</span>)) &#123;  <span class="comment">// Entering the method, but not via deoptimization.</span></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!stay_in_interpreter) &#123;</span><br><span class="line">      jit::Jit* jit = Runtime::<span class="built_in">Current</span>()-&gt;<span class="built_in">GetJit</span>();</span><br><span class="line">      <span class="keyword">if</span> (jit != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">        jit-&gt;<span class="built_in">MethodEntered</span>(self, shadow_frame.<span class="built_in">GetMethod</span>());</span><br><span class="line">        <span class="keyword">if</span> (jit-&gt;<span class="built_in">CanInvokeCompiledCode</span>(method)) &#123;</span><br><span class="line">          JValue result;</span><br><span class="line"></span><br><span class="line">          self-&gt;<span class="built_in">PopShadowFrame</span>();</span><br><span class="line">          <span class="type">uint16_t</span> arg_offset = accessor.<span class="built_in">RegistersSize</span>() - accessor.<span class="built_in">InsSize</span>();</span><br><span class="line">          <span class="built_in">ArtInterpreterToCompiledCodeBridge</span>(self, <span class="literal">nullptr</span>, &amp;shadow_frame, arg_offset, &amp;result);</span><br><span class="line">          <span class="comment">// Push the shadow frame back as the caller will expect it.</span></span><br><span class="line">          self-&gt;<span class="built_in">PushShadowFrame</span>(&amp;shadow_frame);</span><br><span class="line"></span><br><span class="line">          <span class="keyword">return</span> result;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">LIKELY</span>(method-&gt;<span class="built_in">SkipAccessChecks</span>())) &#123;</span><br><span class="line">    <span class="comment">// Enter the &quot;without access check&quot; interpreter.</span></span><br><span class="line">    <span class="keyword">if</span> (kInterpreterImplKind == kMterpImplKind) &#123;</span><br><span class="line">      <span class="keyword">if</span> (transaction_active) &#123;</span><br><span class="line">        ...</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">          <span class="comment">// Mterp does not support all instrumentation/debugging.</span></span><br><span class="line">          <span class="keyword">if</span> (<span class="built_in">MterpShouldSwitchInterpreters</span>() != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">ExecuteSwitchImpl</span>&lt;<span class="literal">false</span>, <span class="literal">false</span>&gt;(self, accessor, shadow_frame, result_register,</span><br><span class="line">                                                   <span class="literal">false</span>);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="type">bool</span> returned = <span class="built_in">ExecuteMterpImpl</span>(self,</span><br><span class="line">                                           accessor.<span class="built_in">Insns</span>(),</span><br><span class="line">                                           &amp;shadow_frame,</span><br><span class="line">                                           &amp;result_register);</span><br><span class="line">          <span class="keyword">if</span> (returned) &#123;</span><br><span class="line">            <span class="keyword">return</span> result_register;</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// Mterp didn&#x27;t like that instruction.  Single-step it with the reference interpreter.</span></span><br><span class="line">            result_register = <span class="built_in">ExecuteSwitchImpl</span>&lt;<span class="literal">false</span>, <span class="literal">false</span>&gt;(self, accessor, shadow_frame,</span><br><span class="line">                                                              result_register, <span class="literal">true</span>);</span><br><span class="line">            <span class="keyword">if</span> (shadow_frame.<span class="built_in">GetDexPC</span>() == dex::kDexNoIndex) &#123;</span><br><span class="line">              <span class="comment">// Single-stepped a return or an exception not handled locally.  Return to caller.</span></span><br><span class="line">              <span class="keyword">return</span> result_register;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      ...</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="InterpreterJni"><a href="#InterpreterJni" class="headerlink" title="InterpreterJni"></a>InterpreterJni</h4><p>根据方法的签名和类型，调用其对应的native实现</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// http://androidxref.com/9.0.0_r3/xref/art/runtime/interpreter/interpreter.cc#46</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">InterpreterJni</span><span class="params">(Thread* self,</span></span></span><br><span class="line"><span class="params"><span class="function">                           ArtMethod* method,</span></span></span><br><span class="line"><span class="params"><span class="function">                           <span class="type">const</span> StringPiece&amp; shorty,</span></span></span><br><span class="line"><span class="params"><span class="function">                           ObjPtr&lt;mirror::Object&gt; receiver,</span></span></span><br><span class="line"><span class="params"><span class="function">                           <span class="type">uint32_t</span>* args,</span></span></span><br><span class="line"><span class="params"><span class="function">                           JValue* result)</span></span></span><br><span class="line"><span class="function">    <span class="title">REQUIRES_SHARED</span><span class="params">(Locks::mutator_lock_)</span> </span>&#123;</span><br><span class="line">  <span class="function">ScopedObjectAccessUnchecked <span class="title">soa</span><span class="params">(self)</span></span>;</span><br><span class="line">  <span class="keyword">if</span> (method-&gt;<span class="built_in">IsStatic</span>()) &#123;</span><br><span class="line">    <span class="keyword">if</span> (shorty == <span class="string">&quot;L&quot;</span>) &#123;</span><br><span class="line">      <span class="function"><span class="keyword">typedef</span> <span class="title">jobject</span> <span class="params">(fntype)</span><span class="params">(JNIEnv*, jclass)</span></span>;</span><br><span class="line">      fntype* <span class="type">const</span> fn = <span class="built_in">reinterpret_cast</span>&lt;fntype*&gt;(method-&gt;<span class="built_in">GetEntryPointFromJni</span>());</span><br><span class="line">      <span class="function">ScopedLocalRef&lt;jclass&gt; <span class="title">klass</span><span class="params">(soa.Env(),</span></span></span><br><span class="line"><span class="params"><span class="function">                                   soa.AddLocalReference&lt;jclass&gt;(method-&gt;GetDeclaringClass()))</span></span>;</span><br><span class="line">      jobject jresult;</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="function">ScopedThreadStateChange <span class="title">tsc</span><span class="params">(self, kNative)</span></span>;</span><br><span class="line">        jresult = <span class="built_in">fn</span>(soa.<span class="built_in">Env</span>(), klass.<span class="built_in">get</span>());</span><br><span class="line">      &#125;</span><br><span class="line">      result-&gt;<span class="built_in">SetL</span>(soa.<span class="built_in">Decode</span>&lt;mirror::Object&gt;(jresult));</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (shorty == <span class="string">&quot;V&quot;</span>) &#123;</span><br><span class="line">      ...</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      ...</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h1 id="C-Framework-II"><a href="#C-Framework-II" class="headerlink" title="C++ Framework II"></a>C++ Framework II</h1><p>承接上方 Execute</p>
<h2 id="ArtInterpreterToCompiledCodeBridge"><a href="#ArtInterpreterToCompiledCodeBridge" class="headerlink" title="ArtInterpreterToCompiledCodeBridge"></a>ArtInterpreterToCompiledCodeBridge</h2><p>在后续 PerformCall 中被递归调用<br>其中递归调用 ArtMethod::Invoke</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// http://androidxref.com/9.0.0_r3/xref/art/runtime/interpreter/interpreter_common.cc#522</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ArtInterpreterToCompiledCodeBridge</span><span class="params">(Thread* self,</span></span></span><br><span class="line"><span class="params"><span class="function">                                        ArtMethod* caller,</span></span></span><br><span class="line"><span class="params"><span class="function">                                        ShadowFrame* shadow_frame,</span></span></span><br><span class="line"><span class="params"><span class="function">                                        <span class="type">uint16_t</span> arg_offset,</span></span></span><br><span class="line"><span class="params"><span class="function">                                        JValue* result)</span></span></span><br><span class="line"><span class="function">    <span class="title">REQUIRES_SHARED</span><span class="params">(Locks::mutator_lock_)</span> </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  method-&gt;<span class="built_in">Invoke</span>(self, shadow_frame-&gt;<span class="built_in">GetVRegArgs</span>(arg_offset),</span><br><span class="line">                 (shadow_frame-&gt;<span class="built_in">NumberOfVRegs</span>() - arg_offset) * <span class="built_in">sizeof</span>(<span class="type">uint32_t</span>),</span><br><span class="line">                 result, method-&gt;<span class="built_in">GetInterfaceMethodIfProxy</span>(kRuntimePointerSize)-&gt;<span class="built_in">GetShorty</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="ExecuteMterpImpl"><a href="#ExecuteMterpImpl" class="headerlink" title="ExecuteMterpImpl"></a>ExecuteMterpImpl</h2><p>Mterp 解释器，与下方 Goto 解释器相似，但基于汇编实现<br>每个操作码的handler为一个独立模块，其结尾间接跳转至后续模块</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// http://androidxref.com/9.0.0_r3/xref/art/runtime/interpreter/mterp/arm64/entry.S#28</span></span><br><span class="line"></span><br><span class="line">ENTRY ExecuteMterpImpl</span><br><span class="line">    SAVE_TWO_REGS_INCREASE_FRAME xPROFILE, x27, <span class="number">80</span></span><br><span class="line">    SAVE_TWO_REGS                xIBASE, xREFS, <span class="number">16</span></span><br><span class="line">    SAVE_TWO_REGS                xSELF, xINST, <span class="number">32</span></span><br><span class="line">    SAVE_TWO_REGS                xPC, xFP, <span class="number">48</span></span><br><span class="line">    SAVE_TWO_REGS                fp, lr, <span class="number">64</span></span><br><span class="line">    add     fp, sp, #<span class="number">64</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Remember the return register */</span></span><br><span class="line">    str     x3, [x2, #SHADOWFRAME_RESULT_REGISTER_OFFSET]</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Remember the dex instruction pointer */</span></span><br><span class="line">    str     x1, [x2, #SHADOWFRAME_DEX_INSTRUCTIONS_OFFSET]</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* set up &quot;named&quot; registers */</span></span><br><span class="line">    mov     xSELF, x0</span><br><span class="line">    ldr     w0, [x2, #SHADOWFRAME_NUMBER_OF_VREGS_OFFSET]</span><br><span class="line">    add     xFP, x2, #SHADOWFRAME_VREGS_OFFSET     <span class="comment">// point to vregs.</span></span><br><span class="line">    add     xREFS, xFP, w0, lsl #<span class="number">2</span>                 <span class="comment">// point to reference array in shadow frame</span></span><br><span class="line">    ldr     w0, [x2, #SHADOWFRAME_DEX_PC_OFFSET]   <span class="comment">// Get starting dex_pc.</span></span><br><span class="line">    add     xPC, x1, w0, lsl #<span class="number">1</span>                    <span class="comment">// Create direct pointer to 1st dex opcode</span></span><br><span class="line">    CFI_DEFINE_DEX_PC_WITH_OFFSET(CFI_TMP, CFI_DEX, <span class="number">0</span>)</span><br><span class="line">    EXPORT_PC</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Starting ibase */</span></span><br><span class="line">    ldr     xIBASE, [xSELF, #THREAD_CURRENT_IBASE_OFFSET]</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Set up for backwards branches &amp; osr profiling */</span></span><br><span class="line">    ldr     x0, [xFP, #OFF_FP_METHOD]</span><br><span class="line">    add     x1, xFP, #OFF_FP_SHADOWFRAME</span><br><span class="line">    mov     x2, xSELF</span><br><span class="line">    bl      MterpSetUpHotnessCountdown</span><br><span class="line">    mov     wPROFILE, w0                <span class="comment">// Starting hotness countdown to xPROFILE</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* start executing the instruction at rPC */</span></span><br><span class="line">    FETCH_INST                          <span class="comment">// load wINST from rPC</span></span><br><span class="line">    GET_INST_OPCODE ip                  <span class="comment">// extract opcode from wINST</span></span><br><span class="line">    GOTO_OPCODE ip                      <span class="comment">// jump to next instruction</span></span><br><span class="line">    <span class="comment">/* <span class="doctag">NOTE:</span> no fallthrough */</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// http://androidxref.com/9.0.0_r3/xref/art/runtime/interpreter/mterp/arm64/op_sget.S</span></span><br><span class="line"></span><br><span class="line">%<span class="keyword">default</span> &#123; <span class="string">&quot;is_object&quot;</span>:<span class="string">&quot;0&quot;</span>, <span class="string">&quot;helper&quot;</span>:<span class="string">&quot;MterpGet32Static&quot;</span>, <span class="string">&quot;extend&quot;</span>:<span class="string">&quot;&quot;</span> &#125;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * General SGET handler wrapper.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * for: sget, sget-object, sget-boolean, sget-byte, sget-char, sget-short</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">/* op vAA, field//BBBB */</span></span><br><span class="line"></span><br><span class="line">    .<span class="keyword">extern</span> $helper</span><br><span class="line">    EXPORT_PC</span><br><span class="line">    FETCH w0, <span class="number">1</span>                         <span class="comment">// w0&lt;- field ref BBBB</span></span><br><span class="line">    ldr   x1, [xFP, #OFF_FP_METHOD]</span><br><span class="line">    mov   x2, xSELF</span><br><span class="line">    bl    $helper</span><br><span class="line">    ldr   x3, [xSELF, #THREAD_EXCEPTION_OFFSET]</span><br><span class="line">    lsr   w2, wINST, #<span class="number">8</span>                 <span class="comment">// w2&lt;- AA</span></span><br><span class="line">    $extend</span><br><span class="line">    PREFETCH_INST <span class="number">2</span></span><br><span class="line">    cbnz  x3, MterpException            <span class="comment">// bail out</span></span><br><span class="line">.<span class="keyword">if</span> $is_object</span><br><span class="line">    SET_VREG_OBJECT w0, w2              <span class="comment">// fp[AA]&lt;- w0</span></span><br><span class="line">.<span class="keyword">else</span></span><br><span class="line">    SET_VREG w0, w2                     <span class="comment">// fp[AA]&lt;- w0</span></span><br><span class="line">.endif</span><br><span class="line">    ADVANCE <span class="number">2</span></span><br><span class="line">    GET_INST_OPCODE ip                  <span class="comment">// extract opcode from rINST</span></span><br><span class="line">    GOTO_OPCODE ip</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// http://androidxref.com/9.0.0_r3/xref/art/runtime/interpreter/mterp/arm64/invoke.S</span></span><br><span class="line"></span><br><span class="line">%<span class="keyword">default</span> &#123; <span class="string">&quot;helper&quot;</span>:<span class="string">&quot;UndefinedInvokeHandler&quot;</span> &#125;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Generic invoke handler wrapper.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">/* op vB, &#123;vD, vE, vF, vG, vA&#125;, class@CCCC */</span></span><br><span class="line">    <span class="comment">/* op &#123;vCCCC..v(CCCC+AA-1)&#125;, meth@BBBB */</span></span><br><span class="line">    .<span class="keyword">extern</span> $helper</span><br><span class="line">    EXPORT_PC</span><br><span class="line">    mov     x0, xSELF</span><br><span class="line">    add     x1, xFP, #OFF_FP_SHADOWFRAME</span><br><span class="line">    mov     x2, xPC</span><br><span class="line">    mov     x3, xINST</span><br><span class="line">    bl      $helper</span><br><span class="line">    cbz     w0, MterpException</span><br><span class="line">    FETCH_ADVANCE_INST <span class="number">3</span></span><br><span class="line">    bl      MterpShouldSwitchInterpreters</span><br><span class="line">    cbnz    w0, MterpFallback</span><br><span class="line">    GET_INST_OPCODE ip</span><br><span class="line">    GOTO_OPCODE ip</span><br></pre></td></tr></table></figure>

<h2 id="ExecuteGotoImpl"><a href="#ExecuteGotoImpl" class="headerlink" title="ExecuteGotoImpl"></a><del>ExecuteGotoImpl</del></h2><p>Goto 解释器 (来自 Android 7.1，后续已废弃，但在此列出)<br>每个操作码的handler位于一个 通过宏定义的 标签下；<br>handler结尾更新PC 使其指向下一个操作码，而后读取；<br>再将操作码传入跳转表 映射得到其handler所属标签（本质上是地址），而后goto跳转至handler处</p>
<p>遇到 SGET 等涉及 字段访问的操作码，则调用 DoFieldGet 等；<br>遇到 INVOKE_VIRTUAL 等涉及 方法调用的操作码，则调用 DoInvoke</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// http://androidxref.com/7.1.2_r36/xref/art/runtime/interpreter/interpreter_goto_table_impl.cc#41</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ADVANCE(_offset)                                                    \</span></span><br><span class="line"><span class="meta">  do &#123;                                                                      \</span></span><br><span class="line"><span class="meta">    int32_t disp = static_cast<span class="string">&lt;int32_t&gt;</span>(_offset);                           \</span></span><br><span class="line"><span class="meta">    inst = inst-&gt;RelativeAt(disp);                                          \</span></span><br><span class="line"><span class="meta">    dex_pc = static_cast<span class="string">&lt;uint32_t&gt;</span>(static_cast<span class="string">&lt;int32_t&gt;</span>(dex_pc) + disp);    \</span></span><br><span class="line"><span class="meta">    shadow_frame.SetDexPC(dex_pc);                                          \</span></span><br><span class="line"><span class="meta">    TraceExecution(shadow_frame, inst, dex_pc);                             \</span></span><br><span class="line"><span class="meta">    inst_data = inst-&gt;Fetch16(0);                                           \</span></span><br><span class="line"><span class="meta">    goto *currentHandlersTable[inst-&gt;Opcode(inst_data)];                    \</span></span><br><span class="line"><span class="meta">  &#125; while (false)</span></span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> POSSIBLY_HANDLE_PENDING_EXCEPTION(_is_exception_pending, _offset)   \</span></span><br><span class="line"><span class="meta">  do &#123;                                                                      \</span></span><br><span class="line"><span class="meta">    <span class="keyword">if</span> (UNLIKELY(_is_exception_pending)) &#123;                                  \</span></span><br><span class="line"><span class="meta">      HANDLE_PENDING_EXCEPTION();                                           \</span></span><br><span class="line"><span class="meta">    &#125; <span class="keyword">else</span> &#123;                                                                \</span></span><br><span class="line"><span class="meta">      ADVANCE(_offset);                                                     \</span></span><br><span class="line"><span class="meta">    &#125;                                                                       \</span></span><br><span class="line"><span class="meta">  &#125; while (false)</span></span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> UNREACHABLE_CODE_CHECK()                \</span></span><br><span class="line"><span class="meta">  do &#123;                                          \</span></span><br><span class="line"><span class="meta">    <span class="keyword">if</span> (kIsDebugBuild) &#123;                        \</span></span><br><span class="line"><span class="meta">      LOG(FATAL) &lt;&lt; <span class="string">&quot;We should not be here !&quot;</span>;  \</span></span><br><span class="line"><span class="meta">      UNREACHABLE();                            \</span></span><br><span class="line"><span class="meta">    &#125;                                           \</span></span><br><span class="line"><span class="meta">  &#125; while (false)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> HANDLE_INSTRUCTION_START(opcode) op_##opcode:  <span class="comment">// NOLINT(whitespace/labels)</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> HANDLE_INSTRUCTION_END() UNREACHABLE_CODE_CHECK()</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// http://androidxref.com/7.1.2_r36/xref/art/runtime/interpreter/interpreter_goto_table_impl.cc#157</span></span><br><span class="line"></span><br><span class="line"><span class="function">JValue <span class="title">ExecuteGotoImpl</span><span class="params">(Thread* self, <span class="type">const</span> DexFile::CodeItem* code_item, ShadowFrame&amp; shadow_frame,</span></span></span><br><span class="line"><span class="params"><span class="function">                       JValue result_register)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// Define handler tables:</span></span><br><span class="line">  <span class="type">static</span> <span class="type">const</span> <span class="type">void</span>* <span class="type">const</span> handlersTable[instrumentation::kNumHandlerTables][kNumPackedOpcodes] = &#123;</span><br><span class="line">    &#123;</span><br><span class="line">    <span class="comment">// Main handler table.</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> INSTRUCTION_HANDLER(o, code, n, f, r, i, a, v) &amp;&amp;op_##code,</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;dex_instruction_list.h&quot;</span></span></span><br><span class="line">      <span class="built_in">DEX_INSTRUCTION_LIST</span>(INSTRUCTION_HANDLER)</span><br><span class="line"><span class="meta">#<span class="keyword">undef</span> DEX_INSTRUCTION_LIST</span></span><br><span class="line"><span class="meta">#<span class="keyword">undef</span> INSTRUCTION_HANDLER</span></span><br><span class="line">    &#125;, &#123;</span><br><span class="line">    ...</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  <span class="type">uint32_t</span> dex_pc = shadow_frame.<span class="built_in">GetDexPC</span>();</span><br><span class="line">  <span class="type">const</span> Instruction* inst = Instruction::<span class="built_in">At</span>(code_item-&gt;insns_ + dex_pc);</span><br><span class="line">  <span class="type">uint16_t</span> inst_data;</span><br><span class="line">  <span class="type">const</span> <span class="type">void</span>* <span class="type">const</span>* currentHandlersTable;</span><br><span class="line">  <span class="built_in">UPDATE_HANDLER_TABLE</span>();</span><br><span class="line">  std::unique_ptr&lt;lambda::ClosureBuilder&gt; lambda_closure_builder;</span><br><span class="line">  <span class="type">size_t</span> lambda_captured_variable_index = <span class="number">0</span>;</span><br><span class="line">  <span class="type">const</span> <span class="keyword">auto</span>* <span class="type">const</span> instrumentation = Runtime::<span class="built_in">Current</span>()-&gt;<span class="built_in">GetInstrumentation</span>();</span><br><span class="line">  ArtMethod* method = shadow_frame.<span class="built_in">GetMethod</span>();</span><br><span class="line">  jit::Jit* jit = Runtime::<span class="built_in">Current</span>()-&gt;<span class="built_in">GetJit</span>();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Jump to first instruction.</span></span><br><span class="line">  <span class="built_in">ADVANCE</span>(<span class="number">0</span>);</span><br><span class="line">  <span class="built_in">UNREACHABLE_CODE_CHECK</span>();</span><br><span class="line"></span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  <span class="built_in">HANDLE_INSTRUCTION_START</span>(SGET) &#123;</span><br><span class="line">    <span class="type">bool</span> success = <span class="built_in">DoFieldGet</span>&lt;StaticPrimitiveRead, Primitive::kPrimInt, do_access_check&gt;(</span><br><span class="line">        self, shadow_frame, inst, inst_data);</span><br><span class="line">    <span class="built_in">POSSIBLY_HANDLE_PENDING_EXCEPTION</span>(!success, <span class="number">2</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">HANDLE_INSTRUCTION_END</span>();</span><br><span class="line"></span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  <span class="built_in">HANDLE_INSTRUCTION_START</span>(INVOKE_VIRTUAL) &#123;</span><br><span class="line">    <span class="type">bool</span> success = <span class="built_in">DoInvoke</span>&lt;kVirtual, <span class="literal">false</span>, do_access_check&gt;(</span><br><span class="line">        self, shadow_frame, inst, inst_data, &amp;result_register);</span><br><span class="line">    <span class="built_in">UPDATE_HANDLER_TABLE</span>();</span><br><span class="line">    <span class="built_in">POSSIBLY_HANDLE_PENDING_EXCEPTION</span>(!success, <span class="number">3</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">HANDLE_INSTRUCTION_END</span>();</span><br><span class="line"></span><br><span class="line">  ...</span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure>

<h2 id="ExecuteSwitchImpl"><a href="#ExecuteSwitchImpl" class="headerlink" title="ExecuteSwitchImpl"></a>ExecuteSwitchImpl</h2><p>Switch 解释器<br>每个操作码的handler位于一个 以操作码自身为标签的 case分支中；<br>handler结尾更新PC 使其指向下一个操作码；<br>switch时读取操作码，并来到其handler所在的case（底层基于编译器生成的跳转表实现）</p>
<p>优先使用 ExecuteSwitchImplAsm，如果遇到无法处理的情况，则通过传入的函数指针调用 ExecuteSwitchImplCpp</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// http://androidxref.com/9.0.0_r3/xref/art/runtime/interpreter/interpreter_switch_impl.h#59</span></span><br><span class="line"></span><br><span class="line"><span class="function">ALWAYS_INLINE JValue <span class="title">ExecuteSwitchImpl</span><span class="params">(Thread* self, <span class="type">const</span> CodeItemDataAccessor&amp; accessor,</span></span></span><br><span class="line"><span class="params"><span class="function">                                       ShadowFrame&amp; shadow_frame, JValue result_register,</span></span></span><br><span class="line"><span class="params"><span class="function">                                       <span class="type">bool</span> interpret_one_instruction)</span></span></span><br><span class="line"><span class="function">  <span class="title">REQUIRES_SHARED</span><span class="params">(Locks::mutator_lock_)</span> </span>&#123;</span><br><span class="line">  SwitchImplContext ctx &#123;</span><br><span class="line">    .self = self,</span><br><span class="line">    .accessor = accessor,</span><br><span class="line">    .shadow_frame = shadow_frame,</span><br><span class="line">    .result_register = result_register,</span><br><span class="line">    .interpret_one_instruction = interpret_one_instruction,</span><br><span class="line">    .result = <span class="built_in">JValue</span>(),</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="type">void</span>* impl = <span class="built_in">reinterpret_cast</span>&lt;<span class="type">void</span>*&gt;(&amp;ExecuteSwitchImplCpp&lt;do_access_check, transaction_active&gt;);</span><br><span class="line">  <span class="type">const</span> <span class="type">uint16_t</span>* dex_pc = ctx.accessor.<span class="built_in">Insns</span>();</span><br><span class="line">  <span class="built_in">ExecuteSwitchImplAsm</span>(&amp;ctx, impl, dex_pc);</span><br><span class="line">  <span class="keyword">return</span> ctx.result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ExecuteSwitchImplAsm"><a href="#ExecuteSwitchImplAsm" class="headerlink" title="ExecuteSwitchImplAsm"></a>ExecuteSwitchImplAsm</h3><p>基于汇编实现</p>
<h4 id="ExecuteSwitchImplCpp"><a href="#ExecuteSwitchImplCpp" class="headerlink" title="ExecuteSwitchImplCpp"></a>ExecuteSwitchImplCpp</h4><p>遇到 SGET 等涉及 字段访问的操作码，则调用 DoFieldGet 等；<br>遇到 INVOKE_VIRTUAL 等涉及 方法调用的操作码，则调用 DoInvoke</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// http://androidxref.com/9.0.0_r3/xref/art/runtime/interpreter/interpreter_switch_impl.cc#198</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ExecuteSwitchImplCpp</span><span class="params">(SwitchImplContext* ctx)</span> </span>&#123;</span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  <span class="keyword">do</span> &#123;</span><br><span class="line">    dex_pc = inst-&gt;<span class="built_in">GetDexPc</span>(insns);</span><br><span class="line">    shadow_frame.<span class="built_in">SetDexPC</span>(dex_pc);</span><br><span class="line">    <span class="built_in">TraceExecution</span>(shadow_frame, inst, dex_pc);</span><br><span class="line">    inst_data = inst-&gt;<span class="built_in">Fetch16</span>(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">switch</span> (inst-&gt;<span class="built_in">Opcode</span>(inst_data)) &#123;</span><br><span class="line">      ...</span><br><span class="line">      <span class="keyword">case</span> Instruction::SGET: &#123;</span><br><span class="line">        <span class="built_in">PREAMBLE</span>();</span><br><span class="line">        <span class="type">bool</span> success = <span class="built_in">DoFieldGet</span>&lt;StaticPrimitiveRead, Primitive::kPrimInt, do_access_check,</span><br><span class="line">            transaction_active&gt;(self, shadow_frame, inst, inst_data);</span><br><span class="line">        <span class="built_in">POSSIBLY_HANDLE_PENDING_EXCEPTION</span>(!success, Next_2xx);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      ...</span><br><span class="line">      <span class="keyword">case</span> Instruction::INVOKE_VIRTUAL: &#123;</span><br><span class="line">        <span class="built_in">PREAMBLE</span>();</span><br><span class="line">        <span class="type">bool</span> success = <span class="built_in">DoInvoke</span>&lt;kVirtual, <span class="literal">false</span>, do_access_check&gt;(</span><br><span class="line">            self, shadow_frame, inst, inst_data, &amp;result_register);</span><br><span class="line">        <span class="built_in">POSSIBLY_HANDLE_PENDING_EXCEPTION</span>(!success, Next_3xx);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      ...</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">while</span> (!interpret_one_instruction);</span><br><span class="line">  <span class="comment">// Record where we stopped.</span></span><br><span class="line">  shadow_frame.<span class="built_in">SetDexPC</span>(inst-&gt;<span class="built_in">GetDexPc</span>(insns));</span><br><span class="line">  ctx-&gt;result = result_register;</span><br><span class="line">  <span class="keyword">return</span>;</span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure>


<h1 id="C-Framework-III"><a href="#C-Framework-III" class="headerlink" title="C++ Framework III"></a>C++ Framework III</h1><p>承接上方 ExecuteSwitchImplCpp</p>
<h2 id="DoFieldGet"><a href="#DoFieldGet" class="headerlink" title="DoFieldGet"></a>DoFieldGet</h2><p>从对象的字段中读取值，并将结果存入 Shadow Frame 中的虚拟寄存器</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// http://androidxref.com/9.0.0_r3/xref/art/runtime/interpreter/interpreter_common.cc#51</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">DoFieldGet</span><span class="params">(Thread* self, ShadowFrame&amp; shadow_frame, <span class="type">const</span> Instruction* inst,</span></span></span><br><span class="line"><span class="params"><span class="function">                <span class="type">uint16_t</span> inst_data)</span> </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  ArtField* f =</span><br><span class="line">      <span class="built_in">FindFieldFromCode</span>&lt;find_type, do_access_check&gt;(field_idx, shadow_frame.<span class="built_in">GetMethod</span>(), self,</span><br><span class="line">                                                    Primitive::<span class="built_in">ComponentSize</span>(field_type));</span><br><span class="line">  ...</span><br><span class="line">  ObjPtr&lt;mirror::Object&gt; obj;</span><br><span class="line">  <span class="keyword">if</span> (is_static) &#123;</span><br><span class="line">    obj = f-&gt;<span class="built_in">GetDeclaringClass</span>();</span><br><span class="line">    ...</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    obj = shadow_frame.<span class="built_in">GetVRegReference</span>(inst-&gt;<span class="built_in">VRegB_22c</span>(inst_data));</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  JValue result;</span><br><span class="line">  ...</span><br><span class="line">  <span class="type">uint32_t</span> vregA = is_static ? inst-&gt;<span class="built_in">VRegA_21c</span>(inst_data) : inst-&gt;<span class="built_in">VRegA_22c</span>(inst_data);</span><br><span class="line">  <span class="keyword">switch</span> (field_type) &#123;</span><br><span class="line">    <span class="keyword">case</span> Primitive::kPrimBoolean:</span><br><span class="line">      shadow_frame.<span class="built_in">SetVReg</span>(vregA, result.<span class="built_in">GetZ</span>());</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> Primitive::kPrimByte:</span><br><span class="line">      shadow_frame.<span class="built_in">SetVReg</span>(vregA, result.<span class="built_in">GetB</span>());</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="DoInvoke"><a href="#DoInvoke" class="headerlink" title="DoInvoke"></a>DoInvoke</h2><p>先解析方法索引和虚拟寄存器；<br>再从dex中查找目标方法；<br>最后调用 DoCall</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// http://androidxref.com/9.0.0_r3/xref/art/runtime/interpreter/interpreter_common.h#168</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">bool</span> <span class="title">DoInvoke</span><span class="params">(Thread* self,</span></span></span><br><span class="line"><span class="params"><span class="function">                            ShadowFrame&amp; shadow_frame,</span></span></span><br><span class="line"><span class="params"><span class="function">                            <span class="type">const</span> Instruction* inst,</span></span></span><br><span class="line"><span class="params"><span class="function">                            <span class="type">uint16_t</span> inst_data,</span></span></span><br><span class="line"><span class="params"><span class="function">                            JValue* result)</span> </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="type">const</span> <span class="type">uint32_t</span> method_idx = (is_range) ? inst-&gt;<span class="built_in">VRegB_3rc</span>() : inst-&gt;<span class="built_in">VRegB_35c</span>();</span><br><span class="line">  <span class="type">const</span> <span class="type">uint32_t</span> vregC = (is_range) ? inst-&gt;<span class="built_in">VRegC_3rc</span>() : inst-&gt;<span class="built_in">VRegC_35c</span>();</span><br><span class="line">  ...</span><br><span class="line">  ArtMethod* sf_method = shadow_frame.<span class="built_in">GetMethod</span>();</span><br><span class="line">  ArtMethod* <span class="type">const</span> called_method = <span class="built_in">FindMethodFromCode</span>&lt;type, do_access_check&gt;(</span><br><span class="line">      method_idx, &amp;receiver, sf_method, self);</span><br><span class="line">  <span class="comment">// The shadow frame should already be pushed, so we don&#x27;t need to update it.</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">UNLIKELY</span>(called_method == <span class="literal">nullptr</span>)) &#123;</span><br><span class="line">    ...</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">DoCall</span>&lt;is_range, do_access_check&gt;(called_method, self, shadow_frame, inst, inst_data,</span><br><span class="line">                                             result);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="DoCall"><a href="#DoCall" class="headerlink" title="DoCall"></a>DoCall</h3><p>先解析方法调用的参数数量；<br>再从虚拟寄存器中获取参数的值；<br>最后调用 DoCallCommon</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// http://androidxref.com/9.0.0_r3/xref/art/runtime/interpreter/interpreter_common.cc#1403</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">DoCall</span><span class="params">(ArtMethod* called_method, Thread* self, ShadowFrame&amp; shadow_frame,</span></span></span><br><span class="line"><span class="params"><span class="function">            <span class="type">const</span> Instruction* inst, <span class="type">uint16_t</span> inst_data, JValue* result)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// Argument word count.</span></span><br><span class="line">  <span class="type">const</span> <span class="type">uint16_t</span> number_of_inputs =</span><br><span class="line">      (is_range) ? inst-&gt;<span class="built_in">VRegA_3rc</span>(inst_data) : inst-&gt;<span class="built_in">VRegA_35c</span>(inst_data);</span><br><span class="line"></span><br><span class="line">  <span class="type">uint32_t</span> arg[Instruction::kMaxVarArgRegs] = &#123;&#125;;  <span class="comment">// only used in invoke-XXX.</span></span><br><span class="line">  <span class="type">uint32_t</span> vregC = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> (is_range) &#123;</span><br><span class="line">    vregC = inst-&gt;<span class="built_in">VRegC_3rc</span>();</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    vregC = inst-&gt;<span class="built_in">VRegC_35c</span>();</span><br><span class="line">    inst-&gt;<span class="built_in">GetVarArgs</span>(arg, inst_data);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">DoCallCommon</span>&lt;is_range, do_assignability_check&gt;(</span><br><span class="line">      called_method, self, shadow_frame,</span><br><span class="line">      result, number_of_inputs, arg, vregC);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="DoCallCommon"><a href="#DoCallCommon" class="headerlink" title="DoCallCommon"></a>DoCallCommon</h4><p>先构造新的 Shadow Frame；<br>再将必要参数复制到其中；<br>最后调用 PerformCall</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// http://androidxref.com/9.0.0_r3/xref/art/runtime/interpreter/interpreter_common.cc#1193</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">bool</span> <span class="title">DoCallCommon</span><span class="params">(ArtMethod* called_method,</span></span></span><br><span class="line"><span class="params"><span class="function">                                Thread* self,</span></span></span><br><span class="line"><span class="params"><span class="function">                                ShadowFrame&amp; shadow_frame,</span></span></span><br><span class="line"><span class="params"><span class="function">                                JValue* result,</span></span></span><br><span class="line"><span class="params"><span class="function">                                <span class="type">uint16_t</span> number_of_inputs,</span></span></span><br><span class="line"><span class="params"><span class="function">                                <span class="type">uint32_t</span> (&amp;arg)[Instruction::kMaxVarArgRegs],</span></span></span><br><span class="line"><span class="params"><span class="function">                                <span class="type">uint32_t</span> vregC)</span> </span>&#123;</span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Number of registers for the callee&#x27;s call frame.</span></span><br><span class="line">  <span class="type">uint16_t</span> num_regs;</span><br><span class="line">  <span class="type">const</span> <span class="type">bool</span> use_interpreter_entrypoint = !Runtime::<span class="built_in">Current</span>()-&gt;<span class="built_in">IsStarted</span>() ||</span><br><span class="line">      ClassLinker::<span class="built_in">ShouldUseInterpreterEntrypoint</span>(</span><br><span class="line">          called_method,</span><br><span class="line">          called_method-&gt;<span class="built_in">GetEntryPointFromQuickCompiledCode</span>());</span><br><span class="line">  ...</span><br><span class="line">  ShadowFrameAllocaUniquePtr shadow_frame_unique_ptr =</span><br><span class="line">      <span class="built_in">CREATE_SHADOW_FRAME</span>(num_regs, &amp;shadow_frame, called_method, <span class="comment">/* dex pc */</span> <span class="number">0</span>);</span><br><span class="line">  ShadowFrame* new_shadow_frame = shadow_frame_unique_ptr.<span class="built_in">get</span>();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (do_assignability_check) &#123;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Copy the caller&#x27;s invoke-* arguments into the callee&#x27;s parameter registers.</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">uint32_t</span> shorty_pos = <span class="number">0</span>; dest_reg &lt; num_regs; ++shorty_pos, ++dest_reg, ++arg_offset) &#123;</span><br><span class="line">      <span class="comment">// Skip the 0th &#x27;shorty&#x27; type since it represents the return type.</span></span><br><span class="line">      <span class="built_in">DCHECK_LT</span>(shorty_pos + <span class="number">1</span>, shorty_len) &lt;&lt; <span class="string">&quot;for shorty &#x27;&quot;</span> &lt;&lt; shorty &lt;&lt; <span class="string">&quot;&#x27;&quot;</span>;</span><br><span class="line">      <span class="type">const</span> <span class="type">size_t</span> src_reg = (is_range) ? vregC + arg_offset : arg[arg_offset];</span><br><span class="line">      <span class="keyword">switch</span> (shorty[shorty_pos + <span class="number">1</span>]) &#123;</span><br><span class="line">        <span class="comment">// Handle Object references. 1 virtual register slot.</span></span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;L&#x27;</span>: &#123;</span><br><span class="line">          ObjPtr&lt;mirror::Object&gt; o = shadow_frame.<span class="built_in">GetVRegReference</span>(src_reg);</span><br><span class="line">          <span class="keyword">if</span> (do_assignability_check &amp;&amp; o != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">            <span class="type">const</span> dex::TypeIndex type_idx = params-&gt;<span class="built_in">GetTypeItem</span>(shorty_pos).type_idx_;</span><br><span class="line">            ObjPtr&lt;mirror::Class&gt; arg_type = method-&gt;<span class="built_in">GetDexCache</span>()-&gt;<span class="built_in">GetResolvedType</span>(type_idx);</span><br><span class="line">            <span class="keyword">if</span> (arg_type == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">              <span class="function">StackHandleScope&lt;1&gt; <span class="title">hs</span><span class="params">(self)</span></span>;</span><br><span class="line">              <span class="comment">// Preserve o since it is used below and GetClassFromTypeIndex may cause thread</span></span><br><span class="line">              <span class="comment">// suspension.</span></span><br><span class="line">              HandleWrapperObjPtr&lt;mirror::Object&gt; h = hs.<span class="built_in">NewHandleWrapper</span>(&amp;o);</span><br><span class="line">              arg_type = method-&gt;<span class="built_in">ResolveClassFromTypeIndex</span>(type_idx);</span><br><span class="line">              <span class="keyword">if</span> (arg_type == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">                <span class="built_in">CHECK</span>(self-&gt;<span class="built_in">IsExceptionPending</span>());</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (!o-&gt;<span class="built_in">VerifierInstanceOf</span>(arg_type)) &#123;</span><br><span class="line">              <span class="comment">// This should never happen.</span></span><br><span class="line">              std::string temp1, temp2;</span><br><span class="line">              self-&gt;<span class="built_in">ThrowNewExceptionF</span>(<span class="string">&quot;Ljava/lang/InternalError;&quot;</span>,</span><br><span class="line">                                       <span class="string">&quot;Invoking %s with bad arg %d, type &#x27;%s&#x27; not instance of &#x27;%s&#x27;&quot;</span>,</span><br><span class="line">                                       new_shadow_frame-&gt;<span class="built_in">GetMethod</span>()-&gt;<span class="built_in">GetName</span>(), shorty_pos,</span><br><span class="line">                                       o-&gt;<span class="built_in">GetClass</span>()-&gt;<span class="built_in">GetDescriptor</span>(&amp;temp1),</span><br><span class="line">                                       arg_type-&gt;<span class="built_in">GetDescriptor</span>(&amp;temp2));</span><br><span class="line">              <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          new_shadow_frame-&gt;<span class="built_in">SetVRegReference</span>(dest_reg, o.<span class="built_in">Ptr</span>());</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">PerformCall</span>(self,</span><br><span class="line">              accessor,</span><br><span class="line">              shadow_frame.<span class="built_in">GetMethod</span>(),</span><br><span class="line">              first_dest_reg,</span><br><span class="line">              new_shadow_frame,</span><br><span class="line">              result,</span><br><span class="line">              use_interpreter_entrypoint);</span><br><span class="line"></span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="PerformCall"><a href="#PerformCall" class="headerlink" title="PerformCall"></a>PerformCall</h5><p>根据运行时环境是否已启动，分别进行 ArtInterpreterToInterpreterBridge 的调用或 ArtInterpreterToCompiledCodeBridge 的递归调用</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// http://androidxref.com/9.0.0_r3/xref/art/runtime/common_dex_operations.h#55</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="type">void</span> <span class="title">PerformCall</span><span class="params">(Thread* self,</span></span></span><br><span class="line"><span class="params"><span class="function">                        <span class="type">const</span> CodeItemDataAccessor&amp; accessor,</span></span></span><br><span class="line"><span class="params"><span class="function">                        ArtMethod* caller_method,</span></span></span><br><span class="line"><span class="params"><span class="function">                        <span class="type">const</span> <span class="type">size_t</span> first_dest_reg,</span></span></span><br><span class="line"><span class="params"><span class="function">                        ShadowFrame* callee_frame,</span></span></span><br><span class="line"><span class="params"><span class="function">                        JValue* result,</span></span></span><br><span class="line"><span class="params"><span class="function">                        <span class="type">bool</span> use_interpreter_entrypoint)</span></span></span><br><span class="line"><span class="function">    <span class="title">REQUIRES_SHARED</span><span class="params">(Locks::mutator_lock_)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">LIKELY</span>(Runtime::<span class="built_in">Current</span>()-&gt;<span class="built_in">IsStarted</span>())) &#123;</span><br><span class="line">    <span class="keyword">if</span> (use_interpreter_entrypoint) &#123;</span><br><span class="line">      interpreter::<span class="built_in">ArtInterpreterToInterpreterBridge</span>(self, accessor, callee_frame, result);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      interpreter::<span class="built_in">ArtInterpreterToCompiledCodeBridge</span>(</span><br><span class="line">          self, caller_method, callee_frame, first_dest_reg, result);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    interpreter::UnstartedRuntime::<span class="built_in">Invoke</span>(self, accessor, callee_frame, result, first_dest_reg);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="ArtInterpreterToInterpreterBridge"><a href="#ArtInterpreterToInterpreterBridge" class="headerlink" title="ArtInterpreterToInterpreterBridge"></a>ArtInterpreterToInterpreterBridge</h6><p>递归调用 Execute</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// http://androidxref.com/9.0.0_r3/xref/art/runtime/interpreter/interpreter.cc#601</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ArtInterpreterToInterpreterBridge</span><span class="params">(Thread* self,</span></span></span><br><span class="line"><span class="params"><span class="function">                                       <span class="type">const</span> CodeItemDataAccessor&amp; accessor,</span></span></span><br><span class="line"><span class="params"><span class="function">                                       ShadowFrame* shadow_frame,</span></span></span><br><span class="line"><span class="params"><span class="function">                                       JValue* result)</span> </span>&#123;</span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  self-&gt;<span class="built_in">PushShadowFrame</span>(shadow_frame);</span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">LIKELY</span>(!shadow_frame-&gt;<span class="built_in">GetMethod</span>()-&gt;<span class="built_in">IsNative</span>())) &#123;</span><br><span class="line">    result-&gt;<span class="built_in">SetJ</span>(<span class="built_in">Execute</span>(self, accessor, *shadow_frame, <span class="built_in">JValue</span>()).<span class="built_in">GetJ</span>());</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  self-&gt;<span class="built_in">PopShadowFrame</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/lin20044140410/article/details/79369342">Android ART虚拟机执行引擎－Interpreter（八）</a>                             # Switch,Goto比较<br><a target="_blank" rel="noopener" href="https://jia.je/software/2025/03/06/android-runtime-interpreter/#%E8%A7%A3%E9%87%8A%E5%99%A8">Android Runtime 解释器的实现探究 - 解释器</a>  # Switch,Mterp比较<br><a target="_blank" rel="noopener" href="https://bbs.kanxue.com/thread-270942.htm#msg_header_h2_4">ART 在 Android 安全攻防中的应用 - 方法调用</a>  # 源码（art&#x2F;runtime&#x2F;art_method.cc）<br><a target="_blank" rel="noopener" href="https://juejin.cn/post/7384992816906747913">ART 虚拟机的解释执行</a>                                     # 源码（art&#x2F;runtime&#x2F;interpreter&#x2F;）<br><a target="_blank" rel="noopener" href="https://blog.csdn.net/luoshengyang/article/details/40289405">Android运行时ART执行类方法的过程分析</a>     # 源码（art&#x2F;runtime&#x2F;）</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://Matchstick135.github.io">Ms135</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://matchstick135.github.io/2025/03/17/2025-3-17%20dex%E6%89%A7%E8%A1%8C%E6%9C%BA%E5%88%B6/">https://matchstick135.github.io/2025/03/17/2025-3-17%20dex%E6%89%A7%E8%A1%8C%E6%9C%BA%E5%88%B6/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://Matchstick135.github.io" target="_blank">Ms135's Blog</a>！</span></div></div><div class="tag_share"><div class="post-share"><div class="social-share" data-image="/img/2025-3-17.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/2025/03/16/2025-3-16%20Smali%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B%E4%B8%8E%E8%AF%AD%E6%B3%95/" title="Smali数据类型与语法"><img class="cover" src="/img/2025-3-16.jpg" onerror="onerror=null;src='/null'" alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">Smali数据类型与语法</div></div><div class="info-2"><div class="info-item-1">对于smali指令，一直以来都是处于看得懂又看不懂的 模棱两可的状态即使遇到某个看不懂的指令时可以现查，但很影响分析的效率，而且看完之后记忆又会回归于模糊因此，在此系统地记录那些自己含糊不清过的smali指令，算是一网打尽吧文章会根据后续的学习进度，持续追加新内容 数据类型基本类型 引用类型 关键词顶层 内部注：  .param指定的参数 用参数寄存器p存储 .local申明的显示局部变量、一般操作数（隐式局部变量）用本地寄存器v存储 .register为两种寄存器的总数  操作码注：  每个操作码占 1 字节，理论上共有 2^8 种操作码。不过并非每种字节都被使用，一些保留为空操作或未来扩展使用 ART的解释器部分作为 寄存器式VM，依赖一组虚拟寄存器来存储操作数。字节码中指明操作数所在的寄存器，执行完后 结果存入指定寄存器 对字符串、类型、方法等访问是基于索引的。先分别读取dex string_ids, type_ids, method_ids中的索引信息，再基于此从dex中访问目标  方法操作调用static invoke-static12invoke-static   ...</div></div></div></a><a class="pagination-related" href="/2025/03/25/2025-3-25%20360%E5%8A%A0%E5%9B%BA%E5%85%8D%E8%B4%B9%E7%89%88%E5%88%86%E6%9E%90%EF%BC%88%E6%9C%AA%E5%AE%8C%EF%BC%89/" title="360加固免费版分析"><img class="cover" src="/img/2025-3-25.jpg" onerror="onerror=null;src='/null'" alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">360加固免费版分析</div></div><div class="info-2"><div class="info-item-1">小白久闻360加固之名，却从未亲眼见过，可以说对其中的运作机制一直是一头雾水这里紧跟这位大佬的思路，一步一个脚印去复现希望能逐步走进企业级加固，揭开其神秘面纱，也为未来面对时提供一定参考 环境如下：  系统：Android 9 架构：x64  壳程序分析壳dex原dex已不见踪影，会在后续过程中被释放加载 com.stub.StubAppattachBaseContext, onCreate 存在字符串混淆解密逻辑在 com.qihoo.util.a直接手动修复了 继续看 attachBaseContext其中主动加载 assets/libjiagu.so，并触发 com.qihoo.util.DtcLoader 的加载 来到 com.qihoo.util.DtcLoader其静态初始块中主动加载 libjgdtc.so libjiagu.so这里选择分析 libjiagu_x64.so dump节头表信息没了，Imports, Outputs表也是因此直接从内存dump，时机选在刚被 android_dlopen_ext...</div></div></div></a></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/img/%E5%A4%B4%E5%83%8F.jpg" onerror="this.onerror=null;this.src='/null'" alt="avatar"/></div><div class="author-info-name">Ms135</div><div class="author-info-description"></div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">42</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">0</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">7</div></a></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#C-Framework-I"><span class="toc-number">1.</span> <span class="toc-text">C++ Framework I</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#ArtMethod-Invoke"><span class="toc-number">1.1.</span> <span class="toc-text">ArtMethod::Invoke</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#art-quick-invoke-stub"><span class="toc-number">1.1.1.</span> <span class="toc-text">art_quick_invoke_stub</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#EnterInterpreterFromInvoke"><span class="toc-number">1.1.2.</span> <span class="toc-text">EnterInterpreterFromInvoke</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Execute"><span class="toc-number">1.1.2.1.</span> <span class="toc-text">Execute</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#InterpreterJni"><span class="toc-number">1.1.2.2.</span> <span class="toc-text">InterpreterJni</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#C-Framework-II"><span class="toc-number">2.</span> <span class="toc-text">C++ Framework II</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#ArtInterpreterToCompiledCodeBridge"><span class="toc-number">2.1.</span> <span class="toc-text">ArtInterpreterToCompiledCodeBridge</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ExecuteMterpImpl"><span class="toc-number">2.2.</span> <span class="toc-text">ExecuteMterpImpl</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ExecuteGotoImpl"><span class="toc-number">2.3.</span> <span class="toc-text">ExecuteGotoImpl</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ExecuteSwitchImpl"><span class="toc-number">2.4.</span> <span class="toc-text">ExecuteSwitchImpl</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ExecuteSwitchImplAsm"><span class="toc-number">2.4.1.</span> <span class="toc-text">ExecuteSwitchImplAsm</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#ExecuteSwitchImplCpp"><span class="toc-number">2.4.1.1.</span> <span class="toc-text">ExecuteSwitchImplCpp</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#C-Framework-III"><span class="toc-number">3.</span> <span class="toc-text">C++ Framework III</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#DoFieldGet"><span class="toc-number">3.1.</span> <span class="toc-text">DoFieldGet</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#DoInvoke"><span class="toc-number">3.2.</span> <span class="toc-text">DoInvoke</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#DoCall"><span class="toc-number">3.2.1.</span> <span class="toc-text">DoCall</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#DoCallCommon"><span class="toc-number">3.2.1.1.</span> <span class="toc-text">DoCallCommon</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#PerformCall"><span class="toc-number">3.2.1.1.1.</span> <span class="toc-text">PerformCall</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#ArtInterpreterToInterpreterBridge"><span class="toc-number">3.2.1.1.1.1.</span> <span class="toc-text">ArtInterpreterToInterpreterBridge</span></a></li></ol></li></ol></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8F%82%E8%80%83"><span class="toc-number">4.</span> <span class="toc-text">参考</span></a></li></ol></div></div><div class="card-widget card-post-series"><div class="item-headline"><i class="fa-solid fa-layer-group"></i><span>系列文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2025/03/17/2025-3-17%20dex%E6%89%A7%E8%A1%8C%E6%9C%BA%E5%88%B6/" title="dex执行机制"><img src="/img/2025-3-17.jpg" onerror="this.onerror=null;this.src='/null'" alt="dex执行机制"></a><div class="content"><a class="title" href="/2025/03/17/2025-3-17%20dex%E6%89%A7%E8%A1%8C%E6%9C%BA%E5%88%B6/" title="dex执行机制">dex执行机制</a><time datetime="2025-03-16T16:00:00.000Z" title="发表于 2025-03-17 00:00:00">2025-03-17</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/01/31/2025-1-31%20so%E5%8A%A0%E8%BD%BD%E6%B5%81%E7%A8%8B/" title="so加载流程"><img src="/img/2025-1-31.jpg" onerror="this.onerror=null;this.src='/null'" alt="so加载流程"></a><div class="content"><a class="title" href="/2025/01/31/2025-1-31%20so%E5%8A%A0%E8%BD%BD%E6%B5%81%E7%A8%8B/" title="so加载流程">so加载流程</a><time datetime="2025-01-30T16:00:00.000Z" title="发表于 2025-01-31 00:00:00">2025-01-31</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="text-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div></body></html>