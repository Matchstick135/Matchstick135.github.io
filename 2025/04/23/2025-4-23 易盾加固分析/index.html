<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>易盾加固分析 | Ms135's Blog</title><meta name="author" content="Ms135"><meta name="copyright" content="Ms135"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="环境如下：  系统：Android 10 架构：arm64  global-matadata.dat观察扔进 Il2CppDumper，嘎嘎报错果不其然，global-matadata.dat被加密了，前几字节非 AF 1B B1 FA，而是”HTPX” dump尝试使用如下脚本，基于内存匹配文件magic的形式dump 12345678910111213141516171819202122232">
<meta property="og:type" content="article">
<meta property="og:title" content="易盾加固分析">
<meta property="og:url" content="https://matchstick135.github.io/2025/04/23/2025-4-23%20%E6%98%93%E7%9B%BE%E5%8A%A0%E5%9B%BA%E5%88%86%E6%9E%90/index.html">
<meta property="og:site_name" content="Ms135&#39;s Blog">
<meta property="og:description" content="环境如下：  系统：Android 10 架构：arm64  global-matadata.dat观察扔进 Il2CppDumper，嘎嘎报错果不其然，global-matadata.dat被加密了，前几字节非 AF 1B B1 FA，而是”HTPX” dump尝试使用如下脚本，基于内存匹配文件magic的形式dump 12345678910111213141516171819202122232">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://matchstick135.github.io/img/2025-4-23.jpg">
<meta property="article:published_time" content="2025-04-22T16:00:00.000Z">
<meta property="article:modified_time" content="2025-05-13T15:17:19.738Z">
<meta property="article:author" content="Ms135">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://matchstick135.github.io/img/2025-4-23.jpg"><link rel="shortcut icon" href="/img/%E5%A4%B4%E5%83%8F.jpg"><link rel="canonical" href="https://matchstick135.github.io/2025/04/23/2025-4-23%20%E6%98%93%E7%9B%BE%E5%8A%A0%E5%9B%BA%E5%88%86%E6%9E%90/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":5,"unescape":false,"languages":{"hits_empty":"未找到符合您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":false,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":true},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: false,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '易盾加固分析',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  isShuoshuo: false
}</script><meta name="generator" content="Hexo 7.3.0"></head><body><div id="web_bg" style="background-image: url(/img/背景.jpg);"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/img/%E5%A4%B4%E5%83%8F.jpg" onerror="onerror=null;src='null'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">49</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">0</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">7</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(/img/2025-4-23.jpg);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">Ms135's Blog</span></a><a class="nav-page-title" href="/"><span class="site-name">易盾加固分析</span></a></span><div id="menus"><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></span></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">易盾加固分析</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="fa-fw post-meta-icon far fa-calendar-alt"></i><span class="post-meta-label">发表于</span><time datetime="2025-04-22T16:00:00.000Z" title="发表于 2025-04-23 00:00:00">2025-04-23</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E9%80%86%E5%90%91%E6%97%A5%E8%AE%B0/">逆向日记</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">总字数:</span><span class="word-count">6.4k</span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><p>环境如下：</p>
<ol>
<li>系统：Android 10</li>
<li>架构：arm64</li>
</ol>
<h1 id="global-matadata-dat"><a href="#global-matadata-dat" class="headerlink" title="global-matadata.dat"></a>global-matadata.dat</h1><h2 id="观察"><a href="#观察" class="headerlink" title="观察"></a>观察</h2><p>扔进 Il2CppDumper，嘎嘎报错<br>果不其然，<code>global-matadata.dat被加密了</code>，前几字节非 AF 1B B1 FA，而是”HTPX”<br><img src="/img/2025-4-23/1.png"></p>
<h2 id="dump"><a href="#dump" class="headerlink" title="dump"></a>dump</h2><p>尝试使用如下脚本，基于内存匹配文件magic的形式dump</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> pattern = <span class="string">&quot;AF 1B B1 FA&quot;</span>;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">frida_Memory</span>(<span class="params"></span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="title class_">Java</span>.<span class="title function_">perform</span>(<span class="keyword">function</span> (<span class="params"></span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;magic:&quot;</span> + pattern);</span><br><span class="line">        <span class="keyword">var</span> addrArray = <span class="title class_">Process</span>.<span class="title function_">enumerateRanges</span>(<span class="string">&quot;r--&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; addrArray.<span class="property">length</span>; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> addr = addrArray[i];</span><br><span class="line">            <span class="title class_">Memory</span>.<span class="title function_">scan</span>(addr.<span class="property">base</span>, addr.<span class="property">size</span>, pattern,</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">onMatch</span>: <span class="keyword">function</span> (<span class="params">address, size</span>)</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;find &#x27;</span> + pattern + <span class="string">&quot; at address:&quot;</span> + address.<span class="title function_">toString</span>());</span><br><span class="line">                        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">hexdump</span>(address,</span><br><span class="line">                            &#123;</span><br><span class="line">                                <span class="attr">offset</span>: <span class="number">0</span>,</span><br><span class="line">                                <span class="attr">length</span>: <span class="number">0x110</span>,</span><br><span class="line">                                <span class="attr">header</span>: <span class="literal">true</span>,</span><br><span class="line">                                <span class="attr">ansi</span>: <span class="literal">true</span></span><br><span class="line">                            &#125;</span><br><span class="line">                        ));</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">var</span> <span class="title class_">DefinitionsOffset</span> = <span class="built_in">parseInt</span>(address, <span class="number">16</span>) + <span class="number">0x108</span>;</span><br><span class="line">                        <span class="keyword">var</span> <span class="title class_">DefinitionsOffset</span>_size = <span class="title class_">Memory</span>.<span class="title function_">readInt</span>(<span class="title function_">ptr</span>(<span class="title class_">DefinitionsOffset</span>));</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">var</span> <span class="title class_">DefinitionsCount</span> = <span class="built_in">parseInt</span>(address, <span class="number">16</span>) + <span class="number">0x10C</span>;</span><br><span class="line">                        <span class="keyword">var</span> <span class="title class_">DefinitionsCount</span>_size = <span class="title class_">Memory</span>.<span class="title function_">readInt</span>(<span class="title function_">ptr</span>(<span class="title class_">DefinitionsCount</span>));</span><br><span class="line">                        <span class="keyword">if</span> (<span class="title class_">DefinitionsCount</span>_size &lt; <span class="number">10</span>)</span><br><span class="line">                        &#123;</span><br><span class="line">                            <span class="title class_">DefinitionsOffset</span> = <span class="built_in">parseInt</span>(address, <span class="number">16</span>) + <span class="number">0x100</span>;</span><br><span class="line">                            <span class="title class_">DefinitionsOffset</span>_size = <span class="title class_">Memory</span>.<span class="title function_">readInt</span>(<span class="title function_">ptr</span>(<span class="title class_">DefinitionsOffset</span>));</span><br><span class="line"></span><br><span class="line">                            <span class="title class_">DefinitionsCount</span> = <span class="built_in">parseInt</span>(address, <span class="number">16</span>) + <span class="number">0x104</span>;</span><br><span class="line">                            <span class="title class_">DefinitionsCount</span>_size = <span class="title class_">Memory</span>.<span class="title function_">readInt</span>(<span class="title function_">ptr</span>(<span class="title class_">DefinitionsCount</span>));</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">var</span> global_metadata_size = <span class="title class_">DefinitionsOffset</span>_size + <span class="title class_">DefinitionsCount</span>_size</span><br><span class="line">                        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;size：&quot;</span>, global_metadata_size);</span><br><span class="line">                        <span class="keyword">var</span> file = <span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;data/data/com.tencent.tmgp.sm/global-metadata.dat&quot;</span>, <span class="string">&quot;wb&quot;</span>);</span><br><span class="line">                        file.<span class="title function_">write</span>(<span class="title class_">Memory</span>.<span class="title function_">readByteArray</span>(address, global_metadata_size));</span><br><span class="line">                        file.<span class="title function_">flush</span>();</span><br><span class="line">                        file.<span class="title function_">close</span>();</span><br><span class="line">                        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;dump path：&#x27;</span> + <span class="string">&quot;data/data/com.tencent.tmgp.sm/global-metadata.dat&quot;</span>);</span><br><span class="line">                    &#125;,</span><br><span class="line">                    <span class="attr">onComplete</span>: <span class="keyword">function</span> (<span class="params"></span>)</span><br><span class="line">                    &#123;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            );</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">setImmediate</span>(frida_Memory); </span><br></pre></td></tr></table></figure>
<p>然而匹配无果，猜测<code>加载到内存时 被抹除了magic</code></p>
<p>由此尝试另外一种思路，在libil2cpp.so加载 global-matadata.dat时进行dump<br>然而 libil2cpp.so一扔进IDA就报错<br><img src="/img/2025-4-23/2.png"><br>搜索”global-matadata.dat”等一系列特征字符串也无果</p>
<p>很显然，<code>libil2cpp.so被加壳了</code><br>想要定位到 libil2cpp.so加载 global-matadata.dat的逻辑，也只有先脱完壳再说了</p>
<h1 id="libil2cpp-so（壳so）"><a href="#libil2cpp-so（壳so）" class="headerlink" title="libil2cpp.so（壳so）"></a>libil2cpp.so（壳so）</h1><h2 id="观察-1"><a href="#观察-1" class="headerlink" title="观察"></a>观察</h2><p>1.<br>扔进010Editor，发现<code>有两个 (RX)LOAD段</code>，且第一个 (RX)LOAD段很奇怪</p>
<p>首先，其程序头表后紧接的数据 十分杂乱（信息熵高）<br><img src="/img/2025-4-23/22.png"><br>照理来讲，存储着 .note.android.ident、.note.gnu.build-id等节的区域，不应该是如此形态<br>因此猜测<code>第一个 (RX)LOAD段程序头表后的部分，是处于加密状态的</code></p>
<p>其次，<code>其p_memsz要远大于 p_filesz</code><br><img src="/img/2025-4-23/12.png"><br>多分配了这么多内存，猜测用于存放后续加载的文件（比如自实现linker）</p>
<p>2.<br>第二个 (RX)LOAD段中，看到了前面 <em>1.</em> 中提到的.note.gnu.build-id节 的特征<br><img src="/img/2025-4-23/23.png"><br>是说<code>第二个 (RX)LOAD段才是libil2cpp.so的真正 (RX)LOAD段</code>？</p>
<p>3.<br>扔进IDA，可以看到<code>Imports, Exports表部分信息被加密了</code><br><img src="/img/2025-4-23/8.png"><br>估计是在初始化过程中被解密</p>
<p>4.<br>节区信息没被完全抹除，但<code>.init_array等节区信息都看不到了</code><br><img src="/img/2025-4-23/3.png"></p>
<h2 id="init-array定位"><a href="#init-array定位" class="headerlink" title=".init_array定位"></a>.init_array定位</h2><p>通过初期的观察能看出很多异样，由此从so加载过程中最先被执行的 .init_array入手<br>从以往对抗加固的经验来看，一切奥秘，皆在其中</p>
<p>前面 <em>观察 4.</em> 中提到 .init_array节的信息看不到了，但问题不大<br>直接搜索”ELF Initialization Function Table”来到 .init_array<br><img src="/img/2025-4-23/4.png"><br>不过有一说一，IDA本质上也是通过读取 DYNAMIC段得来的 .init_array地址<br>所以更快捷的方式是，使用Linux的 readelf工具来解析<br><img src="/img/2025-4-23/25.png"></p>
<p>然而来到此处，发现函数无法被正确识别<br><img src="/img/2025-4-23/13.png"><br>看来是节头表的内容 干扰了IDA识别，因此将其全部填充为0<br><img src="/img/2025-4-23/5.png"><br>这下能识别出来了<br><img src="/img/2025-4-23/6.png"></p>
<h2 id="init-array分析"><a href="#init-array分析" class="headerlink" title=".init_array分析"></a>.init_array分析</h2><h3 id="函数-I"><a href="#函数-I" class="headerlink" title="函数 I"></a>函数 I</h3><p><img src="/img/2025-4-23/26.png"></p>
<ol>
<li>junkcode()</li>
</ol>
<p>f5后发现伪代码爆红了，转向查看汇编<br>可以看到是由于<code>花指令 导致的堆栈不平衡</code><br><img src="/img/2025-4-23/7.png"></p>
<ol start="2">
<li>obfuscation1,2,3()</li>
</ol>
<p>同时还<code>存在几种混淆代码</code><br><img src="/img/2025-4-23/27.png"><br>不过形式都较为单一，因此暂且先略过这些，分析实际逻辑</p>
<ol start="3">
<li>init_table()</li>
</ol>
<p>将.got节中部分<code>导入函数地址 用一个table保存</code><br>后续调用库函数时，即通过 table+偏移 的形式调用<br><img src="/img/2025-4-23/28.png"></p>
<ol start="4">
<li>AntiDebug()（误）</li>
</ol>
<p>先是异或解密字符串，解密后得到”&#x2F;proc&#x2F;self&#x2F;maps”、”%*x:%*x %*d%n”<br><img src="/img/2025-4-23/29.png"><br>然后通过一系列库函数，对上述目录进行检查<br><img src="/img/2025-4-23/30.png"></p>
<p>一开始看到这些操作，刻板地以为是检测逻辑<br>后来仔细看了看，才发现貌似只是单纯的安全检查逻辑？？</p>
<h3 id="函数-II"><a href="#函数-II" class="headerlink" title="函数 II"></a>函数 II</h3><p><img src="/img/2025-4-23/31.png"></p>
<ol>
<li>analyze_Phdr()</li>
</ol>
<p>0x38算是一个特征非常显著的偏移量，其是程序头表的表项大小（p_phentsize）<br>进而可看出，加上0x38的变量，即是程序头表的基址指针<br><img src="/img/2025-4-23/32.png"></p>
<p>基于此思路可分析出，后续是在通过比较 程序头表项的类型（p_type），定位到LOAD、DYNAMIC段<br>而后<code>解析并保存各段的表项信息</code><br><img src="/img/2025-4-23/33.png"></p>
<ol start="2">
<li>prelink_image()</li>
</ol>
<p>从switch-case结构，可以看出对应so加载过程中的 <code>预链接</code>操作，用于<code>解析并保存各标签信息</code><br>进而可看出 DYNAMIC段的表项指针 对应的变量<br><img src="/img/2025-4-23/34.png"></p>
<ol start="3">
<li>decode_dynsym_dynstr()</li>
</ol>
<p>经 prelink_image()解析得到的数据被传入其中，进行<code>循环异或解密</code><br>而这里的arg[0], arg[3]，正是<code>.dynsym, .dynstr节</code>的基址指针（DT_SYMTAB,DT_STRTAB）<br><img src="/img/2025-4-23/35.png"></p>
<p>试图通过hook android_dlopen_ext() 拦截libil2cpp.so的加载，进而拦截该函数、打印传参<br>然而很奇怪，怎么都拦截不到 libil2cpp.so的加载</p>
<p>转念一想，能实现动态加载so的库函数，除了android_dlopen_ext()以外，不还有个dlopen()么<br>以下是通过查看系统库文件，得到的两者的关系<br><img src="/img/2025-2-17/4.png"></p>
<p>果不其然，经验证发现，unity涉及的三个so中，libmain.so加载通过android_dlopen_ext()；libunity.so, libil2cpp.so则是通过dlopen()<br>以下是通过查看另一个样本，得到的上述三个so的加载流程<br><img src="/img/2025-4-23/10.png"></p>
<p>说回正题，后续使用如下脚本<br>hook dlopen()拦截libil2cpp.so的加载，进而拦截该函数、dump出解密后的.dynsym, .dynstr节</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">after_so_loaded</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> so_name = <span class="string">&quot;libil2cpp.so&quot;</span>; </span><br><span class="line">    <span class="keyword">var</span> is_hooked = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(<span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="literal">null</span>, <span class="string">&quot;dlopen&quot;</span>), &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">            <span class="keyword">var</span> path = <span class="title function_">ptr</span>(args[<span class="number">0</span>]).<span class="title function_">readCString</span>();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (path.<span class="title function_">includes</span>(so_name)) &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Loading: &quot;</span> + path);</span><br><span class="line">                <span class="title function_">hook_call_constructors</span>(is_hooked);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_call_constructors</span>(<span class="params">is_hooked</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> symbols = <span class="title class_">Process</span>.<span class="title function_">getModuleByName</span>(<span class="string">&quot;linker64&quot;</span>).<span class="title function_">enumerateSymbols</span>();</span><br><span class="line">    <span class="keyword">var</span> call_constructors_addr = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> index = <span class="number">0</span>; index &lt; symbols.<span class="property">length</span>; index++) &#123;</span><br><span class="line">        <span class="keyword">const</span> symbol = symbols[index];</span><br><span class="line">        <span class="keyword">if</span> (symbol.<span class="property">name</span>.<span class="title function_">indexOf</span>(<span class="string">&quot;__dl__ZN6soinfo17call_constructorsEv&quot;</span>) != -<span class="number">1</span>) &#123;</span><br><span class="line">            call_constructors_addr = symbol.<span class="property">address</span>;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Find function call_constructors at address: &quot;</span> + call_constructors_addr);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(call_constructors_addr, &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span>(!is_hooked)&#123;</span><br><span class="line">                is_hooked = <span class="literal">true</span></span><br><span class="line">                <span class="title function_">hook_decryption_func</span>();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_decryption_func</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> libil2cpp = <span class="title class_">Process</span>.<span class="title function_">getModuleByName</span>(<span class="string">&quot;libil2cpp.so&quot;</span>);</span><br><span class="line">    <span class="keyword">const</span> target_func_offset = <span class="number">0x5353188</span>;</span><br><span class="line">    <span class="keyword">const</span> target_func_addr = libil2cpp.<span class="property">base</span>.<span class="title function_">add</span>(target_func_offset);</span><br><span class="line"></span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(target_func_addr, &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">arg0</span> = <span class="title function_">ptr</span>(args[<span class="number">0</span>]);</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">arg2</span> = args[<span class="number">2</span>].<span class="title function_">toInt32</span>();</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">arg3</span> = <span class="title function_">ptr</span>(args[<span class="number">3</span>]);</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">arg4</span> = args[<span class="number">4</span>].<span class="title function_">toInt32</span>();</span><br><span class="line">            </span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;\n[+] decryption function called&quot;</span>);</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">6</span>; i++) &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`  arg[<span class="subst">$&#123;i&#125;</span>] = <span class="subst">$&#123;args[i]&#125;</span>`</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">onLeave</span>: <span class="keyword">function</span> (<span class="params">retval</span>) &#123;</span><br><span class="line">            <span class="keyword">const</span> arg0 = <span class="variable language_">this</span>.<span class="property">arg0</span>;</span><br><span class="line">            <span class="keyword">const</span> arg2 = <span class="variable language_">this</span>.<span class="property">arg2</span>;</span><br><span class="line">            <span class="keyword">const</span> arg3 = <span class="variable language_">this</span>.<span class="property">arg3</span>;</span><br><span class="line">            <span class="keyword">const</span> arg4 = <span class="variable language_">this</span>.<span class="property">arg4</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!arg0.<span class="title function_">isNull</span>() &amp;&amp; arg2 &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">const</span> dynsym_path = <span class="string">`/data/data/com.tencent.tmgp.sm/dec_dynsym.bin`</span>;</span><br><span class="line">                <span class="title function_">dump_memory</span>(arg0, arg2, dynsym_path);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (!arg3.<span class="title function_">isNull</span>() &amp;&amp; arg4 &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">const</span> dynstr_path = <span class="string">`/data/data/com.tencent.tmgp.sm/dec_dynstr.bin`</span>;</span><br><span class="line">                <span class="title function_">dump_memory</span>(arg3, arg4, dynstr_path);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">dump_memory</span>(<span class="params">address, size, file_path</span>) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> data = <span class="title class_">Memory</span>.<span class="title function_">readByteArray</span>(address, size);</span><br><span class="line">        <span class="keyword">const</span> file_handle = <span class="keyword">new</span> <span class="title class_">File</span>(file_path, <span class="string">&quot;wb&quot;</span>);</span><br><span class="line">        file_handle.<span class="title function_">write</span>(data);</span><br><span class="line">        file_handle.<span class="title function_">flush</span>();</span><br><span class="line">        file_handle.<span class="title function_">close</span>();</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`[+] Dump <span class="subst">$&#123;address&#125;</span> with size <span class="subst">$&#123;size&#125;</span> to <span class="subst">$&#123;file_path&#125;</span>`</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">`[-] Failed to dump memory: <span class="subst">$&#123;e&#125;</span>`</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">after_so_loaded</span>();</span><br></pre></td></tr></table></figure>
<p>然后用其替换掉so中对应的部位<br>此时扔进IDA，可以看到 Imports, Exports表信息成功恢复<br><img src="/img/2025-4-23/11.png"></p>
<h3 id="函数-III"><a href="#函数-III" class="headerlink" title="函数 III"></a>函数 III</h3><p>该初始化函数包含壳的核心功能，即自实现linker<br><img src="/img/2025-4-23/36.png"></p>
<ol>
<li>deocde_phdr_dynsym_rela_dynamic()</li>
</ol>
<p><code>解密了两块数据，并存储其信息</code><br>解密函数的arg[0]-arg[3]分别是 密文指针、密文长度、明文指针、明文长度<br>其中<code>包含三段魔改RC4</code>（形式相近，这里只展示一段）<br><img src="/img/2025-4-23/37.png"></p>
<p>使用如下脚本dump出这两块数据</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">after_so_loaded</span>(<span class="params"></span>) &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_call_constructors</span>(<span class="params">is_hooked</span>) &#123;</span><br><span class="line">    ...</span><br><span class="line">    </span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(call_constructors_addr, &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span>(!is_hooked)&#123;</span><br><span class="line">                is_hooked = <span class="literal">true</span></span><br><span class="line">                <span class="title function_">hook_RC4_decryption_func</span>();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> call_count = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_RC4_decryption_func</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> libil2cpp = <span class="title class_">Process</span>.<span class="title function_">getModuleByName</span>(<span class="string">&quot;libil2cpp.so&quot;</span>);</span><br><span class="line">    <span class="keyword">const</span> target_func_offset = <span class="number">0x000000000534DD1C</span>;</span><br><span class="line">    <span class="keyword">const</span> target_func_addr = libil2cpp.<span class="property">base</span>.<span class="title function_">add</span>(target_func_offset);</span><br><span class="line"></span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(target_func_addr, &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">arg2</span> = args[<span class="number">2</span>];</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">arg3</span> = args[<span class="number">3</span>];</span><br><span class="line">            </span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;\n[+] RC4 decryption function called&quot;</span>);</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`  arg[<span class="subst">$&#123;i&#125;</span>] = <span class="subst">$&#123;args[i]&#125;</span>`</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">onLeave</span>: <span class="keyword">function</span> (<span class="params">retval</span>) &#123;</span><br><span class="line">            call_count++;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">const</span> address = <span class="variable language_">this</span>.<span class="property">arg2</span>;</span><br><span class="line">            <span class="keyword">const</span> size = <span class="built_in">parseInt</span>(<span class="variable language_">this</span>.<span class="property">arg3</span>); </span><br><span class="line">            <span class="keyword">let</span> file_path = <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (call_count === <span class="number">1</span>) &#123;</span><br><span class="line">                file_path = <span class="string">&quot;/data/data/com.tencent.tmgp.sm/dec_data1.bin&quot;</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (call_count === <span class="number">2</span>) &#123;</span><br><span class="line">                file_path = <span class="string">&quot;/data/data/com.tencent.tmgp.sm/dec_data2.bin&quot;</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="title function_">dump_memory</span>(address, size, file_path);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">dump_memory</span>(<span class="params">address, size, file_path</span>) &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">after_so_loaded</span>();</span><br></pre></td></tr></table></figure>

<p>其中 dec_data1.bin的开头，可以看到明显的 程序头表特征，这便是要加载的<code>原so的 程序头表</code><br><img src="/img/2025-4-23/38.png"><br>观察原so两个LOAD段的 p_vaddr, p_memsz，我们惊奇地发现，其正好落在 libil2cpp.so第一个(RX)LOAD段的内存区域<br>这恰恰证实了 <em>观察 1.</em> 中的猜测，libil2cpp.so第一个(RX)LOAD段映射到内存中时，<br><code>多要的这么多空间，正是用于存放原so的两个LOAD段</code>（以及原so (RW)LOAD段后紧接的.bss节）<br><img src="/img/2025-4-23/44.png"></p>
<p>dec_data1.bin的剩余部分，其实通过观察其大致形态，可以初步看出分别对应<code>原so的 .dynsym, .rela.dyn, .dynamic节</code><br>以下展现 .dynsym, .rela.dyn, .dynamic节在 dec_data1.bin、常规so下的形态对比<br><img src="/img/2025-4-23/39.png"><br>至于各节在 dec_data1.bin中的具体区域划分，就要结合后续分析了</p>
<p>对于 dec_data2.bin，暂且看不出什么名堂<br><img src="/img/2025-4-23/40.png"></p>
<ol start="2">
<li>load_LOAD()</li>
</ol>
<p>传入了前面 <em>1.</em> 中获取的 原so程序头表等信息<br>其中，先是通过 <em>函数 II 1.</em> 中 analyze_Phdr()那种方式，找到原so的LOAD段<br><img src="/img/2025-4-23/41.png"><br>然后使用 基址+偏移的形式 调用一系列库函数，<code>将原so两个LOAD段装载到内存</code><br>期间用到的 0xFFFFFFFFFFFFF000LL, 4096，用于控制映射过程的内存对齐<br><img src="/img/2025-4-23/42.png"></p>
<p>有尝试过动调至 memcpy()去dump出LOAD段<br>然而以调试模式启动应用，其根本弹不出”Waiting For Debugger”</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell am start -D -n com.tencent.tmgp.sm/com.hero.sm.SplashActivity</span><br></pre></td></tr></table></figure>
<p>先后在 Android 9,10,12 上试了试，发现只有 Android 9成功，看样子是版本问题？？</p>
<p>虽然可以使用frida -pause参数，实现类似调试模式启动的效果，然后再附加调试器<br>不过方便起见，这里还是选择直接hook BLR调用memcpy()的位置</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">after_so_loaded</span>(<span class="params"></span>) &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_call_constructors</span>(<span class="params">is_hooked</span>) &#123;</span><br><span class="line">    ...</span><br><span class="line">    </span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(call_constructors_addr, &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span>(!is_hooked)&#123;</span><br><span class="line">                is_hooked = <span class="literal">true</span></span><br><span class="line">                <span class="title function_">hook_memcpy</span>();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_memcpy</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> libil2cpp = <span class="title class_">Process</span>.<span class="title function_">getModuleByName</span>(<span class="string">&quot;libil2cpp.so&quot;</span>);</span><br><span class="line">    <span class="keyword">const</span> call_addr = libil2cpp.<span class="property">base</span>.<span class="title function_">add</span>(<span class="number">0x5352250</span>);</span><br><span class="line">    <span class="keyword">let</span> dump_counter = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(call_addr, &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>) &#123;</span><br><span class="line">            <span class="keyword">const</span> arg0 = <span class="variable language_">this</span>.<span class="property">context</span>.<span class="property">x0</span>;</span><br><span class="line">            <span class="keyword">const</span> arg1 = <span class="variable language_">this</span>.<span class="property">context</span>.<span class="property">x1</span>;</span><br><span class="line">            <span class="keyword">const</span> arg2 = <span class="variable language_">this</span>.<span class="property">context</span>.<span class="property">x2</span>.<span class="title function_">toInt32</span>();</span><br><span class="line"></span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`[+] memcpy called`</span>);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`arg[0] = 0x<span class="subst">$&#123;arg0.toString(<span class="number">16</span>)&#125;</span>`</span>);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`arg[1] = 0x<span class="subst">$&#123;arg1.toString(<span class="number">16</span>)&#125;</span>`</span>);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`arg[2] = 0x<span class="subst">$&#123;arg2.toString(<span class="number">16</span>)&#125;</span>`</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">const</span> <span class="variable language_">module</span> = <span class="title class_">Process</span>.<span class="title function_">findModuleByAddress</span>(arg0);</span><br><span class="line">            <span class="keyword">const</span> offset = arg0.<span class="title function_">sub</span>(<span class="variable language_">module</span>.<span class="property">base</span>);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`[+] destination is at: <span class="subst">$&#123;<span class="variable language_">module</span>.name&#125;</span>!0x<span class="subst">$&#123;offset.toString(<span class="number">16</span>)&#125;</span>`</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">const</span> file_path = (dump_counter++ === <span class="number">0</span>) </span><br><span class="line">                ? <span class="string">&quot;/data/data/com.tencent.tmgp.sm/RX_LOAD.bin&quot;</span></span><br><span class="line">                : <span class="string">&quot;/data/data/com.tencent.tmgp.sm/RW_LOAD.bin&quot;</span>;</span><br><span class="line"></span><br><span class="line">            <span class="title function_">dump_memory</span>(arg1, arg2, file_path);</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">onLeave</span>: <span class="keyword">function</span>(<span class="params">retval</span>) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">dump_memory</span>(<span class="params">address, size, file_path</span>) &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">after_so_loaded</span>();</span><br></pre></td></tr></table></figure>
<p>可以看到打印出的 两个LOAD段的内存信息，与前面 <em>1.</em> 中所得原so程序头表中的记录一致<br><img src="/img/2025-4-23/43.png"></p>
<p>对于第一个LOAD段，即 (RX)LOAD段，发现其中包含的程序头表是libil2cpp.so的<br>不仅如此，其与 libil2cpp.so第一个(RX)LOAD段的文件大小非常相近<br><img src="/img/2025-4-23/45.png"><br>可以说，这两个LOAD段的结构非常相似，甚至可以说是同一个<br>因此这一定程度上证实了 <em>观察 1.</em> 中的猜测，<code>libil2cpp.so第一个(RX)LOAD段中的加密部分，正是原so加密后的(RX)LOAD段</code>（的程序头表后的区域）</p>
<ol start="3">
<li>Prelink_Image()</li>
</ol>
<p>一开始以为这里是在对原so进行预链接，但如果是这样，加上后一步，原so岂不是被前前后后预链接了两次？这完全不合理<br>更何况，其中 analyze_Phdr()+prelink_image() 的操作和 <em>函数 II 1,2.</em> 中非常相似<br>因此这里其实是 <code>libil2cpp.so在对自身进行预链接</code><br><img src="/img/2025-4-23/46.png"><br>至于为什么在对原so进行预链接之前，还要对libil2cpp.so这么来一下，这就需要结合后续逻辑了</p>
<p>Prelink_Image()的输出，会作为原so soinfo结构体的一部分，参与后续的 prelink_image(), link_image()<br><img src="/img/2025-4-23/47.png"><br>也就是说，Prelink_Image()期间通过解析 libil2cpp.so DYNAMIC段得到的部分数据，会在原so的链接过程中用到<br>换句话说，这部分数据是两者共享的</p>
<p>而具体共享的是什么，其实从前面 <em>函数 II 3.</em> 中恢复信息的Exports表里，已经可以看出些端倪<br>libil2cpp.so作为壳so，如果只是单纯为加载原so服务，照理来说不会导出 il2cpp_field_get_parent()等一系列 IL2CPP运行时API<br><img src="/img/2025-4-23/48.png"><br>正是因为<code>两者共享.dynstr节</code>，才会出现这种情况<br>至于.dynsym节是否共享，还需结合后续分析</p>
<ol start="4">
<li>prelink_image()</li>
</ol>
<p>传入原so的 soinfo结构体，<code>对原so进行预链接</code><br>具体逻辑已在前面 <em>函数 II 2.</em> 中讲过，这里就不赘述了<br><img src="/img/2025-4-23/34.png"></p>
<p>使用如下脚本拦截soinfo传参，通过偏移找到存储.dynamic节指针的位置，进而实现dump<br>dump大小则可从原so程序头表中获取</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">after_so_loaded</span>(<span class="params"></span>) &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_call_constructors</span>(<span class="params">is_hooked</span>) &#123;</span><br><span class="line">    ...</span><br><span class="line">    </span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(call_constructors_addr, &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span>(!is_hooked)&#123;</span><br><span class="line">                is_hooked = <span class="literal">true</span></span><br><span class="line">                <span class="title function_">hook_prelink_image</span>();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_prelink_image</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> libil2cpp = <span class="title class_">Process</span>.<span class="title function_">getModuleByName</span>(<span class="string">&quot;libil2cpp.so&quot;</span>);</span><br><span class="line">    <span class="keyword">const</span> hook_addr = libil2cpp.<span class="property">base</span>.<span class="title function_">add</span>(<span class="number">0x53538CC</span>);</span><br><span class="line"></span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(hook_addr, &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>) &#123;</span><br><span class="line">            <span class="keyword">const</span> arg0 = <span class="variable language_">this</span>.<span class="property">context</span>.<span class="property">x0</span>;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`[+] prelink_image called`</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">const</span> addr = arg0.<span class="title function_">add</span>(<span class="number">0x40</span>).<span class="title function_">readPointer</span>();</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`[+] addr: 0x<span class="subst">$&#123;addr.toString(<span class="number">16</span>)&#125;</span>`</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">const</span> size = <span class="number">0x1F0</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">const</span> file_path = <span class="string">&quot;/data/data/com.tencent.tmgp.sm/dynamic.bin&quot;</span>;</span><br><span class="line"></span><br><span class="line">            <span class="title function_">dump_memory</span>(addr, size, file_path);</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">onLeave</span>: <span class="keyword">function</span>(<span class="params">retval</span>) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">dump_memory</span>(<span class="params">address, size, file_path</span>) &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">after_so_loaded</span>();</span><br></pre></td></tr></table></figure>

<p>在 dec_data1.bin中搜索，可成功找到.dynamic节的片段<br><img src="/img/2025-4-23/49.png"></p>
<ol start="5">
<li>link_image()</li>
</ol>
<p>同样是传入原so的 soinfo结构体<br>其中先是两处 读取soinfo特定偏移处的数据，然后进入同一个 switch-case结构中<br>非常明显的 <code>重定位</code>操作，用于<code>修正原so的.data, .got等节中的地址数据</code><br><img src="/img/2025-4-23/50.png"></p>
<p>使用如下脚本拦截soinfo传参，通过偏移找到存储.rela.dyn, .rela.plt节指针、大小的位置，进而实现dump</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">after_so_loaded</span>(<span class="params"></span>) &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_call_constructors</span>(<span class="params">is_hooked</span>) &#123;</span><br><span class="line">    ...</span><br><span class="line">    </span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(call_constructors_addr, &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span>(!is_hooked)&#123;</span><br><span class="line">                is_hooked = <span class="literal">true</span></span><br><span class="line">                <span class="title function_">hook_link_image</span>();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_link_image</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> libil2cpp = <span class="title class_">Process</span>.<span class="title function_">getModuleByName</span>(<span class="string">&quot;libil2cpp.so&quot;</span>);</span><br><span class="line">    <span class="keyword">const</span> hook_addr = libil2cpp.<span class="property">base</span>.<span class="title function_">add</span>(<span class="number">0x53545F4</span>); </span><br><span class="line"></span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(hook_addr, &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>) &#123;</span><br><span class="line">            <span class="keyword">const</span> ptr_arg0 = args[<span class="number">0</span>];</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`[+] link_image called`</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">const</span> addr1 = ptr_arg0.<span class="title function_">add</span>(<span class="number">0x90</span>).<span class="title function_">readPointer</span>();</span><br><span class="line">            <span class="keyword">const</span> size1 = ptr_arg0.<span class="title function_">add</span>(<span class="number">0x98</span>).<span class="title function_">readU32</span>();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">const</span> addr2 = ptr_arg0.<span class="title function_">add</span>(<span class="number">0x58</span>).<span class="title function_">readPointer</span>();</span><br><span class="line">            <span class="keyword">const</span> size2 = ptr_arg0.<span class="title function_">add</span>(<span class="number">0x60</span>).<span class="title function_">readU32</span>();</span><br><span class="line"></span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`addr1 = 0x<span class="subst">$&#123;addr1.toString(<span class="number">16</span>)&#125;</span>, size1 = 0x<span class="subst">$&#123;size1.toString(<span class="number">16</span>)&#125;</span>`</span>);</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`addr2 = 0x<span class="subst">$&#123;addr2.toString(<span class="number">16</span>)&#125;</span>, size2 = 0x<span class="subst">$&#123;size2.toString(<span class="number">16</span>)&#125;</span>`</span>);</span><br><span class="line"></span><br><span class="line">            <span class="title function_">dump_memory</span>(addr1, size1, <span class="string">&quot;/data/data/com.tencent.tmgp.sm/rela.dyn.bin&quot;</span>);</span><br><span class="line">            <span class="title function_">dump_memory</span>(addr2, size2, <span class="string">&quot;/data/data/com.tencent.tmgp.sm/rela.plt.bin&quot;</span>);</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">onLeave</span>: <span class="keyword">function</span>(<span class="params">retval</span>) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">dump_memory</span>(<span class="params">address, size, file_path</span>) &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">after_so_loaded</span>();</span><br></pre></td></tr></table></figure>
<p>从输出可以看出，这里的重定位表，貌似只有.rela.dyn<br><img src="/img/2025-4-23/16.png"></p>
<p>在 dec_data1.bin中搜索，可成功找到.rela.dyn节的片段<br><img src="/img/2025-4-23/17.png"></p>
<p>同样的思路，dump出原so的.dynsym节</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">after_so_loaded</span>(<span class="params"></span>) &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_call_constructors</span>(<span class="params">is_hooked</span>) &#123;</span><br><span class="line">    ...</span><br><span class="line">    </span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(call_constructors_addr, &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span> (<span class="params">args</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span>(!is_hooked)&#123;</span><br><span class="line">                is_hooked = <span class="literal">true</span></span><br><span class="line">                <span class="title function_">hook_relocate</span>();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_relocate</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> libil2cpp = <span class="title class_">Process</span>.<span class="title function_">getModuleByName</span>(<span class="string">&quot;libil2cpp.so&quot;</span>);</span><br><span class="line">    <span class="keyword">const</span> hook_addr = libil2cpp.<span class="property">base</span>.<span class="title function_">add</span>(<span class="number">0x535463C</span>);</span><br><span class="line"></span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(hook_addr, &#123;</span><br><span class="line">        <span class="attr">onEnter</span>: <span class="keyword">function</span>(<span class="params">args</span>) &#123;</span><br><span class="line">            <span class="keyword">const</span> arg0 = <span class="variable language_">this</span>.<span class="property">context</span>.<span class="property">x0</span>;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`[+] relocate called`</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">const</span> addr = arg0.<span class="title function_">add</span>(<span class="number">0x20</span>).<span class="title function_">readPointer</span>();</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`[+] addr: 0x<span class="subst">$&#123;addr.toString(<span class="number">16</span>)&#125;</span>`</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">const</span> size = <span class="number">0x1608</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">const</span> file_path = <span class="string">&quot;/data/data/com.tencent.tmgp.sm/dynsym.bin&quot;</span>;</span><br><span class="line"></span><br><span class="line">            <span class="title function_">dump_memory</span>(addr, size, file_path);</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">onLeave</span>: <span class="keyword">function</span>(<span class="params">retval</span>) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">dump_memory</span>(<span class="params">address, size, file_path</span>) &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">after_so_loaded</span>();</span><br></pre></td></tr></table></figure>

<p>在 dec_data1.bin中搜索，也可成功找到.dynsym节的片段<br><img src="/img/2025-4-23/19.png"><br>还尝试过在 libil2cpp.so中搜索，然而却没找到其片段<br>这证实了前面 <em>3.</em> 中的疑问，<code>libil2cpp.so和原so是不共享.dynsym节的</code></p>
<p>6. </p>
<p>此处代码不像前面那样 被封装在某个函数中，因此没标函数名</p>
<p>整体逻辑位于重定位之后，先是读取soinfo中数据，再是基于函数指针的循环调用<br>可以看出是在<code>对原so的.init_array进行逐个调用</code><br><img src="/img/2025-4-23/51.png"></p>
<h1 id="原so"><a href="#原so" class="headerlink" title="原so"></a>原so</h1><h2 id="修复"><a href="#修复" class="headerlink" title="修复"></a>修复</h2><p>经过上述对 libil2cpp.so的.init_array中三个函数的漫长分析，原so各部分 算是零零散散都搞到了<br>但距离能在IDA中看到 其中global-matadata.dat加载逻辑，还需要一次大修复</p>
<h3 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h3><p>本次对原so的修复思路较为特殊，这里从常规思路切入，循序渐进地阐述</p>
<p>1.<br>对于自实现linker，一般dump出原so，扔进Sofixer修复即可</p>
<p>2.<br>对于360这种，它还会将原so的 程序头表、.dynamic、.rela.dyn、.rela.plt节进行加密<br>装载时，原so会被放到壳so (RW)LOAD段的内存区域；<br>链接时，会先读取原so各部分到堆中解密，然后直接使用此数据进行链接</p>
<p>此时dump出的原so，其各部分仍是处于加密状态的<br>不过通过单独dump出解密后的各部分，并用其替换掉原so的对应部位后，便能像常规那样扔进Sofixer修复</p>
<p>3.<br>至于易盾这种，它是将原so的 程序头表、.dynamic（只保留少许表项）、.rela.dyn、.dynsym节从LOAD段中抽出，加密保存在某处<br>同时，仅将原so的 (RX)LOAD段保存在壳so中（加密后充当壳so第一个 (RX)LOAD段）<br>装载时，原so的 (RX)LOAD、(RW)LOAD段会被放到壳so 第一个(RX)LOAD段的内存区域；<br>链接时，会先解密原so 程序头表等部分，然后与壳so的.dynstr节配合使用，进行链接</p>
<p>在如此多debuff下，此时即便将上述提到的，原so的一系列数据dump出，也远未达到能扔进Sofixer的程度<br>因此只能选择如下修复思路：<code>将原so的数据附加到壳so中</code>，同时需修正一系列字段，</p>
<figure class="highlight h"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    Elf64_Word  p_type;</span><br><span class="line">    Elf64_Word  p_flags;</span><br><span class="line">    Elf64_Off   p_offset;   <span class="comment">// √</span></span><br><span class="line">    Elf64_Addr  p_vaddr;    </span><br><span class="line">    Elf64_Addr  p_paddr;</span><br><span class="line">    Elf64_Xword p_filesz;   <span class="comment">// √</span></span><br><span class="line">    Elf64_Xword p_memsz;    <span class="comment">// √</span></span><br><span class="line">    Elf64_Xword p_align;</span><br><span class="line">&#125; Elf64_Phdr;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    Elf64_Sxword d_tag;</span><br><span class="line">    <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">        Elf64_Xword d_val;</span><br><span class="line">        Elf64_Addr  d_ptr;  <span class="comment">// √</span></span><br><span class="line">    &#125; d_un;</span><br><span class="line">&#125; Elf64_Dyn;</span><br></pre></td></tr></table></figure>
<p>使得IDA能正常完成如下 so加载操作：<br>1.从文件 p_offset处找到 p_filesz大小的每个LOAD段<br>2.将其映射到内存 p_vaddr处 p_memsz大小的空间<br>3.读取DYNAMIC段各标签d_ptr，获取各表所在地址</p>
<h3 id="阶段-I"><a href="#阶段-I" class="headerlink" title="阶段 I"></a>阶段 I</h3><p>整体视图如下：<br><img src="/img/2025-4-23/52.png"></p>
<ol>
<li>写入原so删去程序头表及以上的 (RX)LOAD段</li>
</ol>
<p><em>函数 III 2.</em> 中有提到过，dump下来的 (RX)LOAD段的程序头表部分是壳so的<br>因此附加时，只需要保留其之后的数据</p>
<ol start="2">
<li>写入合并.dynsym节</li>
</ol>
<p>既然壳so与原so 只有.dynstr共享，.dynsym节各自私有。那么可以选择将两者的 .dynsym进行合并<br>然而壳so的.dynsym 已经紧密嵌在其第二个 (RX)LOAD中了，与其把后方数据整体后移 给原so的.dynsym腾地方，不如干脆在文件末尾新开一个</p>
<p>由此把原so的.dynsym放到 从壳so中提取的.dynsym之后；<br>然后把合并的.dynsym 一同附加到壳so (RW)LOAD后（覆盖掉.shstrtab节、节头表问题不大，因为其不会被加载内存）</p>
<ol start="3">
<li>写入合并.rela.dyn节</li>
</ol>
<p>处理流程和 <em>2.</em> 差不多，只不过最终是附加到 合并的.dynsym后</p>
<p>然而尝试从壳so中提取其.rela.dyn时发现，节头表中找不到它<br><img src="/img/2025-4-23/53.png"><br>问题不大，别忘了 段加载至内存前后，其内部各节之间的相对位置是不会改变的<br>所以使用如下公式即可</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">s_addr：节的地址，见DYNAMIC段 </span></span><br><span class="line"><span class="comment">p_vaddr：节所属段的地址，见程序头表</span></span><br><span class="line"><span class="comment">s_offset：节的偏移</span></span><br><span class="line"><span class="comment">p_offset：节所属段的偏移，见程序头表 </span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">s_addr - p_vaddr = s_offset - p_offset</span><br></pre></td></tr></table></figure>

<p>还有一点要注意，这里涉及一些重定位的原理<br>对于重定位表项，其结构体中 r_info的低32位 存储着符号在.dynsym中的索引</p>
<figure class="highlight h"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    Elf64_Addr   r_offset; </span><br><span class="line">    Elf64_Xword  r_info;    </span><br><span class="line">    Elf64_Sxword r_addend;  </span><br><span class="line">&#125; Elf64_Rela;</span><br></pre></td></tr></table></figure>
<p>对于原so而言，其.dynsym在合并后，其中符号的位置都整体后移了<br>因此，原so的.rela.dyn中记录的符号索引信息 也需要同步更新</p>
<p>合并前，使用如下脚本<br>修改原so 每个Elf64_Rela的 r_info的高32位（加上壳so .dynsym的总索引数）</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">process_file</span>(<span class="params">input_path, output_path</span>):</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(input_path, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> infile, <span class="built_in">open</span>(output_path, <span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> outfile:</span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            chunk = infile.read(<span class="number">0x18</span>)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> chunk:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">            qword = struct.unpack(<span class="string">&#x27;&lt;Q&#x27;</span>, chunk[<span class="number">8</span>:<span class="number">16</span>])[<span class="number">0</span>]</span><br><span class="line">            </span><br><span class="line">            high_32 = (qword &gt;&gt; <span class="number">32</span>) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> high_32 != <span class="number">0</span>:</span><br><span class="line">                add_value = <span class="number">0xD260</span> // <span class="number">0x18</span>  <span class="comment"># .dynsym的总索引数</span></span><br><span class="line">                new_qword = qword + (add_value &lt;&lt; <span class="number">32</span>)</span><br><span class="line">                new_bytes = struct.pack(<span class="string">&#x27;&lt;Q&#x27;</span>, new_qword)</span><br><span class="line">                new_chunk = chunk[:<span class="number">8</span>] + new_bytes + chunk[<span class="number">16</span>:]</span><br><span class="line">                outfile.write(new_chunk)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                outfile.write(chunk)</span><br><span class="line"></span><br><span class="line">input_file = <span class="string">r&#x27;.\rela.dyn.bin&#x27;</span></span><br><span class="line">output_file = <span class="string">r&#x27;.\rela.dyn_modified.bin&#x27;</span></span><br><span class="line"></span><br><span class="line">process_file(input_file, output_file)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;File modification completed&quot;</span>)</span><br></pre></td></tr></table></figure>


<ol start="4">
<li>修正壳so (RW)LOAD程序头表项中的 p_filesz、p_memsz</li>
</ol>
<p>经过 <em>2,3.</em> 的操作，此时合并后的.dynsym, .rela.dyn已经是附加到壳so上了<br>然而IDA在加载so时是不会理会它们的，因为其不属于当前壳so的任何一个段</p>
<p>因此，既然它们被放到了壳so (RW)LOAD后方，我们干脆将其成为该段的一部分<br>如何实现呢？修改该段 程序头表项中的 p_filesz、p_memsz字段即可</p>
<ol start="5">
<li>修正壳so DYNAMIC段的<br>DT_SYMTAB,<br>DT_RELA, DT_RELASZ,<br>DT_INIT_ARRAY, DT_INIT_ARRAYSZ,<br>DT_FINI_ARRAY, DT_FINI_ARRAYSZ</li>
</ol>
<p>还没完，合并后的.dynsym, .rela.dyn虽然是能成功加载内存了<br>但其具体位置 IDA还是找不到（原so的.init_array, .final_array也是），因此要对壳so DYNAMIC中的部分标签进行修正</p>
<p>针对 DT_SYMTAB, DT_RELA：<br>用 <em>3.</em> 中提到的公式可计算</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">s_addr：节的地址</span></span><br><span class="line"><span class="comment">p_vaddr：节所属段的地址，见程序头表</span></span><br><span class="line"><span class="comment">s_offset：节的偏移，写入时直接可得</span></span><br><span class="line"><span class="comment">p_offset：节所属段的偏移，见程序头表 </span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">s_addr - p_vaddr = s_offset - p_offset</span><br></pre></td></tr></table></figure>

<p>针对 DT_RELASZ：<br>见合并后的文件大小</p>
<p>针对 DT_INIT_ARRAY, DT_INIT_ARRAYSZ, DT_FINI_ARRAY, DT_FINI_ARRAYSZ：<br>见dump出的原so DYNAMIC段<br><img src="/img/2025-4-23/54.png"></p>
<ol start="6">
<li>写入原so (RW)LOAD段</li>
</ol>
<p>附加到 合并的.rela.dyn后</p>
<ol start="7">
<li>将壳so程序头表末尾项，用原so (RW)LOAD程序头表项覆盖，并修正 p_offset</li>
</ol>
<p>前面 <em>1.</em> 中没提及，原so (RX)LOAD是直接沿用 壳so第一个(RX)LOAD 的程序头表项<br>但对于原so (RW)LOAD，IDA目前仍无法感知到其存在</p>
<p>所以得补充 程序头表项，可直接从原so 程序头表中获取<br><img src="/img/2025-4-23/56.png"></p>
<p>然而，将壳so程序头表后方数据整体后移 给其腾地方，这可行性显然很低<br>所以干脆将 壳so某个程序头表项覆盖掉，这里选择位于末尾的 GNU Read-only After Relocation<br><img src="/img/2025-4-23/55.png"></p>
<p>最后别忘了将 p_offset修正为 (RW)LOAD当前在文件中的偏移</p>
<ol start="8">
<li><ol start="9">
<li>修正壳so程序头表中 原so两个LOAD段的 p_memsz</li>
</ol>
</li>
</ol>
<p>这部分光看上面的整体视图，可能有些云里雾里。这里引入具体数值，直观来看<br>截至目前，原so两个LOAD段的内存布局如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(RX)LOAD：  0x0  </span><br><span class="line">           +0x5311000(p_memsz_0)</span><br><span class="line">(RW)LOAD：  0x2BA9000(p_vaddr_6) </span><br><span class="line">           +0x34B7C8(p_memsz_6)</span><br></pre></td></tr></table></figure>
<p>可以看到，原so (RW)LOAD是被加载到 (RX)LOAD的内存区域中，这显然不合理<br>我们预期的应该是两个LOAD 在内存中首尾相接，且刚好填满整个区域：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(RX)LOAD：  0x0  </span><br><span class="line">           +0x2BA9000(p_vaddr_6)</span><br><span class="line">(RW)LOAD：  0x2BA9000</span><br><span class="line">           +0x2768000(p_memsz_0 - p_vaddr_6)</span><br></pre></td></tr></table></figure>

<p>上述修正思路转换成具体操作，就是：<br>先用 p_vaddr_6，覆盖掉 p_memsz_0；<br>再用覆盖前的 p_memsz_0与 p_vaddr_6的差值，覆盖掉 p_memsz_6</p>
<ul>
<li>修复脚本</li>
</ul>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"></span><br><span class="line">base_dir = <span class="string">r&quot;D:\xxx&quot;</span></span><br><span class="line">libil2cpp_so = os.path.join(base_dir, <span class="string">&quot;libil2cpp.so&quot;</span>)</span><br><span class="line">dec_data1_bin = os.path.join(base_dir, <span class="string">&quot;dec_data1.bin&quot;</span>)</span><br><span class="line">rx_load_bin = os.path.join(base_dir, <span class="string">&quot;RX_LOAD.bin&quot;</span>)</span><br><span class="line">rw_load_bin = os.path.join(base_dir, <span class="string">&quot;RW_LOAD.bin&quot;</span>)</span><br><span class="line">dynamic_bin = os.path.join(base_dir, <span class="string">&quot;dynamic.bin&quot;</span>)</span><br><span class="line">merged_dynsym_bin = os.path.join(base_dir, <span class="string">&quot;merged_dynsym.bin&quot;</span>)</span><br><span class="line">merged_rela_dyn_bin = os.path.join(base_dir, <span class="string">&quot;merged_rela.dyn.bin&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">read_file_bytes</span>(<span class="params">file_path</span>):</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(file_path, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">bytearray</span>(f.read())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">write_file_bytes</span>(<span class="params">file_path, data</span>):</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(file_path, <span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        f.write(data)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">patch_file</span>(<span class="params">file_data, offset, patch_data</span>):</span><br><span class="line">    file_data[offset:offset+<span class="built_in">len</span>(patch_data)] = patch_data</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_file_size</span>(<span class="params">file_path</span>):</span><br><span class="line">    <span class="keyword">return</span> os.path.getsize(file_path)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 1. 读取RX_LOAD.bin 0xE0开始的所有数据，写到壳so 0x1C8位置</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;perform step 1...&quot;</span>)</span><br><span class="line">rx_load_data = read_file_bytes(rx_load_bin)</span><br><span class="line">rx_load_patch = rx_load_data[<span class="number">0xE0</span>:]</span><br><span class="line">lib_data = read_file_bytes(libil2cpp_so)</span><br><span class="line">patch_file(lib_data, <span class="number">0x1C8</span>, rx_load_patch)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 写入合并.dynsym节</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;perform step 2...&quot;</span>)</span><br><span class="line">merged_dynsym_data = read_file_bytes(merged_dynsym_bin)</span><br><span class="line">dynsym_size = <span class="built_in">len</span>(merged_dynsym_data)</span><br><span class="line">patch_file(lib_data, <span class="number">0x34F3A08</span>, merged_dynsym_data)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 写入合并.rela.dyn节</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;perform step 3...&quot;</span>)</span><br><span class="line">merged_rela_dyn_data = read_file_bytes(merged_rela_dyn_bin)</span><br><span class="line">rela_dyn_size = <span class="built_in">len</span>(merged_rela_dyn_data)</span><br><span class="line"><span class="comment"># 写入文件末尾</span></span><br><span class="line">rela_dyn_offset = <span class="built_in">len</span>(lib_data)</span><br><span class="line">lib_data.extend(merged_rela_dyn_data)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. 修正壳so (RW)LOAD程序头表项中的 p_filesz、p_memsz</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;perform step 4...&quot;</span>)</span><br><span class="line">total_size = dynsym_size + rela_dyn_size</span><br><span class="line"><span class="comment"># 读取当前的p_filesz和p_memsz</span></span><br><span class="line">p_filesz = struct.unpack(<span class="string">&#x27;&lt;Q&#x27;</span>, lib_data[<span class="number">0xD0</span>:<span class="number">0xD8</span>])[<span class="number">0</span>]</span><br><span class="line">p_memsz = struct.unpack(<span class="string">&#x27;&lt;Q&#x27;</span>, lib_data[<span class="number">0xD8</span>:<span class="number">0xE0</span>])[<span class="number">0</span>]</span><br><span class="line"><span class="comment"># 加上合并后的大小</span></span><br><span class="line">new_p_filesz = p_filesz + total_size</span><br><span class="line">new_p_memsz = p_memsz + total_size</span><br><span class="line"><span class="comment"># 写回</span></span><br><span class="line">patch_file(lib_data, <span class="number">0xD0</span>, struct.pack(<span class="string">&#x27;&lt;Q&#x27;</span>, new_p_filesz))</span><br><span class="line">patch_file(lib_data, <span class="number">0xD8</span>, struct.pack(<span class="string">&#x27;&lt;Q&#x27;</span>, new_p_memsz))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 5. 修正壳so DYNAMIC段</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;perform step 5...&quot;</span>)</span><br><span class="line"><span class="comment"># 5.1 修改指定位置的QWORD</span></span><br><span class="line">base_value = <span class="number">0x5C7BA08</span></span><br><span class="line">patch_file(lib_data, <span class="number">0x2CD0270</span>, struct.pack(<span class="string">&#x27;&lt;Q&#x27;</span>, base_value))</span><br><span class="line">patch_file(lib_data, <span class="number">0x2CD02E0</span>, struct.pack(<span class="string">&#x27;&lt;Q&#x27;</span>, base_value + dynsym_size))</span><br><span class="line">patch_file(lib_data, <span class="number">0x2CD02F0</span>, struct.pack(<span class="string">&#x27;&lt;Q&#x27;</span>, rela_dyn_size))</span><br><span class="line"><span class="comment"># 5.2 从dynamic.bin读取数据并写入</span></span><br><span class="line">dynamic_data = read_file_bytes(dynamic_bin)</span><br><span class="line">dynamic_patch = dynamic_data[<span class="number">0x50</span>:<span class="number">0x50</span>+<span class="number">0x40</span>]</span><br><span class="line">patch_file(lib_data, <span class="number">0x2CD0218</span>, dynamic_patch)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 6. 写入原so (RW)LOAD段</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;perform step 6...&quot;</span>)</span><br><span class="line">rw_load_data = read_file_bytes(rw_load_bin)</span><br><span class="line">rw_load_offset = <span class="built_in">len</span>(lib_data)</span><br><span class="line">lib_data.extend(rw_load_data)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 7. 将壳so程序头表末尾项，用原so (RW)LOAD程序头表项覆盖，并修正 p_offset</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;perform step 7...&quot;</span>)</span><br><span class="line">dec_data1 = read_file_bytes(dec_data1_bin)</span><br><span class="line">dec_patch = dec_data1[<span class="number">0x38</span>:<span class="number">0x38</span>+<span class="number">0x38</span>]</span><br><span class="line">patch_file(lib_data, <span class="number">0x190</span>, dec_patch)</span><br><span class="line"><span class="comment"># 修正p_offset</span></span><br><span class="line">patch_file(lib_data, <span class="number">0x198</span>, struct.pack(<span class="string">&#x27;&lt;Q&#x27;</span>, rw_load_offset))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 8. 9. 修正壳so程序头表中 原so两个LOAD段的 p_memsz</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;perform step 8和9...&quot;</span>)</span><br><span class="line">patch_file(lib_data, <span class="number">0x68</span>, struct.pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x2BA9000</span>))</span><br><span class="line">patch_file(lib_data, <span class="number">0x1B8</span>, struct.pack(<span class="string">&#x27;&lt;Q&#x27;</span>, <span class="number">0x2768000</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 保存修改后的文件</span></span><br><span class="line">write_file_bytes(libil2cpp_so, lib_data)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Successfully!&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>修复后的so将会以如下形态，在IDA中被成功加载<br><img src="/img/2025-4-23/57.jpg"></p>
<h3 id="阶段-II"><a href="#阶段-II" class="headerlink" title="阶段 II"></a>阶段 II</h3><p>该阶段的操作只是为了让修复后的so，能直接替换掉原包下的libil2cpp.so，并正常运行<br>在此额外提一嘴</p>
<ol start="10">
<li><p>将壳so的.init_array首个函数，插入到原so的.init_array首位</p>
</li>
<li><p>写入由 .dynstr, .dynamic, .shstrtab组成的新节头表</p>
</li>
</ol>
<h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>此时通过搜索特征字符串，可直接定位到位于原so (RX)LOAD段中的global-matadata.dat加载逻辑<br><img src="/img/2025-4-23/58.png"></p>
<p>hook LoadMetadataFile()拦截返回的指针，即可成功dump出已解密的 global-matadata.dat<br>果不其然，抹除了开头的magic, version字段。手动修复一下<br><img src="/img/2025-4-23/59.png"></p>
<p>最终如愿以偿地扔进 Il2CppDumper，得到dump.cs等一系列文件<br><img src="/img/2025-4-23/60.png"><br>接下来就是常规的恢复符号、搜索关键词、定位逻辑环节了，这里不再赘述</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>详细见 <em>思路 3.</em></p>
<!-- # 参考
[记一次某盾手游加固的脱壳与修复](https://www.ctfiot.com/106094.html)
[Android安全- 某盾so加固與修復](http://www.yxfzedu.com/article/12133)
[某游戏so加固思路分析](https://www.cnblogs.com/revercc/p/17839996.html) --></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://Matchstick135.github.io">Ms135</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://matchstick135.github.io/2025/04/23/2025-4-23%20%E6%98%93%E7%9B%BE%E5%8A%A0%E5%9B%BA%E5%88%86%E6%9E%90/">https://matchstick135.github.io/2025/04/23/2025-4-23%20%E6%98%93%E7%9B%BE%E5%8A%A0%E5%9B%BA%E5%88%86%E6%9E%90/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://Matchstick135.github.io" target="_blank">Ms135's Blog</a>！</span></div></div><div class="tag_share"><div class="post-share"><div class="social-share" data-image="/img/2025-4-23.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/2025/04/10/2025-4-10%20%E5%8F%8D%E6%8A%93%E5%8C%85%E5%8F%8A%E5%AF%B9%E6%8A%97/" title="反抓包及对抗"><img class="cover" src="/img/2025-4-10.jpg" onerror="onerror=null;src='/null'" alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">反抓包及对抗</div></div><div class="info-2"><div class="info-item-1">注：  对抗过程中涉及的hook逻辑 只针对原始类名方法名。若存在混淆，则需额外分析 对于代码实现部分，只记录常用网络通信框架下的  字段加密SSL证书验证原理正常情况：1.客户端 发送HTTPS请求2.服务器 返回证书（包含公钥）3.客户端 验证公钥有效性，并生成会话密钥（一个随机数）4.客户端 用公钥加密该会话密钥后，发送给服务器5.服务器 用私钥解密，获取会话密钥6.双方 基于会话密钥，进行对称加密通信 中间人攻击：1.使用私钥 解密客户端用公钥加密后的 会话密钥2.使用公钥 加密会话密钥，发送给服务器3.后续基于会话密钥，解密、篡改、加密通信数据 实现 URLConnection 1234567891011121314151617181920212223242526public static String get(String url) &#123;    ByteArrayOutputStream byteArrayOutputStream = new ByteArrayOutputStream();    InputStream inputStream =...</div></div></div></a><a class="pagination-related" href="/2025/04/27/2025-4-27%20Xposed%E6%A3%80%E6%B5%8B%E5%8F%8A%E5%AF%B9%E6%8A%97/" title="Xposed检测及对抗"><img class="cover" src="/img/2025-4-27.jpg" onerror="onerror=null;src='/null'" alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">Xposed检测及对抗</div></div><div class="info-2"><div class="info-item-1">特定目录原理Xposed会加载 XposedBridge.jar到内存中 实现1234567891011public boolean isXposedInMaps() &#123;    try (BufferedReader br = new BufferedReader(new FileReader(&quot;/proc/self/maps&quot;))) &#123;        String line;        while ((line = br.readLine()) != null) &#123;            if (line.contains(&quot;XposedBridge.jar&quot;)) &#123;                return true;            &#125;        &#125;    &#125; catch (IOException e) &#123;&#125;    return...</div></div></div></a></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/img/%E5%A4%B4%E5%83%8F.jpg" onerror="this.onerror=null;this.src='/null'" alt="avatar"/></div><div class="author-info-name">Ms135</div><div class="author-info-description"></div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">49</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">0</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">7</div></a></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#global-matadata-dat"><span class="toc-number">1.</span> <span class="toc-text">global-matadata.dat</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A7%82%E5%AF%9F"><span class="toc-number">1.1.</span> <span class="toc-text">观察</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#dump"><span class="toc-number">1.2.</span> <span class="toc-text">dump</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#libil2cpp-so%EF%BC%88%E5%A3%B3so%EF%BC%89"><span class="toc-number">2.</span> <span class="toc-text">libil2cpp.so（壳so）</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A7%82%E5%AF%9F-1"><span class="toc-number">2.1.</span> <span class="toc-text">观察</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#init-array%E5%AE%9A%E4%BD%8D"><span class="toc-number">2.2.</span> <span class="toc-text">.init_array定位</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#init-array%E5%88%86%E6%9E%90"><span class="toc-number">2.3.</span> <span class="toc-text">.init_array分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%87%BD%E6%95%B0-I"><span class="toc-number">2.3.1.</span> <span class="toc-text">函数 I</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%87%BD%E6%95%B0-II"><span class="toc-number">2.3.2.</span> <span class="toc-text">函数 II</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%87%BD%E6%95%B0-III"><span class="toc-number">2.3.3.</span> <span class="toc-text">函数 III</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8E%9Fso"><span class="toc-number">3.</span> <span class="toc-text">原so</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BF%AE%E5%A4%8D"><span class="toc-number">3.1.</span> <span class="toc-text">修复</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%9D%E8%B7%AF"><span class="toc-number">3.1.1.</span> <span class="toc-text">思路</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%98%B6%E6%AE%B5-I"><span class="toc-number">3.1.2.</span> <span class="toc-text">阶段 I</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%98%B6%E6%AE%B5-II"><span class="toc-number">3.1.3.</span> <span class="toc-text">阶段 II</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E6%9E%90"><span class="toc-number">3.2.</span> <span class="toc-text">分析</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">4.</span> <span class="toc-text">总结</span></a></li></ol></div></div></div></div></main><footer id="footer"><div id="footer-wrap"></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="text-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div></body></html>