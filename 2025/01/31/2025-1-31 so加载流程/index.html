<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>so加载流程 | Ms135's Blog</title><meta name="author" content="Ms135"><meta name="copyright" content="Ms135"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="最近在研究基于自实现linker的so加固，涉及到so的加载原理，即装载与链接过程，这需要从Android源码入手然而经阅读发现，网上许多帖子较为古早，其与后来的Android版本 在细节实现上有较大出入因此，在此记录基于 Android 9.0 的分析过程 因为整体调用链很长，这里列出其中的关键步骤————4.1.1.1. find_libraries5.1.1.1 soinfo_alloc5.">
<meta property="og:type" content="article">
<meta property="og:title" content="so加载流程">
<meta property="og:url" content="https://matchstick135.github.io/2025/01/31/2025-1-31%20so%E5%8A%A0%E8%BD%BD%E6%B5%81%E7%A8%8B/index.html">
<meta property="og:site_name" content="Ms135&#39;s Blog">
<meta property="og:description" content="最近在研究基于自实现linker的so加固，涉及到so的加载原理，即装载与链接过程，这需要从Android源码入手然而经阅读发现，网上许多帖子较为古早，其与后来的Android版本 在细节实现上有较大出入因此，在此记录基于 Android 9.0 的分析过程 因为整体调用链很长，这里列出其中的关键步骤————4.1.1.1. find_libraries5.1.1.1 soinfo_alloc5.">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://matchstick135.github.io/img/2025-1-31.jpg">
<meta property="article:published_time" content="2025-01-30T16:00:00.000Z">
<meta property="article:modified_time" content="2025-05-14T15:21:24.666Z">
<meta property="article:author" content="Ms135">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://matchstick135.github.io/img/2025-1-31.jpg"><link rel="shortcut icon" href="/img/%E5%A4%B4%E5%83%8F.jpg"><link rel="canonical" href="https://matchstick135.github.io/2025/01/31/2025-1-31%20so%E5%8A%A0%E8%BD%BD%E6%B5%81%E7%A8%8B/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":5,"unescape":false,"languages":{"hits_empty":"未找到符合您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":false,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":true},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: false,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'so加载流程',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  isShuoshuo: false
}</script><meta name="generator" content="Hexo 7.3.0"></head><body><div id="web_bg" style="background-image: url(/img/背景.jpg);"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/img/%E5%A4%B4%E5%83%8F.jpg" onerror="onerror=null;src='null'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">49</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">0</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">7</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(/img/2025-1-31.jpg);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">Ms135's Blog</span></a><a class="nav-page-title" href="/"><span class="site-name">so加载流程</span></a></span><div id="menus"><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></span></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">so加载流程</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="fa-fw post-meta-icon far fa-calendar-alt"></i><span class="post-meta-label">发表于</span><time datetime="2025-01-30T16:00:00.000Z" title="发表于 2025-01-31 00:00:00">2025-01-31</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E7%A1%AC%E6%A0%B8%E7%9F%A5%E8%AF%86/">硬核知识</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">总字数:</span><span class="word-count">5.4k</span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><p>最近在研究基于自实现linker的so加固，涉及到so的加载原理，即装载与链接过程，这需要从Android源码入手<br>然而经阅读发现，网上许多帖子较为古早，其与后来的Android版本 在细节实现上有较大出入<br>因此，在此记录基于 Android 9.0 的分析过程</p>
<p>因为整体调用链很长，这里列出其中的关键步骤————<br>4.1.1.1. find_libraries<br>5.1.1.1 soinfo_alloc<br>5.1.1.2.1 ElfReader::Read<br>5.1.1.3 for_each_dt_needed<br>5.2.1. ElfReader::Load<br>5.3 soinfo::prelink_image<br>5.4 soinfo::link_image<br>5.4.1 soinfo::relocate</p>
<p>还有几个步骤与本篇关联较小，但还是在此提几嘴————<br>1.1. System.loadLibrary<br>3.1.1.1. android_dlopen_ext<br>3.1.2. JNI_OnLoad<br>4.1.2. soinfo::call_constructors</p>
<h1 id="Java-Framework"><a href="#Java-Framework" class="headerlink" title="Java Framework"></a>Java Framework</h1><h2 id="System-loadLibrary"><a href="#System-loadLibrary" class="headerlink" title="System.loadLibrary"></a>System.loadLibrary</h2><p>java层中加载so 直接调用的方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// http://androidxref.com/9.0.0_r3/xref/libcore/ojluni/src/main/java/java/lang/Runtime.java#976</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@CallerSensitive</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">loadLibrary</span><span class="params">(String libname)</span> &#123;</span><br><span class="line">        Runtime.getRuntime().loadLibrary0(VMStack.getCallingClassLoader(), libname);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h3 id="Runtime-loadLibrary0"><a href="#Runtime-loadLibrary0" class="headerlink" title="Runtime.loadLibrary0"></a>Runtime.loadLibrary0</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// http://androidxref.com/9.0.0_r3/xref/libcore/ojluni/src/main/java/java/lang/Runtime.java#998</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">loadLibrary0</span><span class="params">(ClassLoader loader, String libname)</span> &#123;</span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">filename</span> <span class="operator">=</span> System.mapLibraryName(libraryName);</span><br><span class="line">        List&lt;String&gt; candidates = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;String&gt;();</span><br><span class="line">        <span class="type">String</span> <span class="variable">lastError</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">for</span> (String directory : getLibPaths()) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">candidate</span> <span class="operator">=</span> directory + filename;</span><br><span class="line">            candidates.add(candidate);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (IoUtils.canOpenReadOnly(candidate)) &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">error</span> <span class="operator">=</span> nativeLoad(candidate, loader);</span><br><span class="line">                <span class="keyword">if</span> (error == <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span>; </span><br><span class="line">                &#125;</span><br><span class="line">                lastError = error;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">native</span> String <span class="title function_">nativeLoad</span><span class="params">(String filename, ClassLoader loader)</span>;</span><br></pre></td></tr></table></figure>

<h1 id="JNI"><a href="#JNI" class="headerlink" title="JNI"></a>JNI</h1><p>承接上方 Runtime.loadLibrary0</p>
<h2 id="Runtime-nativeLoad"><a href="#Runtime-nativeLoad" class="headerlink" title="Runtime_nativeLoad"></a>Runtime_nativeLoad</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// http://androidxref.com/9.0.0_r3/xref/libcore/ojluni/src/main/native/Runtime.c#77</span></span><br><span class="line"></span><br><span class="line"><span class="function">JNIEXPORT jstring JNICALL</span></span><br><span class="line"><span class="function"><span class="title">Runtime_nativeLoad</span><span class="params">(JNIEnv* env, jclass ignored, jstring javaFilename,</span></span></span><br><span class="line"><span class="params"><span class="function">                   jobject javaLoader)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">JVM_NativeLoad</span>(env, javaFilename, javaLoader);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> JNINativeMethod gMethods[] = &#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="built_in">NATIVE_METHOD</span>(Runtime, nativeLoad,</span><br><span class="line">                <span class="string">&quot;(Ljava/lang/String;Ljava/lang/ClassLoader;)&quot;</span></span><br><span class="line">                    <span class="string">&quot;Ljava/lang/String;&quot;</span>),</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="JVM-nativeLoad"><a href="#JVM-nativeLoad" class="headerlink" title="JVM_nativeLoad"></a>JVM_nativeLoad</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// http://androidxref.com/9.0.0_r3/xref/art/openjdkjvm/OpenjdkJvm.cc#323</span></span><br><span class="line"></span><br><span class="line"><span class="function">JNIEXPORT jstring <span class="title">JVM_NativeLoad</span><span class="params">(JNIEnv* env,</span></span></span><br><span class="line"><span class="params"><span class="function">                                 jstring javaFilename,</span></span></span><br><span class="line"><span class="params"><span class="function">                                 jobject javaLoader)</span> </span>&#123;</span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  std::string error_msg;</span><br><span class="line">  &#123;</span><br><span class="line">    art::JavaVMExt* vm = art::Runtime::<span class="built_in">Current</span>()-&gt;<span class="built_in">GetJavaVM</span>();</span><br><span class="line">    <span class="type">bool</span> success = vm-&gt;<span class="built_in">LoadNativeLibrary</span>(env,</span><br><span class="line">                                         filename.<span class="built_in">c_str</span>(),</span><br><span class="line">                                         javaLoader,</span><br><span class="line">                                         &amp;error_msg);</span><br><span class="line">    <span class="keyword">if</span> (success) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="C-Framework-I"><a href="#C-Framework-I" class="headerlink" title="C++ Framework I"></a>C++ Framework I</h1><p>承接上方 JVM_NativeLoad</p>
<h2 id="JavaVMExt-LoadNativeLibrary"><a href="#JavaVMExt-LoadNativeLibrary" class="headerlink" title="JavaVMExt::LoadNativeLibrary"></a>JavaVMExt::LoadNativeLibrary</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// http://androidxref.com/9.0.0_r3/xref/art/runtime/java_vm_ext.cc#854</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">JavaVMExt::LoadNativeLibrary</span><span class="params">(JNIEnv* env,</span></span></span><br><span class="line"><span class="params"><span class="function">                                  <span class="type">const</span> std::string&amp; path,</span></span></span><br><span class="line"><span class="params"><span class="function">                                  jobject class_loader,</span></span></span><br><span class="line"><span class="params"><span class="function">                                  std::string* error_msg)</span> </span>&#123;</span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  Locks::mutator_lock_-&gt;<span class="built_in">AssertNotHeld</span>(self);</span><br><span class="line">  <span class="type">const</span> <span class="type">char</span>* path_str = path.<span class="built_in">empty</span>() ? <span class="literal">nullptr</span> : path.<span class="built_in">c_str</span>();</span><br><span class="line">  <span class="type">bool</span> needs_native_bridge = <span class="literal">false</span>;</span><br><span class="line">  <span class="type">void</span>* handle = android::<span class="built_in">OpenNativeLibrary</span>(env,</span><br><span class="line">                                            runtime_-&gt;<span class="built_in">GetTargetSdkVersion</span>(),</span><br><span class="line">                                            path_str,</span><br><span class="line">                                            class_loader,</span><br><span class="line">                                            library_path.<span class="built_in">get</span>(),</span><br><span class="line">                                            &amp;needs_native_bridge,</span><br><span class="line">                                            error_msg);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">VLOG</span>(jni) &lt;&lt; <span class="string">&quot;[Call to dlopen(\&quot;&quot;</span> &lt;&lt; path &lt;&lt; <span class="string">&quot;\&quot;, RTLD_NOW) returned &quot;</span> &lt;&lt; handle &lt;&lt; <span class="string">&quot;]&quot;</span>;</span><br><span class="line"></span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  <span class="type">void</span>* sym = library-&gt;<span class="built_in">FindSymbol</span>(<span class="string">&quot;JNI_OnLoad&quot;</span>, <span class="literal">nullptr</span>);</span><br><span class="line">  <span class="keyword">if</span> (sym == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">    <span class="built_in">VLOG</span>(jni) &lt;&lt; <span class="string">&quot;[No JNI_OnLoad found in \&quot;&quot;</span> &lt;&lt; path &lt;&lt; <span class="string">&quot;\&quot;]&quot;</span>;</span><br><span class="line">    was_successful = <span class="literal">true</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    ScopedLocalRef&lt;jobject&gt; <span class="built_in">old_class_loader</span>(env, env-&gt;<span class="built_in">NewLocalRef</span>(self-&gt;<span class="built_in">GetClassLoaderOverride</span>()));</span><br><span class="line">    self-&gt;<span class="built_in">SetClassLoaderOverride</span>(class_loader);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">VLOG</span>(jni) &lt;&lt; <span class="string">&quot;[Calling JNI_OnLoad in \&quot;&quot;</span> &lt;&lt; path &lt;&lt; <span class="string">&quot;\&quot;]&quot;</span>;</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="android-OpenNativeLibrary"><a href="#android-OpenNativeLibrary" class="headerlink" title="android::OpenNativeLibrary"></a>android::OpenNativeLibrary</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// http://androidxref.com/9.0.0_r3/xref/system/core/libnativeloader/native_loader.cpp#637</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span>* <span class="title">OpenNativeLibrary</span><span class="params">(JNIEnv* env,</span></span></span><br><span class="line"><span class="params"><span class="function">                        <span class="type">int32_t</span> target_sdk_version,</span></span></span><br><span class="line"><span class="params"><span class="function">                        <span class="type">const</span> <span class="type">char</span>* path,</span></span></span><br><span class="line"><span class="params"><span class="function">                        jobject class_loader,</span></span></span><br><span class="line"><span class="params"><span class="function">                        jstring library_path,</span></span></span><br><span class="line"><span class="params"><span class="function">                        <span class="type">bool</span>* needs_native_bridge,</span></span></span><br><span class="line"><span class="params"><span class="function">                        std::string* error_msg)</span> </span>&#123;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(__ANDROID__)</span></span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (ns.<span class="built_in">is_android_namespace</span>()) &#123;</span><br><span class="line">    android_dlextinfo extinfo;</span><br><span class="line">    extinfo.flags = ANDROID_DLEXT_USE_NAMESPACE;</span><br><span class="line">    extinfo.library_namespace = ns.<span class="built_in">get_android_ns</span>();</span><br><span class="line"></span><br><span class="line">    <span class="type">void</span>* handle = <span class="built_in">android_dlopen_ext</span>(path, RTLD_NOW, &amp;extinfo);</span><br><span class="line">    <span class="keyword">if</span> (handle == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">      *error_msg = <span class="built_in">dlerror</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    *needs_native_bridge = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">return</span> handle;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">  ...</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="android-dlopen-ext"><a href="#android-dlopen-ext" class="headerlink" title="android_dlopen_ext"></a>android_dlopen_ext</h4><p>对so加载过程进行监控或拦截时，常作为hook的目标函数</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// http://androidxref.com/9.0.0_r3/xref/bionic/libdl/libdl.cpp#161</span></span><br><span class="line"></span><br><span class="line">__attribute__((__weak__))</span><br><span class="line"><span class="function"><span class="type">void</span>* <span class="title">android_dlopen_ext</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* filename, <span class="type">int</span> flag, <span class="type">const</span> android_dlextinfo* extinfo)</span> </span>&#123;</span><br><span class="line">  <span class="type">const</span> <span class="type">void</span>* caller_addr = __builtin_return_address(<span class="number">0</span>);</span><br><span class="line">  <span class="keyword">return</span> __loader_android_dlopen_ext(filename, flag, extinfo, caller_addr);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// http://androidxref.com/9.0.0_r3/xref/bionic/linker/dlfcn.cpp#145</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span>* __loader_android_dlopen_ext(<span class="type">const</span> <span class="type">char</span>* filename,</span><br><span class="line">                           <span class="type">int</span> flags,</span><br><span class="line">                           <span class="type">const</span> android_dlextinfo* extinfo,</span><br><span class="line">                           <span class="type">const</span> <span class="type">void</span>* caller_addr) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">dlopen_ext</span>(filename, flags, extinfo, caller_addr);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="dlopen-ext"><a href="#dlopen-ext" class="headerlink" title="dlopen_ext"></a>dlopen_ext</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// http://androidxref.com/9.0.0_r3/xref/bionic/linker/dlfcn.cpp#131</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span>* <span class="title">dlopen_ext</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* filename,</span></span></span><br><span class="line"><span class="params"><span class="function">                        <span class="type">int</span> flags,</span></span></span><br><span class="line"><span class="params"><span class="function">                        <span class="type">const</span> android_dlextinfo* extinfo,</span></span></span><br><span class="line"><span class="params"><span class="function">                        <span class="type">const</span> <span class="type">void</span>* caller_addr)</span> </span>&#123;</span><br><span class="line">  <span class="function">ScopedPthreadMutexLocker <span class="title">locker</span><span class="params">(&amp;g_dl_mutex)</span></span>;</span><br><span class="line">  g_linker_logger.<span class="built_in">ResetState</span>();</span><br><span class="line">  <span class="type">void</span>* result = <span class="built_in">do_dlopen</span>(filename, flags, extinfo, caller_addr);</span><br><span class="line">  <span class="keyword">if</span> (result == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">    __bionic_format_dlerror(<span class="string">&quot;dlopen failed&quot;</span>, <span class="built_in">linker_get_error_buffer</span>());</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="JNI-OnLoad"><a href="#JNI-OnLoad" class="headerlink" title="JNI_OnLoad"></a>JNI_OnLoad</h3><p>一直以来都不清楚 init_func、init_array、JNI_OnLoad三者的执行先后顺序，这下搬出源码后弄明白了<br>下方提及的 init_func、init_array，在 JNI_OnLoad之前执行</p>
<h1 id="C-Framework-II"><a href="#C-Framework-II" class="headerlink" title="C++ Framework II"></a>C++ Framework II</h1><p>承接上方 dlopen_ext</p>
<h2 id="do-dlopen"><a href="#do-dlopen" class="headerlink" title="do_dlopen"></a>do_dlopen</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// http://androidxref.com/9.0.0_r3/xref/bionic/linker/linker.cpp#2049</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span>* <span class="title">do_dlopen</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* name, <span class="type">int</span> flags,</span></span></span><br><span class="line"><span class="params"><span class="function">                <span class="type">const</span> android_dlextinfo* extinfo,</span></span></span><br><span class="line"><span class="params"><span class="function">                <span class="type">const</span> <span class="type">void</span>* caller_addr)</span> </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  </span><br><span class="line">  ProtectedDataGuard guard;</span><br><span class="line">  soinfo* si = <span class="built_in">find_library</span>(ns, translated_name, flags, extinfo, caller);</span><br><span class="line">  loading_trace.<span class="built_in">End</span>();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (si != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">    <span class="type">void</span>* handle = si-&gt;<span class="built_in">to_handle</span>();</span><br><span class="line">    <span class="built_in">LD_LOG</span>(kLogDlopen,</span><br><span class="line">           <span class="string">&quot;... dlopen calling constructors: realpath=\&quot;%s\&quot;, soname=\&quot;%s\&quot;, handle=%p&quot;</span>,</span><br><span class="line">           si-&gt;<span class="built_in">get_realpath</span>(), si-&gt;<span class="built_in">get_soname</span>(), handle);</span><br><span class="line">    si-&gt;<span class="built_in">call_constructors</span>();</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="find-library"><a href="#find-library" class="headerlink" title="find_library"></a>find_library</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// http://androidxref.com/9.0.0_r3/xref/bionic/linker/linker.cpp#1759</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> soinfo* <span class="title">find_library</span><span class="params">(<span class="type">android_namespace_t</span>* ns,</span></span></span><br><span class="line"><span class="params"><span class="function">                            <span class="type">const</span> <span class="type">char</span>* name, <span class="type">int</span> rtld_flags,</span></span></span><br><span class="line"><span class="params"><span class="function">                            <span class="type">const</span> android_dlextinfo* extinfo,</span></span></span><br><span class="line"><span class="params"><span class="function">                            soinfo* needed_by)</span> </span>&#123;</span><br><span class="line">  soinfo* si = <span class="literal">nullptr</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (name == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">    si = <span class="built_in">solist_get_somain</span>();</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="built_in">find_libraries</span>(ns,</span><br><span class="line">                             needed_by,</span><br><span class="line">                             &amp;name,</span><br><span class="line">                             <span class="number">1</span>,</span><br><span class="line">                             &amp;si,</span><br><span class="line">                             <span class="literal">nullptr</span>,</span><br><span class="line">                             <span class="number">0</span>,</span><br><span class="line">                             rtld_flags,</span><br><span class="line">                             extinfo,</span><br><span class="line">                             <span class="literal">false</span> <span class="comment">/* add_as_children */</span>,</span><br><span class="line">                             <span class="literal">true</span> <span class="comment">/* search_linked_namespaces */</span>)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (si != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">      <span class="built_in">soinfo_unload</span>(si);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  si-&gt;<span class="built_in">increment_ref_count</span>();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> si;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="find-libraries"><a href="#find-libraries" class="headerlink" title="find_libraries"></a>find_libraries</h4><p>so加载流程中的关键函数，装载、链接操作都直接在其中进行<br>通过遍历 load_tasks 列表，基于 soinfo 结构体，对目标so及其所有依赖库进行加载<br>其中，装载由 find_library_internal, task-&gt;load 负责；链接由 si-&gt;prelink_image, si-&gt;link_image 负责</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// http://androidxref.com/9.0.0_r3/xref/bionic/linker/linker.cpp#1508</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">find_libraries</span><span class="params">(<span class="type">android_namespace_t</span>* ns,</span></span></span><br><span class="line"><span class="params"><span class="function">                    soinfo* start_with,</span></span></span><br><span class="line"><span class="params"><span class="function">                    <span class="type">const</span> <span class="type">char</span>* <span class="type">const</span> library_names[],</span></span></span><br><span class="line"><span class="params"><span class="function">                    <span class="type">size_t</span> library_names_count,</span></span></span><br><span class="line"><span class="params"><span class="function">                    soinfo* soinfos[],</span></span></span><br><span class="line"><span class="params"><span class="function">                    std::vector&lt;soinfo*&gt;* ld_preloads,</span></span></span><br><span class="line"><span class="params"><span class="function">                    <span class="type">size_t</span> ld_preloads_count,</span></span></span><br><span class="line"><span class="params"><span class="function">                    <span class="type">int</span> rtld_flags,</span></span></span><br><span class="line"><span class="params"><span class="function">                    <span class="type">const</span> android_dlextinfo* extinfo,</span></span></span><br><span class="line"><span class="params"><span class="function">                    <span class="type">bool</span> add_as_children,</span></span></span><br><span class="line"><span class="params"><span class="function">                    <span class="type">bool</span> search_linked_namespaces,</span></span></span><br><span class="line"><span class="params"><span class="function">                    std::vector&lt;<span class="type">android_namespace_t</span>*&gt;* namespaces)</span> </span>&#123;</span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i&lt;load_tasks.<span class="built_in">size</span>(); ++i) &#123;</span><br><span class="line">    LoadTask* task = load_tasks[i];</span><br><span class="line">    soinfo* needed_by = task-&gt;<span class="built_in">get_needed_by</span>();</span><br><span class="line"></span><br><span class="line">    <span class="type">bool</span> is_dt_needed = needed_by != <span class="literal">nullptr</span> &amp;&amp; (needed_by != start_with || add_as_children);</span><br><span class="line">    task-&gt;<span class="built_in">set_extinfo</span>(is_dt_needed ? <span class="literal">nullptr</span> : extinfo);</span><br><span class="line">    task-&gt;<span class="built_in">set_dt_needed</span>(is_dt_needed);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">find_library_internal</span>(<span class="built_in">const_cast</span>&lt;<span class="type">android_namespace_t</span>*&gt;(task-&gt;<span class="built_in">get_start_from</span>()),</span><br><span class="line">                               task,</span><br><span class="line">                               &amp;zip_archive_cache,</span><br><span class="line">                               &amp;load_tasks,</span><br><span class="line">                               rtld_flags,</span><br><span class="line">                               search_linked_namespaces || is_dt_needed)) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">auto</span>&amp;&amp; task : load_list) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!task-&gt;<span class="built_in">load</span>()) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">auto</span>&amp;&amp; task : load_tasks) &#123;</span><br><span class="line">    soinfo* si = task-&gt;<span class="built_in">get_soinfo</span>();</span><br><span class="line">    <span class="keyword">if</span> (!si-&gt;<span class="built_in">is_linked</span>() &amp;&amp; !si-&gt;<span class="built_in">prelink_image</span>()) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"> </span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">auto</span> root : local_group_roots) &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="type">bool</span> linked = local_group.<span class="built_in">visit</span>([&amp;](soinfo* si) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!si-&gt;<span class="built_in">is_linked</span>() &amp;&amp; si-&gt;<span class="built_in">get_primary_namespace</span>() == local_group_ns) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!si-&gt;<span class="built_in">link_image</span>(global_group, local_group, extinfo) ||</span><br><span class="line">            !<span class="built_in">get_cfi_shadow</span>()-&gt;<span class="built_in">AfterLoad</span>(si, <span class="built_in">solist_get_head</span>())) &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="soinfo-call-constructors"><a href="#soinfo-call-constructors" class="headerlink" title="soinfo::call_constructors"></a>soinfo::call_constructors</h3><p>上方提及的 JNI_OnLoad，在 init_func、init_array之后执行；<br>而 init_func先于 init_array执行</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// http://androidxref.com/9.0.0_r3/xref/bionic/linker/linker_soinfo.cpp#388</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">soinfo::call_constructors</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  </span><br><span class="line">  <span class="built_in">call_function</span>(<span class="string">&quot;DT_INIT&quot;</span>, init_func_, <span class="built_in">get_realpath</span>());</span><br><span class="line">  <span class="built_in">call_array</span>(<span class="string">&quot;DT_INIT_ARRAY&quot;</span>, init_array_, init_array_count_, <span class="literal">false</span>, <span class="built_in">get_realpath</span>());</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!<span class="built_in">is_linker</span>()) &#123;</span><br><span class="line">    <span class="built_in">bionic_trace_end</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="C-Framework-III"><a href="#C-Framework-III" class="headerlink" title="C++ Framework III"></a>C++ Framework III</h1><p>承接上方 find_libraries </p>
<h2 id="find-library-internal"><a href="#find-library-internal" class="headerlink" title="find_library_internal"></a>find_library_internal</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// http://androidxref.com/9.0.0_r3/xref/bionic/linker/linker.cpp#1442</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">bool</span> <span class="title">find_library_internal</span><span class="params">(<span class="type">android_namespace_t</span>* ns,</span></span></span><br><span class="line"><span class="params"><span class="function">                                  LoadTask* task,</span></span></span><br><span class="line"><span class="params"><span class="function">                                  ZipArchiveCache* zip_archive_cache,</span></span></span><br><span class="line"><span class="params"><span class="function">                                  LoadTaskList* load_tasks,</span></span></span><br><span class="line"><span class="params"><span class="function">                                  <span class="type">int</span> rtld_flags,</span></span></span><br><span class="line"><span class="params"><span class="function">                                  <span class="type">bool</span> search_linked_namespaces)</span> </span>&#123;</span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">load_library</span>(ns, task, zip_archive_cache, load_tasks, rtld_flags, search_linked_namespaces)) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (search_linked_namespaces) &#123;</span><br><span class="line">    DlErrorRestorer dlerror_restorer;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span>&amp; linked_namespace : ns-&gt;<span class="built_in">linked_namespaces</span>()) &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">find_library_in_linked_namespace</span>(linked_namespace,</span><br><span class="line">                                           task)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (task-&gt;<span class="built_in">get_soinfo</span>() == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">          <span class="keyword">if</span> (<span class="built_in">load_library</span>(linked_namespace.<span class="built_in">linked_namespace</span>(), task, zip_archive_cache, load_tasks, rtld_flags, <span class="literal">false</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="load-library"><a href="#load-library" class="headerlink" title="load_library"></a>load_library</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// http://androidxref.com/9.0.0_r3/xref/bionic/linker/linker.cpp#1322</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">bool</span> <span class="title">load_library</span><span class="params">(<span class="type">android_namespace_t</span>* ns,</span></span></span><br><span class="line"><span class="params"><span class="function">                         LoadTask* task,</span></span></span><br><span class="line"><span class="params"><span class="function">                         ZipArchiveCache* zip_archive_cache,</span></span></span><br><span class="line"><span class="params"><span class="function">                         LoadTaskList* load_tasks,</span></span></span><br><span class="line"><span class="params"><span class="function">                         <span class="type">int</span> rtld_flags,</span></span></span><br><span class="line"><span class="params"><span class="function">                         <span class="type">bool</span> search_linked_namespaces)</span> </span>&#123;</span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">load_library</span>(ns, task, load_tasks, rtld_flags, realpath, search_linked_namespaces);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// http://androidxref.com/9.0.0_r3/xref/bionic/linker/linker.cpp#1188</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">bool</span> <span class="title">load_library</span><span class="params">(<span class="type">android_namespace_t</span>* ns,</span></span></span><br><span class="line"><span class="params"><span class="function">                         LoadTask* task,</span></span></span><br><span class="line"><span class="params"><span class="function">                         LoadTaskList* load_tasks,</span></span></span><br><span class="line"><span class="params"><span class="function">                         <span class="type">int</span> rtld_flags,</span></span></span><br><span class="line"><span class="params"><span class="function">                         <span class="type">const</span> std::string&amp; realpath,</span></span></span><br><span class="line"><span class="params"><span class="function">                         <span class="type">bool</span> search_linked_namespaces)</span> </span>&#123;</span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  soinfo* si = <span class="built_in">soinfo_alloc</span>(ns, realpath.<span class="built_in">c_str</span>(), &amp;file_stat, file_offset, rtld_flags);</span><br><span class="line">  <span class="keyword">if</span> (si == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  task-&gt;<span class="built_in">set_soinfo</span>(si);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!task-&gt;<span class="built_in">read</span>(realpath.<span class="built_in">c_str</span>(), file_stat.st_size)) &#123;</span><br><span class="line">    <span class="built_in">soinfo_free</span>(si);</span><br><span class="line">    task-&gt;<span class="built_in">set_soinfo</span>(<span class="literal">nullptr</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  for_each_dt_needed(task-&gt;<span class="built_in">get_elf_reader</span>(), [&amp;](<span class="type">const</span> <span class="type">char</span>* name) &#123;</span><br><span class="line">    load_tasks-&gt;<span class="built_in">push_back</span>(LoadTask::<span class="built_in">create</span>(name, si, ns, task-&gt;<span class="built_in">get_readers_map</span>()));</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="soinfo-alloc"><a href="#soinfo-alloc" class="headerlink" title="soinfo_alloc"></a>soinfo_alloc</h4><p>负责 soinfo 结构体的初始化<br>将其添加到 solist 全局链表，并生成唯一的句柄</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// http://androidxref.com/9.0.0_r3/xref/bionic/linker/linker.cpp#296</span></span><br><span class="line"></span><br><span class="line"><span class="function">soinfo* <span class="title">soinfo_alloc</span><span class="params">(<span class="type">android_namespace_t</span>* ns, <span class="type">const</span> <span class="type">char</span>* name,</span></span></span><br><span class="line"><span class="params"><span class="function">                     <span class="keyword">struct</span> stat* file_stat, <span class="type">off64_t</span> file_offset,</span></span></span><br><span class="line"><span class="params"><span class="function">                     <span class="type">uint32_t</span> rtld_flags)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">strlen</span>(name) &gt;= PATH_MAX) &#123;</span><br><span class="line">    <span class="built_in">async_safe_fatal</span>(<span class="string">&quot;library name \&quot;%s\&quot; too long&quot;</span>, name);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">TRACE</span>(<span class="string">&quot;name %s: allocating soinfo for ns=%p&quot;</span>, name, ns);</span><br><span class="line"></span><br><span class="line">  soinfo* si = <span class="built_in">new</span> (g_soinfo_allocator.<span class="built_in">alloc</span>()) <span class="built_in">soinfo</span>(ns, name, file_stat,</span><br><span class="line">                                                       file_offset, rtld_flags);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">solist_add_soinfo</span>(si);</span><br><span class="line"></span><br><span class="line">  si-&gt;<span class="built_in">generate_handle</span>();</span><br><span class="line">  ns-&gt;<span class="built_in">add_soinfo</span>(si);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">TRACE</span>(<span class="string">&quot;name %s: allocated soinfo @ %p&quot;</span>, name, si);</span><br><span class="line">  <span class="keyword">return</span> si;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="LoadTask-read"><a href="#LoadTask-read" class="headerlink" title="LoadTask.read"></a>LoadTask.read</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// http://androidxref.com/9.0.0_r3/xref/bionic/linker/linker.cpp#559</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">LoadTask</span> &#123;</span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  ...</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="type">bool</span> <span class="title">read</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* realpath, <span class="type">off64_t</span> file_size)</span> </span>&#123;</span><br><span class="line">    ElfReader&amp; elf_reader = <span class="built_in">get_elf_reader</span>();</span><br><span class="line">    <span class="keyword">return</span> elf_reader.<span class="built_in">Read</span>(realpath, fd_, file_offset_, file_size);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"> ...</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h5 id="ElfReader-Read"><a href="#ElfReader-Read" class="headerlink" title="ElfReader::Read"></a>ElfReader::Read</h5><p>负责装载前的 读取校验及初步映射，共分为五个步骤</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// http://androidxref.com/9.0.0_r3/xref/bionic/linker/linker_phdr.cpp#149</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">ElfReader::Read</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* name, <span class="type">int</span> fd, <span class="type">off64_t</span> file_offset, <span class="type">off64_t</span> file_size)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (did_read_) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  name_ = name;</span><br><span class="line">  fd_ = fd;</span><br><span class="line">  file_offset_ = file_offset;</span><br><span class="line">  file_size_ = file_size;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">ReadElfHeader</span>() &amp;&amp;</span><br><span class="line">      <span class="built_in">VerifyElfHeader</span>() &amp;&amp;</span><br><span class="line">      <span class="built_in">ReadProgramHeaders</span>() &amp;&amp;</span><br><span class="line">      <span class="built_in">ReadSectionHeaders</span>() &amp;&amp;</span><br><span class="line">      <span class="built_in">ReadDynamicSection</span>()) &#123;</span><br><span class="line">    did_read_ = <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> did_read_;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li><p>ElfReader::ReadElfHeader<br>使用 pread64 系统调用读取 ELF 头</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// http://androidxref.com/9.0.0_r3/xref/bionic/linker/linker_phdr.cpp#190</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">ElfReader::ReadElfHeader</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="type">ssize_t</span> rc = <span class="built_in">TEMP_FAILURE_RETRY</span>(<span class="built_in">pread64</span>(fd_, &amp;header_, <span class="built_in">sizeof</span>(header_), file_offset_));</span><br><span class="line">  <span class="keyword">if</span> (rc &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="built_in">DL_ERR</span>(<span class="string">&quot;can&#x27;t read file \&quot;%s\&quot;: %s&quot;</span>, name_.<span class="built_in">c_str</span>(), <span class="built_in">strerror</span>(errno));</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (rc != <span class="built_in">sizeof</span>(header_)) &#123;</span><br><span class="line">    <span class="built_in">DL_ERR</span>(<span class="string">&quot;\&quot;%s\&quot; is too small to be an ELF executable: only found %zd bytes&quot;</span>, name_.<span class="built_in">c_str</span>(),</span><br><span class="line">           <span class="built_in">static_cast</span>&lt;<span class="type">size_t</span>&gt;(rc));</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>ElfReader::VerifyElfHeader<br>验证 ELF 头的有效性———<br>魔数是否为 \x7fELF，即 ELF 文件标识；<br>类型是否为共享对象（ET_DYN），即 .so 文件；<br>.shstrtab 节的索引是否有效…</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// http://androidxref.com/9.0.0_r3/xref/bionic/linker/linker_phdr.cpp#214</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">ElfReader::VerifyElfHeader</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">memcmp</span>(header_.e_ident, ELFMAG, SELFMAG) != <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="built_in">DL_ERR</span>(<span class="string">&quot;\&quot;%s\&quot; has bad ELF magic&quot;</span>, name_.<span class="built_in">c_str</span>());</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="type">int</span> elf_class = header_.e_ident[EI_CLASS];</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(__LP64__)</span></span><br><span class="line">  <span class="keyword">if</span> (elf_class != ELFCLASS64) &#123;</span><br><span class="line">    <span class="keyword">if</span> (elf_class == ELFCLASS32) &#123;</span><br><span class="line">      <span class="built_in">DL_ERR</span>(<span class="string">&quot;\&quot;%s\&quot; is 32-bit instead of 64-bit&quot;</span>, name_.<span class="built_in">c_str</span>());</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="built_in">DL_ERR</span>(<span class="string">&quot;\&quot;%s\&quot; has unknown ELF class: %d&quot;</span>, name_.<span class="built_in">c_str</span>(), elf_class);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">  <span class="keyword">if</span> (elf_class != ELFCLASS32) &#123;</span><br><span class="line">    <span class="keyword">if</span> (elf_class == ELFCLASS64) &#123;</span><br><span class="line">      <span class="built_in">DL_ERR</span>(<span class="string">&quot;\&quot;%s\&quot; is 64-bit instead of 32-bit&quot;</span>, name_.<span class="built_in">c_str</span>());</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="built_in">DL_ERR</span>(<span class="string">&quot;\&quot;%s\&quot; has unknown ELF class: %d&quot;</span>, name_.<span class="built_in">c_str</span>(), elf_class);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (header_.e_ident[EI_DATA] != ELFDATA2LSB) &#123;</span><br><span class="line">    <span class="built_in">DL_ERR</span>(<span class="string">&quot;\&quot;%s\&quot; not little-endian: %d&quot;</span>, name_.<span class="built_in">c_str</span>(), header_.e_ident[EI_DATA]);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (header_.e_type != ET_DYN) &#123;</span><br><span class="line">    <span class="built_in">DL_ERR</span>(<span class="string">&quot;\&quot;%s\&quot; has unexpected e_type: %d&quot;</span>, name_.<span class="built_in">c_str</span>(), header_.e_type);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (header_.e_version != EV_CURRENT) &#123;</span><br><span class="line">    <span class="built_in">DL_ERR</span>(<span class="string">&quot;\&quot;%s\&quot; has unexpected e_version: %d&quot;</span>, name_.<span class="built_in">c_str</span>(), header_.e_version);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (header_.e_machine != <span class="built_in">GetTargetElfMachine</span>()) &#123;</span><br><span class="line">    <span class="built_in">DL_ERR</span>(<span class="string">&quot;\&quot;%s\&quot; has unexpected e_machine: %d (%s)&quot;</span>, name_.<span class="built_in">c_str</span>(), header_.e_machine,</span><br><span class="line">           <span class="built_in">EM_to_string</span>(header_.e_machine));</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (header_.e_shentsize != <span class="built_in">sizeof</span>(<span class="built_in">ElfW</span>(Shdr))) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">get_application_target_sdk_version</span>() &gt;= __ANDROID_API_O__) &#123;</span><br><span class="line">      <span class="built_in">DL_ERR_AND_LOG</span>(<span class="string">&quot;\&quot;%s\&quot; has unsupported e_shentsize: 0x%x (expected 0x%zx)&quot;</span>,</span><br><span class="line">                     name_.<span class="built_in">c_str</span>(), header_.e_shentsize, <span class="built_in">sizeof</span>(<span class="built_in">ElfW</span>(Shdr)));</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">DL_WARN_documented_change</span>(__ANDROID_API_O__,</span><br><span class="line">                              <span class="string">&quot;invalid-elf-header_section-headers-enforced-for-api-level-26&quot;</span>,</span><br><span class="line">                              <span class="string">&quot;\&quot;%s\&quot; has unsupported e_shentsize 0x%x (expected 0x%zx)&quot;</span>,</span><br><span class="line">                              name_.<span class="built_in">c_str</span>(), header_.e_shentsize, <span class="built_in">sizeof</span>(<span class="built_in">ElfW</span>(Shdr)));</span><br><span class="line">    <span class="built_in">add_dlwarning</span>(name_.<span class="built_in">c_str</span>(), <span class="string">&quot;has invalid ELF header&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (header_.e_shstrndx == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">get_application_target_sdk_version</span>() &gt;= __ANDROID_API_O__) &#123;</span><br><span class="line">      <span class="built_in">DL_ERR_AND_LOG</span>(<span class="string">&quot;\&quot;%s\&quot; has invalid e_shstrndx&quot;</span>, name_.<span class="built_in">c_str</span>());</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">DL_WARN_documented_change</span>(__ANDROID_API_O__,</span><br><span class="line">                              <span class="string">&quot;invalid-elf-header_section-headers-enforced-for-api-level-26&quot;</span>,</span><br><span class="line">                              <span class="string">&quot;\&quot;%s\&quot; has invalid e_shstrndx&quot;</span>, name_.<span class="built_in">c_str</span>());</span><br><span class="line">    <span class="built_in">add_dlwarning</span>(name_.<span class="built_in">c_str</span>(), <span class="string">&quot;has invalid ELF header&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>ElfReader::ReadProgramHeaders<br>读取 ELF 头的程序头表 偏移量（e_phoff）和表项数量（e_phnum），检查有效性<br>将程序头表映射到内存中</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// http://androidxref.com/9.0.0_r3/xref/bionic/linker/linker_phdr.cpp#312</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">ElfReader::ReadProgramHeaders</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  phdr_num_ = header_.e_phnum;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (phdr_num_ &lt; <span class="number">1</span> || phdr_num_ &gt; <span class="number">65536</span>/<span class="built_in">sizeof</span>(<span class="built_in">ElfW</span>(Phdr))) &#123;</span><br><span class="line">    <span class="built_in">DL_ERR</span>(<span class="string">&quot;\&quot;%s\&quot; has invalid e_phnum: %zd&quot;</span>, name_.<span class="built_in">c_str</span>(), phdr_num_);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="type">size_t</span> size = phdr_num_ * <span class="built_in">sizeof</span>(<span class="built_in">ElfW</span>(Phdr));</span><br><span class="line">  <span class="keyword">if</span> (!<span class="built_in">CheckFileRange</span>(header_.e_phoff, size, <span class="built_in">alignof</span>(<span class="built_in">ElfW</span>(Phdr)))) &#123;</span><br><span class="line">    <span class="built_in">DL_ERR_AND_LOG</span>(<span class="string">&quot;\&quot;%s\&quot; has invalid phdr offset/size: %zu/%zu&quot;</span>,</span><br><span class="line">                   name_.<span class="built_in">c_str</span>(),</span><br><span class="line">                   <span class="built_in">static_cast</span>&lt;<span class="type">size_t</span>&gt;(header_.e_phoff),</span><br><span class="line">                   size);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!phdr_fragment_.<span class="built_in">Map</span>(fd_, file_offset_, header_.e_phoff, size)) &#123;</span><br><span class="line">    <span class="built_in">DL_ERR</span>(<span class="string">&quot;\&quot;%s\&quot; phdr mmap failed: %s&quot;</span>, name_.<span class="built_in">c_str</span>(), <span class="built_in">strerror</span>(errno));</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  phdr_table_ = <span class="built_in">static_cast</span>&lt;<span class="built_in">ElfW</span>(Phdr)*&gt;(phdr_fragment_.<span class="built_in">data</span>());</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>ElfReader::ReadSectionHeaders<br>读取 ELF 头的节头表 偏移量（e_shoff）和表项数量（e_shnum），检查有效性<br>将节头表映射到内存中</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// http://androidxref.com/9.0.0_r3/xref/bionic/linker/linker_phdr.cpp#341</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">ElfReader::ReadSectionHeaders</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  shdr_num_ = header_.e_shnum;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (shdr_num_ == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="built_in">DL_ERR_AND_LOG</span>(<span class="string">&quot;\&quot;%s\&quot; has no section headers&quot;</span>, name_.<span class="built_in">c_str</span>());</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="type">size_t</span> size = shdr_num_ * <span class="built_in">sizeof</span>(<span class="built_in">ElfW</span>(Shdr));</span><br><span class="line">  <span class="keyword">if</span> (!<span class="built_in">CheckFileRange</span>(header_.e_shoff, size, <span class="built_in">alignof</span>(<span class="type">const</span> <span class="built_in">ElfW</span>(Shdr)))) &#123;</span><br><span class="line">    <span class="built_in">DL_ERR_AND_LOG</span>(<span class="string">&quot;\&quot;%s\&quot; has invalid shdr offset/size: %zu/%zu&quot;</span>,</span><br><span class="line">                   name_.<span class="built_in">c_str</span>(),</span><br><span class="line">                   <span class="built_in">static_cast</span>&lt;<span class="type">size_t</span>&gt;(header_.e_shoff),</span><br><span class="line">                   size);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!shdr_fragment_.<span class="built_in">Map</span>(fd_, file_offset_, header_.e_shoff, size)) &#123;</span><br><span class="line">    <span class="built_in">DL_ERR</span>(<span class="string">&quot;\&quot;%s\&quot; shdr mmap failed: %s&quot;</span>, name_.<span class="built_in">c_str</span>(), <span class="built_in">strerror</span>(errno));</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  shdr_table_ = <span class="built_in">static_cast</span>&lt;<span class="type">const</span> <span class="built_in">ElfW</span>(Shdr)*&gt;(shdr_fragment_.<span class="built_in">data</span>());</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>ElfReader::ReadDynamicSection<br>在节头表中查找类型为 SHT_DYNAMIC 的节（.dynamic 节）<br>检查 .dynamic 节的偏移量和大小是否与程序头表中的 PT_DYNAMIC 段一致<br>检查 .dynamic 节的 sh_link 是否指向有效的 .dynstr 节<br>将 .dynamic 节映射到内存中<br>将 .dynstr 节映射到内存中</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// http://androidxref.com/9.0.0_r3/xref/bionic/linker/linker_phdr.cpp#367</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">ElfReader::ReadDynamicSection</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="comment">// </span></span><br><span class="line">  <span class="function"><span class="type">const</span> <span class="title">ElfW</span><span class="params">(Shdr)</span>* dynamic_shdr </span>= <span class="literal">nullptr</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; shdr_num_; ++i) &#123;</span><br><span class="line">    <span class="keyword">if</span> (shdr_table_[i].sh_type == SHT_DYNAMIC) &#123;</span><br><span class="line">      dynamic_shdr = &amp;shdr_table_ [i];</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  <span class="comment">// </span></span><br><span class="line">  <span class="type">size_t</span> pt_dynamic_offset = <span class="number">0</span>;</span><br><span class="line">  <span class="type">size_t</span> pt_dynamic_filesz = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; phdr_num_; ++i) &#123;</span><br><span class="line">    <span class="function"><span class="type">const</span> <span class="title">ElfW</span><span class="params">(Phdr)</span>* phdr </span>= &amp;phdr_table_[i];</span><br><span class="line">    <span class="keyword">if</span> (phdr-&gt;p_type == PT_DYNAMIC) &#123;</span><br><span class="line">      pt_dynamic_offset = phdr-&gt;p_offset;</span><br><span class="line">      pt_dynamic_filesz = phdr-&gt;p_filesz;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (pt_dynamic_offset != dynamic_shdr-&gt;sh_offset) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">get_application_target_sdk_version</span>() &gt;= __ANDROID_API_O__) &#123;</span><br><span class="line">      <span class="built_in">DL_ERR_AND_LOG</span>(<span class="string">&quot;\&quot;%s\&quot; .dynamic section has invalid offset: 0x%zx, &quot;</span></span><br><span class="line">                     <span class="string">&quot;expected to match PT_DYNAMIC offset: 0x%zx&quot;</span>,</span><br><span class="line">                     name_.<span class="built_in">c_str</span>(),</span><br><span class="line">                     <span class="built_in">static_cast</span>&lt;<span class="type">size_t</span>&gt;(dynamic_shdr-&gt;sh_offset),</span><br><span class="line">                     pt_dynamic_offset);</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">DL_WARN_documented_change</span>(__ANDROID_API_O__,</span><br><span class="line">                              <span class="string">&quot;invalid-elf-header_section-headers-enforced-for-api-level-26&quot;</span>,</span><br><span class="line">                              <span class="string">&quot;\&quot;%s\&quot; .dynamic section has invalid offset: 0x%zx &quot;</span></span><br><span class="line">                              <span class="string">&quot;(expected to match PT_DYNAMIC offset 0x%zx)&quot;</span>,</span><br><span class="line">                              name_.<span class="built_in">c_str</span>(),</span><br><span class="line">                              <span class="built_in">static_cast</span>&lt;<span class="type">size_t</span>&gt;(dynamic_shdr-&gt;sh_offset),</span><br><span class="line">                              pt_dynamic_offset);</span><br><span class="line">    <span class="built_in">add_dlwarning</span>(name_.<span class="built_in">c_str</span>(), <span class="string">&quot;invalid .dynamic section&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (pt_dynamic_filesz != dynamic_shdr-&gt;sh_size) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">get_application_target_sdk_version</span>() &gt;= __ANDROID_API_O__) &#123;</span><br><span class="line">      <span class="built_in">DL_ERR_AND_LOG</span>(<span class="string">&quot;\&quot;%s\&quot; .dynamic section has invalid size: 0x%zx, &quot;</span></span><br><span class="line">                     <span class="string">&quot;expected to match PT_DYNAMIC filesz: 0x%zx&quot;</span>,</span><br><span class="line">                     name_.<span class="built_in">c_str</span>(),</span><br><span class="line">                     <span class="built_in">static_cast</span>&lt;<span class="type">size_t</span>&gt;(dynamic_shdr-&gt;sh_size),</span><br><span class="line">                     pt_dynamic_filesz);</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">DL_WARN_documented_change</span>(__ANDROID_API_O__,</span><br><span class="line">                              <span class="string">&quot;invalid-elf-header_section-headers-enforced-for-api-level-26&quot;</span>,</span><br><span class="line">                              <span class="string">&quot;\&quot;%s\&quot; .dynamic section has invalid size: 0x%zx &quot;</span></span><br><span class="line">                              <span class="string">&quot;(expected to match PT_DYNAMIC filesz 0x%zx)&quot;</span>,</span><br><span class="line">                              name_.<span class="built_in">c_str</span>(),</span><br><span class="line">                              <span class="built_in">static_cast</span>&lt;<span class="type">size_t</span>&gt;(dynamic_shdr-&gt;sh_size),</span><br><span class="line">                              pt_dynamic_filesz);</span><br><span class="line">    <span class="built_in">add_dlwarning</span>(name_.<span class="built_in">c_str</span>(), <span class="string">&quot;invalid .dynamic section&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//</span></span><br><span class="line">  <span class="keyword">if</span> (dynamic_shdr-&gt;sh_link &gt;= shdr_num_) &#123;</span><br><span class="line">    <span class="built_in">DL_ERR_AND_LOG</span>(<span class="string">&quot;\&quot;%s\&quot; .dynamic section has invalid sh_link: %d&quot;</span>,</span><br><span class="line">                   name_.<span class="built_in">c_str</span>(),</span><br><span class="line">                   dynamic_shdr-&gt;sh_link);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="type">const</span> <span class="title">ElfW</span><span class="params">(Shdr)</span>* strtab_shdr </span>= &amp;shdr_table_[dynamic_shdr-&gt;sh_link];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (strtab_shdr-&gt;sh_type != SHT_STRTAB) &#123;</span><br><span class="line">    <span class="built_in">DL_ERR_AND_LOG</span>(<span class="string">&quot;\&quot;%s\&quot; .dynamic section has invalid link(%d) sh_type: %d (expected SHT_STRTAB)&quot;</span>,</span><br><span class="line">                   name_.<span class="built_in">c_str</span>(), dynamic_shdr-&gt;sh_link, strtab_shdr-&gt;sh_type);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  <span class="comment">//</span></span><br><span class="line">  <span class="keyword">if</span> (!dynamic_fragment_.<span class="built_in">Map</span>(fd_, file_offset_, dynamic_shdr-&gt;sh_offset, dynamic_shdr-&gt;sh_size)) &#123;</span><br><span class="line">    <span class="built_in">DL_ERR</span>(<span class="string">&quot;\&quot;%s\&quot; dynamic section mmap failed: %s&quot;</span>, name_.<span class="built_in">c_str</span>(), <span class="built_in">strerror</span>(errno));</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  <span class="comment">//</span></span><br><span class="line">  <span class="keyword">if</span> (!strtab_fragment_.<span class="built_in">Map</span>(fd_, file_offset_, strtab_shdr-&gt;sh_offset, strtab_shdr-&gt;sh_size)) &#123;</span><br><span class="line">    <span class="built_in">DL_ERR</span>(<span class="string">&quot;\&quot;%s\&quot; strtab section mmap failed: %s&quot;</span>, name_.<span class="built_in">c_str</span>(), <span class="built_in">strerror</span>(errno));</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<h4 id="for-each-dt-needed"><a href="#for-each-dt-needed" class="headerlink" title="for_each_dt_needed"></a>for_each_dt_needed</h4><p>负责依赖项的处理<br>通过遍历 .dynamic 节中的 DT_NEEDED 条目，将每个依赖库添加到 load_tasks 列表</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// http://androidxref.com/9.0.0_r3/xref/bionic/linker/linker.cpp#1127</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> F&gt;</span></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">for_each_dt_needed</span><span class="params">(<span class="type">const</span> ElfReader&amp; elf_reader, F action)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">const</span> <span class="built_in">ElfW</span>(Dyn)* d = elf_reader.<span class="built_in">dynamic</span>(); d-&gt;d_tag != DT_NULL; ++d) &#123;</span><br><span class="line">    <span class="keyword">if</span> (d-&gt;d_tag == DT_NEEDED) &#123;</span><br><span class="line">      <span class="built_in">action</span>(<span class="built_in">fix_dt_needed</span>(elf_reader.<span class="built_in">get_string</span>(d-&gt;d_un.d_val), elf_reader.<span class="built_in">name</span>()));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="LoadTask-load"><a href="#LoadTask-load" class="headerlink" title="LoadTask.load"></a>LoadTask.load</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// http://androidxref.com/9.0.0_r3/xref/bionic/linker/linker.cpp#559</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">LoadTask</span> &#123;</span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="type">bool</span> <span class="title">load</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    ElfReader&amp; elf_reader = <span class="built_in">get_elf_reader</span>();</span><br><span class="line">    <span class="keyword">if</span> (!elf_reader.<span class="built_in">Load</span>(extinfo_)) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    si_-&gt;base = elf_reader.<span class="built_in">load_start</span>();</span><br><span class="line">    si_-&gt;size = elf_reader.<span class="built_in">load_size</span>();</span><br><span class="line">    si_-&gt;<span class="built_in">set_mapped_by_caller</span>(elf_reader.<span class="built_in">is_mapped_by_caller</span>());</span><br><span class="line">    si_-&gt;load_bias = elf_reader.<span class="built_in">load_bias</span>();</span><br><span class="line">    si_-&gt;phnum = elf_reader.<span class="built_in">phdr_count</span>();</span><br><span class="line">    si_-&gt;phdr = elf_reader.<span class="built_in">loaded_phdr</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"> ...</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="ElfReader-Load"><a href="#ElfReader-Load" class="headerlink" title="ElfReader::Load"></a>ElfReader::Load</h3><p>负责执行实际的 装载操作，共分为三个步骤</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// http://androidxref.com/9.0.0_r3/xref/bionic/linker/linker_phdr.cpp#169</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">ElfReader::Load</span><span class="params">(<span class="type">const</span> android_dlextinfo* extinfo)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">CHECK</span>(did_read_);</span><br><span class="line">  <span class="keyword">if</span> (did_load_) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">ReserveAddressSpace</span>(extinfo) &amp;&amp;</span><br><span class="line">      <span class="built_in">LoadSegments</span>() &amp;&amp;</span><br><span class="line">      <span class="built_in">FindPhdr</span>()) &#123;</span><br><span class="line">    did_load_ = <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> did_load_;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li><p>ElfReader::ReserveAddressSpace<br>计算 ELF 文件中所有 PT_LOAD 段的总大小<br>为其预留内存空间</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// http://androidxref.com/9.0.0_r3/xref/bionic/linker/linker_phdr.cpp#560</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">ElfReader::ReserveAddressSpace</span><span class="params">(<span class="type">const</span> android_dlextinfo* extinfo)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">ElfW</span>(Addr) min_vaddr;</span><br><span class="line">  load_size_ = <span class="built_in">phdr_table_get_load_size</span>(phdr_table_, phdr_num_, &amp;min_vaddr);</span><br><span class="line">  <span class="keyword">if</span> (load_size_ == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="built_in">DL_ERR</span>(<span class="string">&quot;\&quot;%s\&quot; has no loadable segments&quot;</span>, name_.<span class="built_in">c_str</span>());</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="type">uint8_t</span>* addr = <span class="built_in">reinterpret_cast</span>&lt;<span class="type">uint8_t</span>*&gt;(min_vaddr);</span><br><span class="line">  <span class="type">void</span>* start;</span><br><span class="line">  <span class="type">size_t</span> reserved_size = <span class="number">0</span>;</span><br><span class="line">  <span class="type">bool</span> reserved_hint = <span class="literal">true</span>;</span><br><span class="line">  <span class="type">bool</span> strict_hint = <span class="literal">false</span>;</span><br><span class="line">  <span class="type">void</span>* mmap_hint = <span class="literal">nullptr</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (extinfo != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (extinfo-&gt;flags &amp; ANDROID_DLEXT_RESERVED_ADDRESS) &#123;</span><br><span class="line">      reserved_size = extinfo-&gt;reserved_size;</span><br><span class="line">      reserved_hint = <span class="literal">false</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (extinfo-&gt;flags &amp; ANDROID_DLEXT_RESERVED_ADDRESS_HINT) &#123;</span><br><span class="line">      reserved_size = extinfo-&gt;reserved_size;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (addr != <span class="literal">nullptr</span> &amp;&amp; (extinfo-&gt;flags &amp; ANDROID_DLEXT_FORCE_FIXED_VADDR) != <span class="number">0</span>) &#123;</span><br><span class="line">      mmap_hint = addr;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((extinfo-&gt;flags &amp; ANDROID_DLEXT_LOAD_AT_FIXED_ADDRESS) != <span class="number">0</span>) &#123;</span><br><span class="line">      mmap_hint = extinfo-&gt;reserved_addr;</span><br><span class="line">      strict_hint = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (load_size_ &gt; reserved_size) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!reserved_hint) &#123;</span><br><span class="line">      <span class="built_in">DL_ERR</span>(<span class="string">&quot;reserved address space %zd smaller than %zd bytes needed for \&quot;%s\&quot;&quot;</span>,</span><br><span class="line">             reserved_size - load_size_, load_size_, name_.<span class="built_in">c_str</span>());</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    start = <span class="built_in">ReserveAligned</span>(mmap_hint, load_size_, kLibraryAlignment);</span><br><span class="line">    <span class="keyword">if</span> (start == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">      <span class="built_in">DL_ERR</span>(<span class="string">&quot;couldn&#x27;t reserve %zd bytes of address space for \&quot;%s\&quot;&quot;</span>, load_size_, name_.<span class="built_in">c_str</span>());</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (strict_hint &amp;&amp; (start != mmap_hint)) &#123;</span><br><span class="line">      <span class="built_in">munmap</span>(start, load_size_);</span><br><span class="line">      <span class="built_in">DL_ERR</span>(<span class="string">&quot;couldn&#x27;t reserve %zd bytes of address space at %p for \&quot;%s\&quot;&quot;</span>,</span><br><span class="line">             load_size_, mmap_hint, name_.<span class="built_in">c_str</span>());</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    start = extinfo-&gt;reserved_addr;</span><br><span class="line">    mapped_by_caller_ = <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  load_start_ = start;</span><br><span class="line">  load_bias_ = <span class="built_in">reinterpret_cast</span>&lt;<span class="type">uint8_t</span>*&gt;(start) - addr;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>ElfReader::LoadSegments<br>在程序头表中寻找 PT_LOAD 段，计算其在内存中的起始和结束地址<br>将 PT_LOAD 段映射到内存中</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// http://androidxref.com/9.0.0_r3/xref/bionic/linker/linker_phdr.cpp#619</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">ElfReader::LoadSegments</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; phdr_num_; ++i) &#123;</span><br><span class="line">    <span class="function"><span class="type">const</span> <span class="title">ElfW</span><span class="params">(Phdr)</span>* phdr </span>= &amp;phdr_table_[i];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (phdr-&gt;p_type != PT_LOAD) &#123;</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">ElfW</span>(Addr) seg_start = phdr-&gt;p_vaddr + load_bias_;</span><br><span class="line">    <span class="built_in">ElfW</span>(Addr) seg_end   = seg_start + phdr-&gt;p_memsz;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">ElfW</span>(Addr) seg_page_start = <span class="built_in">PAGE_START</span>(seg_start);</span><br><span class="line">    <span class="built_in">ElfW</span>(Addr) seg_page_end   = <span class="built_in">PAGE_END</span>(seg_end);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">ElfW</span>(Addr) seg_file_end   = seg_start + phdr-&gt;p_filesz;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">ElfW</span>(Addr) file_start = phdr-&gt;p_offset;</span><br><span class="line">    <span class="built_in">ElfW</span>(Addr) file_end   = file_start + phdr-&gt;p_filesz;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">ElfW</span>(Addr) file_page_start = <span class="built_in">PAGE_START</span>(file_start);</span><br><span class="line">    <span class="built_in">ElfW</span>(Addr) file_length = file_end - file_page_start;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (file_length != <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="type">int</span> prot = <span class="built_in">PFLAGS_TO_PROT</span>(phdr-&gt;p_flags);</span><br><span class="line">      ...</span><br><span class="line"></span><br><span class="line">      <span class="type">void</span>* seg_addr = <span class="built_in">mmap64</span>(<span class="built_in">reinterpret_cast</span>&lt;<span class="type">void</span>*&gt;(seg_page_start),</span><br><span class="line">                            file_length,</span><br><span class="line">                            prot,</span><br><span class="line">                            MAP_FIXED|MAP_PRIVATE,</span><br><span class="line">                            fd_,</span><br><span class="line">                            file_offset_ + file_page_start);</span><br><span class="line">      <span class="keyword">if</span> (seg_addr == MAP_FAILED) &#123;</span><br><span class="line">        <span class="built_in">DL_ERR</span>(<span class="string">&quot;couldn&#x27;t map \&quot;%s\&quot; segment %zd: %s&quot;</span>, name_.<span class="built_in">c_str</span>(), i, <span class="built_in">strerror</span>(errno));</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>ElfReader::FindPhdr<br>利用 PT_PHDR 段来定位程序头表的地址<br>如果没有找到，则尝试从第一个文件偏移量为0的 PT_LOAD 段推断出程序头表的地址</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// http://androidxref.com/9.0.0_r3/xref/bionic/linker/linker_phdr.cpp#1077</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">ElfReader::FindPhdr</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="type">const</span> <span class="title">ElfW</span><span class="params">(Phdr)</span>* phdr_limit </span>= phdr_table_ + phdr_num_;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">const</span> <span class="built_in">ElfW</span>(Phdr)* phdr = phdr_table_; phdr &lt; phdr_limit; ++phdr) &#123;</span><br><span class="line">    <span class="keyword">if</span> (phdr-&gt;p_type == PT_PHDR) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">CheckPhdr</span>(load_bias_ + phdr-&gt;p_vaddr);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">const</span> <span class="built_in">ElfW</span>(Phdr)* phdr = phdr_table_; phdr &lt; phdr_limit; ++phdr) &#123;</span><br><span class="line">    <span class="keyword">if</span> (phdr-&gt;p_type == PT_LOAD) &#123;</span><br><span class="line">      <span class="keyword">if</span> (phdr-&gt;p_offset == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">ElfW</span>(Addr)  elf_addr = load_bias_ + phdr-&gt;p_vaddr;</span><br><span class="line">        <span class="function"><span class="type">const</span> <span class="title">ElfW</span><span class="params">(Ehdr)</span>* ehdr </span>= <span class="built_in">reinterpret_cast</span>&lt;<span class="function"><span class="type">const</span> <span class="title">ElfW</span><span class="params">(Ehdr)</span>*&gt;<span class="params">(elf_addr)</span></span>;</span><br><span class="line">        <span class="built_in">ElfW</span>(Addr)  offset = ehdr-&gt;e_phoff;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">CheckPhdr</span>(<span class="built_in">reinterpret_cast</span>&lt;<span class="built_in">ElfW</span>(Addr)&gt;(ehdr) + offset);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">DL_ERR</span>(<span class="string">&quot;can&#x27;t find loaded phdr for \&quot;%s\&quot;&quot;</span>, name_.<span class="built_in">c_str</span>());</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="soinfo-prelink-image"><a href="#soinfo-prelink-image" class="headerlink" title="soinfo::prelink_image"></a>soinfo::prelink_image</h2><p>负责链接前期的 数据解析<br>通过遍历 .dynamic 节表项的条目（Elf64_Dyn-&gt;d_tag），解析各节的数据（.hash, .dynsym, .dynstr, .rela.dyn, .rela.plt, .init_array…）并存入 soinfo 各成员变量</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// http://androidxref.com/9.0.0_r3/xref/bionic/linker/linker.cpp#3052</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">soinfo::prelink_image</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="built_in">ElfW</span>(Word) dynamic_flags = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">phdr_table_get_dynamic_section</span>(phdr, phnum, load_bias, &amp;dynamic, &amp;dynamic_flags);</span><br><span class="line"></span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  <span class="type">uint32_t</span> needed_count = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="built_in">ElfW</span>(Dyn)* d = dynamic; d-&gt;d_tag != DT_NULL; ++d) &#123;</span><br><span class="line">    <span class="built_in">DEBUG</span>(<span class="string">&quot;d = %p, d[0](tag) = %p d[1](val) = %p&quot;</span>,</span><br><span class="line">          d, <span class="built_in">reinterpret_cast</span>&lt;<span class="type">void</span>*&gt;(d-&gt;d_tag), <span class="built_in">reinterpret_cast</span>&lt;<span class="type">void</span>*&gt;(d-&gt;d_un.d_val));</span><br><span class="line">    <span class="keyword">switch</span> (d-&gt;d_tag) &#123;</span><br><span class="line">      <span class="keyword">case</span> DT_SONAME:</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">case</span> DT_HASH:</span><br><span class="line">        nbucket_ = <span class="built_in">reinterpret_cast</span>&lt;<span class="type">uint32_t</span>*&gt;(load_bias + d-&gt;d_un.d_ptr)[<span class="number">0</span>];</span><br><span class="line">        nchain_ = <span class="built_in">reinterpret_cast</span>&lt;<span class="type">uint32_t</span>*&gt;(load_bias + d-&gt;d_un.d_ptr)[<span class="number">1</span>];</span><br><span class="line">        bucket_ = <span class="built_in">reinterpret_cast</span>&lt;<span class="type">uint32_t</span>*&gt;(load_bias + d-&gt;d_un.d_ptr + <span class="number">8</span>);</span><br><span class="line">        chain_ = <span class="built_in">reinterpret_cast</span>&lt;<span class="type">uint32_t</span>*&gt;(load_bias + d-&gt;d_un.d_ptr + <span class="number">8</span> + nbucket_ * <span class="number">4</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">case</span> DT_GNU_HASH:</span><br><span class="line">        gnu_nbucket_ = <span class="built_in">reinterpret_cast</span>&lt;<span class="type">uint32_t</span>*&gt;(load_bias + d-&gt;d_un.d_ptr)[<span class="number">0</span>];</span><br><span class="line">        gnu_maskwords_ = <span class="built_in">reinterpret_cast</span>&lt;<span class="type">uint32_t</span>*&gt;(load_bias + d-&gt;d_un.d_ptr)[<span class="number">2</span>];</span><br><span class="line">        gnu_shift2_ = <span class="built_in">reinterpret_cast</span>&lt;<span class="type">uint32_t</span>*&gt;(load_bias + d-&gt;d_un.d_ptr)[<span class="number">3</span>];</span><br><span class="line"></span><br><span class="line">        gnu_bloom_filter_ = <span class="built_in">reinterpret_cast</span>&lt;<span class="built_in">ElfW</span>(Addr)*&gt;(load_bias + d-&gt;d_un.d_ptr + <span class="number">16</span>);</span><br><span class="line">        gnu_bucket_ = <span class="built_in">reinterpret_cast</span>&lt;<span class="type">uint32_t</span>*&gt;(gnu_bloom_filter_ + gnu_maskwords_);</span><br><span class="line">        gnu_chain_ = gnu_bucket_ + gnu_nbucket_ -</span><br><span class="line">            <span class="built_in">reinterpret_cast</span>&lt;<span class="type">uint32_t</span>*&gt;(load_bias + d-&gt;d_un.d_ptr)[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">powerof2</span>(gnu_maskwords_)) &#123;</span><br><span class="line">          <span class="built_in">DL_ERR</span>(<span class="string">&quot;invalid maskwords for gnu_hash = 0x%x, in \&quot;%s\&quot; expecting power to two&quot;</span>,</span><br><span class="line">              gnu_maskwords_, <span class="built_in">get_realpath</span>());</span><br><span class="line">          <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        --gnu_maskwords_;</span><br><span class="line"></span><br><span class="line">        flags_ |= FLAG_GNU_HASH;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">case</span> DT_STRTAB:</span><br><span class="line">        strtab_ = <span class="built_in">reinterpret_cast</span>&lt;<span class="type">const</span> <span class="type">char</span>*&gt;(load_bias + d-&gt;d_un.d_ptr);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">case</span> DT_STRSZ:</span><br><span class="line">        strtab_size_ = d-&gt;d_un.d_val;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">case</span> DT_SYMTAB:</span><br><span class="line">        symtab_ = <span class="built_in">reinterpret_cast</span>&lt;<span class="built_in">ElfW</span>(Sym)*&gt;(load_bias + d-&gt;d_un.d_ptr);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">case</span> DT_SYMENT:</span><br><span class="line">        <span class="keyword">if</span> (d-&gt;d_un.d_val != <span class="built_in">sizeof</span>(<span class="built_in">ElfW</span>(Sym))) &#123;</span><br><span class="line">          <span class="built_in">DL_ERR</span>(<span class="string">&quot;invalid DT_SYMENT: %zd in \&quot;%s\&quot;&quot;</span>,</span><br><span class="line">              <span class="built_in">static_cast</span>&lt;<span class="type">size_t</span>&gt;(d-&gt;d_un.d_val), <span class="built_in">get_realpath</span>());</span><br><span class="line">          <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">case</span> DT_PLTREL:</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(USE_RELA)</span></span><br><span class="line">        <span class="keyword">if</span> (d-&gt;d_un.d_val != DT_RELA) &#123;</span><br><span class="line">          <span class="built_in">DL_ERR</span>(<span class="string">&quot;unsupported DT_PLTREL in \&quot;%s\&quot;; expected DT_RELA&quot;</span>, <span class="built_in">get_realpath</span>());</span><br><span class="line">          <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">        <span class="keyword">if</span> (d-&gt;d_un.d_val != DT_REL) &#123;</span><br><span class="line">          <span class="built_in">DL_ERR</span>(<span class="string">&quot;unsupported DT_PLTREL in \&quot;%s\&quot;; expected DT_REL&quot;</span>, <span class="built_in">get_realpath</span>());</span><br><span class="line">          <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">case</span> DT_JMPREL:</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(USE_RELA)</span></span><br><span class="line">        plt_rela_ = <span class="built_in">reinterpret_cast</span>&lt;<span class="built_in">ElfW</span>(Rela)*&gt;(load_bias + d-&gt;d_un.d_ptr);</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">        plt_rel_ = <span class="built_in">reinterpret_cast</span>&lt;<span class="built_in">ElfW</span>(Rel)*&gt;(load_bias + d-&gt;d_un.d_ptr);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">case</span> DT_PLTRELSZ:</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(USE_RELA)</span></span><br><span class="line">        plt_rela_count_ = d-&gt;d_un.d_val / <span class="built_in">sizeof</span>(<span class="built_in">ElfW</span>(Rela));</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">        plt_rel_count_ = d-&gt;d_un.d_val / <span class="built_in">sizeof</span>(<span class="built_in">ElfW</span>(Rel));</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">      ...</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(USE_RELA)</span></span><br><span class="line">      <span class="keyword">case</span> DT_RELA:</span><br><span class="line">        rela_ = <span class="built_in">reinterpret_cast</span>&lt;<span class="built_in">ElfW</span>(Rela)*&gt;(load_bias + d-&gt;d_un.d_ptr);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">case</span> DT_RELASZ:</span><br><span class="line">        rela_count_ = d-&gt;d_un.d_val / <span class="built_in">sizeof</span>(<span class="built_in">ElfW</span>(Rela));</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">      ...</span><br><span class="line"></span><br><span class="line">      <span class="keyword">case</span> DT_RELAENT:</span><br><span class="line">        <span class="keyword">if</span> (d-&gt;d_un.d_val != <span class="built_in">sizeof</span>(<span class="built_in">ElfW</span>(Rela))) &#123;</span><br><span class="line">          <span class="built_in">DL_ERR</span>(<span class="string">&quot;invalid DT_RELAENT: %zd&quot;</span>, <span class="built_in">static_cast</span>&lt;<span class="type">size_t</span>&gt;(d-&gt;d_un.d_val));</span><br><span class="line">          <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">case</span> DT_RELACOUNT:</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">case</span> DT_REL:</span><br><span class="line">        <span class="built_in">DL_ERR</span>(<span class="string">&quot;unsupported DT_REL in \&quot;%s\&quot;&quot;</span>, <span class="built_in">get_realpath</span>());</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">case</span> DT_RELSZ:</span><br><span class="line">        <span class="built_in">DL_ERR</span>(<span class="string">&quot;unsupported DT_RELSZ in \&quot;%s\&quot;&quot;</span>, <span class="built_in">get_realpath</span>());</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">      ...</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">      <span class="keyword">case</span> DT_RELR:</span><br><span class="line">        relr_ = <span class="built_in">reinterpret_cast</span>&lt;<span class="built_in">ElfW</span>(Relr)*&gt;(load_bias + d-&gt;d_un.d_ptr);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">case</span> DT_RELRSZ:</span><br><span class="line">        relr_count_ = d-&gt;d_un.d_val / <span class="built_in">sizeof</span>(<span class="built_in">ElfW</span>(Relr));</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">case</span> DT_RELRENT:</span><br><span class="line">        <span class="keyword">if</span> (d-&gt;d_un.d_val != <span class="built_in">sizeof</span>(<span class="built_in">ElfW</span>(Relr))) &#123;</span><br><span class="line">          <span class="built_in">DL_ERR</span>(<span class="string">&quot;invalid DT_RELRENT: %zd&quot;</span>, <span class="built_in">static_cast</span>&lt;<span class="type">size_t</span>&gt;(d-&gt;d_un.d_val));</span><br><span class="line">          <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">case</span> DT_RELRCOUNT:</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">case</span> DT_INIT:</span><br><span class="line">        init_func_ = <span class="built_in">reinterpret_cast</span>&lt;<span class="type">linker_ctor_function_t</span>&gt;(load_bias + d-&gt;d_un.d_ptr);</span><br><span class="line">        <span class="built_in">DEBUG</span>(<span class="string">&quot;%s constructors (DT_INIT) found at %p&quot;</span>, <span class="built_in">get_realpath</span>(), init_func_);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">case</span> DT_FINI:</span><br><span class="line">        fini_func_ = <span class="built_in">reinterpret_cast</span>&lt;<span class="type">linker_dtor_function_t</span>&gt;(load_bias + d-&gt;d_un.d_ptr);</span><br><span class="line">        <span class="built_in">DEBUG</span>(<span class="string">&quot;%s destructors (DT_FINI) found at %p&quot;</span>, <span class="built_in">get_realpath</span>(), fini_func_);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">case</span> DT_INIT_ARRAY:</span><br><span class="line">        init_array_ = <span class="built_in">reinterpret_cast</span>&lt;<span class="type">linker_ctor_function_t</span>*&gt;(load_bias + d-&gt;d_un.d_ptr);</span><br><span class="line">        <span class="built_in">DEBUG</span>(<span class="string">&quot;%s constructors (DT_INIT_ARRAY) found at %p&quot;</span>, <span class="built_in">get_realpath</span>(), init_array_);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">case</span> DT_INIT_ARRAYSZ:</span><br><span class="line">        init_array_count_ = <span class="built_in">static_cast</span>&lt;<span class="type">uint32_t</span>&gt;(d-&gt;d_un.d_val) / <span class="built_in">sizeof</span>(<span class="built_in">ElfW</span>(Addr));</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">      ...</span><br><span class="line"></span><br><span class="line">      <span class="keyword">case</span> DT_TEXTREL:</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(__LP64__)</span></span><br><span class="line">        <span class="built_in">DL_ERR</span>(<span class="string">&quot;\&quot;%s\&quot; has text relocations&quot;</span>, <span class="built_in">get_realpath</span>());</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">        has_text_relocations = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">case</span> DT_SYMBOLIC:</span><br><span class="line">        has_DT_SYMBOLIC = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">case</span> DT_NEEDED:</span><br><span class="line">        ++needed_count;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">case</span> DT_FLAGS:</span><br><span class="line">        <span class="keyword">if</span> (d-&gt;d_un.d_val &amp; DF_TEXTREL) &#123;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(__LP64__)</span></span><br><span class="line">          <span class="built_in">DL_ERR</span>(<span class="string">&quot;\&quot;%s\&quot; has text relocations&quot;</span>, <span class="built_in">get_realpath</span>());</span><br><span class="line">          <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">          has_text_relocations = <span class="literal">true</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (d-&gt;d_un.d_val &amp; DF_SYMBOLIC) &#123;</span><br><span class="line">          has_DT_SYMBOLIC = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="soinfo-link-image"><a href="#soinfo-link-image" class="headerlink" title="soinfo::link_image"></a>soinfo::link_image</h2><p>负责链接后期的 地址重定位<br>分别将 .rela.dyn, .rela.plt 节表项的条目（Elf64_Rela-&gt;r_info）传入 relocate</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// http://androidxref.com/9.0.0_r3/xref/bionic/linker/linker.cpp#3536</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">soinfo::link_image</span><span class="params">(<span class="type">const</span> <span class="type">soinfo_list_t</span>&amp; global_group, <span class="type">const</span> <span class="type">soinfo_list_t</span>&amp; local_group,</span></span></span><br><span class="line"><span class="params"><span class="function">                        <span class="type">const</span> android_dlextinfo* extinfo)</span> </span>&#123;</span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(USE_RELA)</span></span><br><span class="line">  <span class="keyword">if</span> (rela_ != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">    <span class="built_in">DEBUG</span>(<span class="string">&quot;[ relocating %s rela ]&quot;</span>, <span class="built_in">get_realpath</span>());</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">relocate</span>(version_tracker,</span><br><span class="line">            <span class="built_in">plain_reloc_iterator</span>(rela_, rela_count_), global_group, local_group)) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (plt_rela_ != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">    <span class="built_in">DEBUG</span>(<span class="string">&quot;[ relocating %s plt rela ]&quot;</span>, <span class="built_in">get_realpath</span>());</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">relocate</span>(version_tracker,</span><br><span class="line">            <span class="built_in">plain_reloc_iterator</span>(plt_rela_, plt_rela_count_), global_group, local_group)) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">  ...</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="soinfo-relocate"><a href="#soinfo-relocate" class="headerlink" title="soinfo::relocate"></a>soinfo::relocate</h3><p>通过遍历 .rela.dyn 或 .rela.plt 节表项的条目，先检查符号合法性，后计算并修正 .data, .got 节中的变量地址或 .got.plt 节中的函数地址<br>期间涉及的符号解析 通过读取 .dynsym, .dynstr 节实现</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// http://androidxref.com/9.0.0_r3/xref/bionic/linker/linker.cpp#2681</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">soinfo::relocate</span><span class="params">(<span class="type">const</span> VersionTracker&amp; version_tracker, ElfRelIteratorT&amp;&amp; rel_iterator,</span></span></span><br><span class="line"><span class="params"><span class="function">                      <span class="type">const</span> <span class="type">soinfo_list_t</span>&amp; global_group, <span class="type">const</span> <span class="type">soinfo_list_t</span>&amp; local_group)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">size_t</span> idx = <span class="number">0</span>; rel_iterator.<span class="built_in">has_next</span>(); ++idx) &#123;</span><br><span class="line">    <span class="type">const</span> <span class="keyword">auto</span> rel = rel_iterator.<span class="built_in">next</span>();</span><br><span class="line">    <span class="keyword">if</span> (rel == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">ElfW</span>(Word) type = <span class="built_in">ELFW</span>(R_TYPE)(rel-&gt;r_info);</span><br><span class="line">    <span class="built_in">ElfW</span>(Word) sym = <span class="built_in">ELFW</span>(R_SYM)(rel-&gt;r_info);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">ElfW</span>(Addr) reloc = <span class="built_in">static_cast</span>&lt;<span class="built_in">ElfW</span>(Addr)&gt;(rel-&gt;r_offset + load_bias);</span><br><span class="line">    <span class="built_in">ElfW</span>(Addr) sym_addr = <span class="number">0</span>;</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span>* sym_name = <span class="literal">nullptr</span>;</span><br><span class="line">    <span class="built_in">ElfW</span>(Addr) addend = <span class="built_in">get_addend</span>(rel, reloc);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">DEBUG</span>(<span class="string">&quot;Processing \&quot;%s\&quot; relocation at index %zd&quot;</span>, <span class="built_in">get_realpath</span>(), idx);</span><br><span class="line">    <span class="keyword">if</span> (type == R_GENERIC_NONE) &#123;</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">const</span> <span class="title">ElfW</span><span class="params">(Sym)</span>* s </span>= <span class="literal">nullptr</span>;</span><br><span class="line">    soinfo* lsi = <span class="literal">nullptr</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (sym != <span class="number">0</span>) &#123;</span><br><span class="line">      sym_name = <span class="built_in">get_string</span>(symtab_[sym].st_name);</span><br><span class="line">      <span class="type">const</span> version_info* vi = <span class="literal">nullptr</span>;</span><br><span class="line"></span><br><span class="line">      ...</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (s == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">        s = &amp;symtab_[sym];</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">ELF_ST_BIND</span>(s-&gt;st_info) != STB_WEAK) &#123;</span><br><span class="line">          <span class="built_in">DL_ERR</span>(<span class="string">&quot;cannot locate symbol \&quot;%s\&quot; referenced by \&quot;%s\&quot;...&quot;</span>, sym_name, <span class="built_in">get_realpath</span>());</span><br><span class="line">          <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> (type) &#123;</span><br><span class="line">          <span class="keyword">case</span> R_GENERIC_JUMP_SLOT:</span><br><span class="line">          <span class="keyword">case</span> R_GENERIC_GLOB_DAT:</span><br><span class="line">          <span class="keyword">case</span> R_GENERIC_RELATIVE:</span><br><span class="line">          <span class="keyword">case</span> R_GENERIC_IRELATIVE:</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(__aarch64__)</span></span><br><span class="line">          <span class="keyword">case</span> R_AARCH64_ABS64:</span><br><span class="line">          <span class="keyword">case</span> R_AARCH64_ABS32:</span><br><span class="line">          <span class="keyword">case</span> R_AARCH64_ABS16:</span><br><span class="line">...</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">...</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123; </span><br><span class="line">...</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="built_in">count_relocation</span>(kRelocSymbol);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (type) &#123;</span><br><span class="line">      <span class="keyword">case</span> R_GENERIC_JUMP_SLOT:</span><br><span class="line">        <span class="built_in">count_relocation</span>(kRelocAbsolute);</span><br><span class="line">        <span class="built_in">MARK</span>(rel-&gt;r_offset);</span><br><span class="line">        <span class="built_in">TRACE_TYPE</span>(RELO, <span class="string">&quot;RELO JMP_SLOT %16p &lt;- %16p %s\n&quot;</span>,</span><br><span class="line">                   <span class="built_in">reinterpret_cast</span>&lt;<span class="type">void</span>*&gt;(reloc),</span><br><span class="line">                   <span class="built_in">reinterpret_cast</span>&lt;<span class="type">void</span>*&gt;(sym_addr + addend), sym_name);</span><br><span class="line"></span><br><span class="line">        *<span class="built_in">reinterpret_cast</span>&lt;<span class="built_in">ElfW</span>(Addr)*&gt;(reloc) = (sym_addr + addend);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> R_GENERIC_GLOB_DAT:</span><br><span class="line">        <span class="built_in">count_relocation</span>(kRelocAbsolute);</span><br><span class="line">        <span class="built_in">MARK</span>(rel-&gt;r_offset);</span><br><span class="line">        <span class="built_in">TRACE_TYPE</span>(RELO, <span class="string">&quot;RELO GLOB_DAT %16p &lt;- %16p %s\n&quot;</span>,</span><br><span class="line">                   <span class="built_in">reinterpret_cast</span>&lt;<span class="type">void</span>*&gt;(reloc),</span><br><span class="line">                   <span class="built_in">reinterpret_cast</span>&lt;<span class="type">void</span>*&gt;(sym_addr + addend), sym_name);</span><br><span class="line">        *<span class="built_in">reinterpret_cast</span>&lt;<span class="built_in">ElfW</span>(Addr)*&gt;(reloc) = (sym_addr + addend);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> R_GENERIC_RELATIVE:</span><br><span class="line">        <span class="built_in">count_relocation</span>(kRelocRelative);</span><br><span class="line">        <span class="built_in">MARK</span>(rel-&gt;r_offset);</span><br><span class="line">        <span class="built_in">TRACE_TYPE</span>(RELO, <span class="string">&quot;RELO RELATIVE %16p &lt;- %16p\n&quot;</span>,</span><br><span class="line">                   <span class="built_in">reinterpret_cast</span>&lt;<span class="type">void</span>*&gt;(reloc),</span><br><span class="line">                   <span class="built_in">reinterpret_cast</span>&lt;<span class="type">void</span>*&gt;(load_bias + addend));</span><br><span class="line">        *<span class="built_in">reinterpret_cast</span>&lt;<span class="built_in">ElfW</span>(Addr)*&gt;(reloc) = (load_bias + addend);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(__aarch64__)</span></span><br><span class="line">      <span class="keyword">case</span> R_AARCH64_ABS64:</span><br><span class="line">        <span class="built_in">count_relocation</span>(kRelocAbsolute);</span><br><span class="line">        <span class="built_in">MARK</span>(rel-&gt;r_offset);</span><br><span class="line">        <span class="built_in">TRACE_TYPE</span>(RELO, <span class="string">&quot;RELO ABS64 %16llx &lt;- %16llx %s\n&quot;</span>,</span><br><span class="line">                   reloc, sym_addr + addend, sym_name);</span><br><span class="line">        *<span class="built_in">reinterpret_cast</span>&lt;<span class="built_in">ElfW</span>(Addr)*&gt;(reloc) = sym_addr + addend;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      ...</span><br><span class="line">      <span class="keyword">case</span> R_AARCH64_PREL64:</span><br><span class="line">        <span class="built_in">count_relocation</span>(kRelocRelative);</span><br><span class="line">        <span class="built_in">MARK</span>(rel-&gt;r_offset);</span><br><span class="line">        <span class="built_in">TRACE_TYPE</span>(RELO, <span class="string">&quot;RELO REL64 %16llx &lt;- %16llx - %16llx %s\n&quot;</span>,</span><br><span class="line">                   reloc, sym_addr + addend, rel-&gt;r_offset, sym_name);</span><br><span class="line">        *<span class="built_in">reinterpret_cast</span>&lt;<span class="built_in">ElfW</span>(Addr)*&gt;(reloc) = sym_addr + addend - rel-&gt;r_offset;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      ...</span><br><span class="line"></span><br><span class="line">      <span class="keyword">case</span> R_AARCH64_COPY:</span><br><span class="line">        <span class="built_in">DL_ERR</span>(<span class="string">&quot;%s R_AARCH64_COPY relocations are not supported&quot;</span>, <span class="built_in">get_realpath</span>());</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">      <span class="keyword">case</span> R_AARCH64_TLS_TPREL64:</span><br><span class="line">        <span class="built_in">TRACE_TYPE</span>(RELO, <span class="string">&quot;RELO TLS_TPREL64 *** %16llx &lt;- %16llx - %16llx\n&quot;</span>,</span><br><span class="line">                   reloc, (sym_addr + addend), rel-&gt;r_offset);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">...</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">        <span class="built_in">DL_ERR</span>(<span class="string">&quot;unknown reloc type %d @ %p (%zu)&quot;</span>, type, rel, idx);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a target="_blank" rel="noopener" href="https://bbs.kanxue.com/thread-269801.htm">Android Linker详解</a><br><a target="_blank" rel="noopener" href="https://bbs.kanxue.com/thread-269891.htm">Android Linker详解(二) </a><br><a target="_blank" rel="noopener" href="https://bbs.kanxue.com/thread-281184.htm">自定义Linker实现分析之路</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/a332324956/article/details/68947789">深入 Android 源码系列（一）</a></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://Matchstick135.github.io">Ms135</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://matchstick135.github.io/2025/01/31/2025-1-31%20so%E5%8A%A0%E8%BD%BD%E6%B5%81%E7%A8%8B/">https://matchstick135.github.io/2025/01/31/2025-1-31%20so%E5%8A%A0%E8%BD%BD%E6%B5%81%E7%A8%8B/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://Matchstick135.github.io" target="_blank">Ms135's Blog</a>！</span></div></div><div class="tag_share"><div class="post-share"><div class="social-share" data-image="/img/2025-1-31.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/2025/01/25/2025-1-25%20%E7%99%BE%E5%BA%A6%E5%8A%A0%E5%9B%BA%E5%85%8D%E8%B4%B9%E7%89%88%E5%88%86%E6%9E%90%EF%BC%88%E6%9C%AA%E5%AE%8C%EF%BC%89/" title="百度加固免费版分析"><img class="cover" src="/img/2025-1-25.jpg" onerror="onerror=null;src='/null'" alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">百度加固免费版分析</div></div><div class="info-2"><div class="info-item-1">  壳dex原dex已只剩一个R类，其他部分会在后续过程中被释放加载 查看AndroidManifest.xml中的 application标签，得知程序入口处为 StubApplication StubApplication.attachBaseContext来到其中被重写的 attachBaseContext() (1)Debug.isDebuggerConnected反调试，可通过提前在 libart.so的 isDebuggerConnected()中下断点 实现绕过 (2)loadLibrary开始加载 libbaiduprotect.so，因此接下来进入native，开始分析so加载过程 (5)A.n001loadLibrary() 加载完libbaiduprotect.so后，调用了先前 JNI_Onload()中注册的 n001()，对应native的 sub_9318 StubApplication.onCreate(7)A.n002其前面在 JNI_Onload 中被注册，可知道对应native的...</div></div></div></a><a class="pagination-related" href="/2025/02/17/2025-2-17%20%E5%8F%8D%E8%B0%83%E8%AF%95%E5%8F%8A%E5%AF%B9%E6%8A%97/" title="反调试及对抗"><img class="cover" src="/img/2025-2-17.jpg" onerror="onerror=null;src='/null'" alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">反调试及对抗</div></div><div class="info-2"><div class="info-item-1">本文记录了Android中常见的反调试手段，从原理及对抗两个方面进行总结文章会根据后续的学习进度，持续追加新内容 注：  Android下的调试器本质上是基于ptrace()的，这点与frida注入类似。因此反调试与frida检测有诸多相通之处对于本文没涉及到的内容，会在同系列的《Frida检测及对抗》中进行补充说明 默认环境如下————Android 9.0.0、arm64  手段（native）123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354#include &lt;cstring&gt;#include &lt;cstdlib&gt;#include &lt;string&gt;#include &lt;vector&gt;#include &lt;fstream&gt;#include &lt;sstream&gt;#include &lt;memory&gt;#include...</div></div></div></a></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/img/%E5%A4%B4%E5%83%8F.jpg" onerror="this.onerror=null;this.src='/null'" alt="avatar"/></div><div class="author-info-name">Ms135</div><div class="author-info-description"></div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">49</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">0</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">7</div></a></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Java-Framework"><span class="toc-number">1.</span> <span class="toc-text">Java Framework</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#System-loadLibrary"><span class="toc-number">1.1.</span> <span class="toc-text">System.loadLibrary</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Runtime-loadLibrary0"><span class="toc-number">1.1.1.</span> <span class="toc-text">Runtime.loadLibrary0</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#JNI"><span class="toc-number">2.</span> <span class="toc-text">JNI</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Runtime-nativeLoad"><span class="toc-number">2.1.</span> <span class="toc-text">Runtime_nativeLoad</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#JVM-nativeLoad"><span class="toc-number">2.1.1.</span> <span class="toc-text">JVM_nativeLoad</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#C-Framework-I"><span class="toc-number">3.</span> <span class="toc-text">C++ Framework I</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#JavaVMExt-LoadNativeLibrary"><span class="toc-number">3.1.</span> <span class="toc-text">JavaVMExt::LoadNativeLibrary</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#android-OpenNativeLibrary"><span class="toc-number">3.1.1.</span> <span class="toc-text">android::OpenNativeLibrary</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#android-dlopen-ext"><span class="toc-number">3.1.1.1.</span> <span class="toc-text">android_dlopen_ext</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#dlopen-ext"><span class="toc-number">3.1.1.1.1.</span> <span class="toc-text">dlopen_ext</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#JNI-OnLoad"><span class="toc-number">3.1.2.</span> <span class="toc-text">JNI_OnLoad</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#C-Framework-II"><span class="toc-number">4.</span> <span class="toc-text">C++ Framework II</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#do-dlopen"><span class="toc-number">4.1.</span> <span class="toc-text">do_dlopen</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#find-library"><span class="toc-number">4.1.1.</span> <span class="toc-text">find_library</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#find-libraries"><span class="toc-number">4.1.1.1.</span> <span class="toc-text">find_libraries</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#soinfo-call-constructors"><span class="toc-number">4.1.2.</span> <span class="toc-text">soinfo::call_constructors</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#C-Framework-III"><span class="toc-number">5.</span> <span class="toc-text">C++ Framework III</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#find-library-internal"><span class="toc-number">5.1.</span> <span class="toc-text">find_library_internal</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#load-library"><span class="toc-number">5.1.1.</span> <span class="toc-text">load_library</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#soinfo-alloc"><span class="toc-number">5.1.1.1.</span> <span class="toc-text">soinfo_alloc</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#LoadTask-read"><span class="toc-number">5.1.1.2.</span> <span class="toc-text">LoadTask.read</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#ElfReader-Read"><span class="toc-number">5.1.1.2.1.</span> <span class="toc-text">ElfReader::Read</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#for-each-dt-needed"><span class="toc-number">5.1.1.3.</span> <span class="toc-text">for_each_dt_needed</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#LoadTask-load"><span class="toc-number">5.2.</span> <span class="toc-text">LoadTask.load</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ElfReader-Load"><span class="toc-number">5.2.1.</span> <span class="toc-text">ElfReader::Load</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#soinfo-prelink-image"><span class="toc-number">5.3.</span> <span class="toc-text">soinfo::prelink_image</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#soinfo-link-image"><span class="toc-number">5.4.</span> <span class="toc-text">soinfo::link_image</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#soinfo-relocate"><span class="toc-number">5.4.1.</span> <span class="toc-text">soinfo::relocate</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8F%82%E8%80%83"><span class="toc-number">6.</span> <span class="toc-text">参考</span></a></li></ol></div></div><div class="card-widget card-post-series"><div class="item-headline"><i class="fa-solid fa-layer-group"></i><span>系列文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2025/03/17/2025-3-17%20dex%E6%89%A7%E8%A1%8C%E6%9C%BA%E5%88%B6/" title="dex执行机制"><img src="/img/2025-3-17.jpg" onerror="this.onerror=null;this.src='/null'" alt="dex执行机制"></a><div class="content"><a class="title" href="/2025/03/17/2025-3-17%20dex%E6%89%A7%E8%A1%8C%E6%9C%BA%E5%88%B6/" title="dex执行机制">dex执行机制</a><time datetime="2025-03-16T16:00:00.000Z" title="发表于 2025-03-17 00:00:00">2025-03-17</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/01/31/2025-1-31%20so%E5%8A%A0%E8%BD%BD%E6%B5%81%E7%A8%8B/" title="so加载流程"><img src="/img/2025-1-31.jpg" onerror="this.onerror=null;this.src='/null'" alt="so加载流程"></a><div class="content"><a class="title" href="/2025/01/31/2025-1-31%20so%E5%8A%A0%E8%BD%BD%E6%B5%81%E7%A8%8B/" title="so加载流程">so加载流程</a><time datetime="2025-01-30T16:00:00.000Z" title="发表于 2025-01-31 00:00:00">2025-01-31</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="text-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div></body></html>